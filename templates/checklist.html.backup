{% extends "base.html" %}

{% block title %}Checklist{% endblock %}

{% block content %}
<!-- Main Checklist View -->
<div id="checklist-view" class="dashboard-container">
    <div class="page-header">
        <div class="page-title">
            <h1>Dashboard</h1>
            <p>Bienvenue dans votre checklist d'audit de nuit</p>
        </div>
    </div>

    <!-- Getting Started Card with Timeline -->
    <div class="getting-started-card">
        <div class="getting-started-header">
            <div class="getting-started-title">
                <div class="icon">
                    <i data-feather="check-circle"></i>
                </div>
                <h2>Checklist du Quart</h2>
            </div>
            <div class="progress-percentage">
                <span id="progress-percent">0%</span> complété
            </div>
        </div>

        <div class="progress-bar-container">
            <div class="progress-bar-fill" id="progress-fill"></div>
        </div>

        <div id="timeline-view" class="timeline">
            <!-- Timeline steps loaded via JavaScript -->
        </div>
    </div>

    <div class="actions">
        <button id="complete-shift-btn" class="btn btn-complete" disabled>
            <i data-feather="check-circle"></i>
            Terminer le quart
        </button>
    </div>
</div>

<!-- Step-by-Step Guide View -->
<div id="guide-view" class="guide-container" style="display: none;">
    <!-- Left Sidebar - Category List -->
    <div class="guide-sidebar">
        <div class="guide-sidebar-title">Checklist Overview</div>
        <div id="guide-category-list" class="guide-task-list">
            <!-- Categories loaded via JS -->
        </div>
    </div>

    <!-- Main Content -->
    <div class="guide-main">
        <div class="guide-header">
            <button class="back-btn" onclick="closeGuide()">
                <i data-feather="arrow-left"></i>
                Retour à la checklist
            </button>
            <div class="guide-progress-info">
                <span id="guide-system-name"></span>
            </div>
        </div>

        <div class="guide-content">
            <div class="guide-task-title-section">
                <div class="guide-task-icon">
                    <i data-feather="edit-3"></i>
                </div>
                <div class="guide-task-title-info">
                    <h2 id="guide-task-title">Titre de la tâche</h2>
                    <span id="guide-status-badge" class="guide-task-status-badge not-completed">
                        Status: Non complété
                    </span>
                </div>
            </div>

            <div id="guide-description" class="guide-description-card">
                <h3>Description de la tâche</h3>
                <p id="guide-desc-text"></p>
            </div>

            <div id="guide-steps" class="guide-steps">
                <!-- Steps loaded via JS -->
            </div>

            <button class="guide-action-btn" id="guide-action-btn" onclick="openSystemLink()">
                <i data-feather="external-link"></i>
                <span id="guide-action-text">Ouvrir le système</span>
            </button>

            <div id="guide-tips" class="guide-tips" style="display: none;">
                <div class="guide-tips-icon">!</div>
                <p id="guide-tips-text"></p>
            </div>
        </div>

        <div class="guide-footer">
            <button class="complete-task-btn" id="complete-task-btn" onclick="toggleTaskFromGuide()">
                <i data-feather="check"></i>
                <span id="complete-btn-text">Marquer comme complété</span>
            </button>
        </div>
    </div>

    <!-- Right Sidebar - Resources -->
    <div class="guide-resources">
        <div class="resource-card">
            <div class="resource-card-header">
                <h3>Vidéo explicative</h3>
            </div>
            <div class="video-placeholder">
                <div class="video-play-btn">
                    <i data-feather="play"></i>
                </div>
                <span class="video-label">Tutoriel pas-à-pas</span>
            </div>
        </div>

        <div class="resource-card">
            <div class="resource-card-header">
                <h3>Ressources additionnelles</h3>
            </div>
            <div class="resource-links">
                <a href="#" class="resource-link">
                    <i data-feather="file-text"></i>
                    <span>Documentation Galaxy</span>
                    <i data-feather="chevron-right" class="arrow"></i>
                </a>
                <a href="#" class="resource-link">
                    <i data-feather="help-circle"></i>
                    <span>FAQ</span>
                    <i data-feather="chevron-right" class="arrow"></i>
                </a>
                <a href="#" class="resource-link">
                    <i data-feather="book-open"></i>
                    <span>Guide complet</span>
                    <i data-feather="chevron-right" class="arrow"></i>
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const CATEGORIES = {
    'pre_audit': { name: 'Pré-Audit', color: '#e91e63', icon: 'clipboard' },
    'part1': { name: 'Pre Audit Reports', color: '#4caf50', icon: 'file-text' },
    'part2': { name: 'Post Audit', color: '#ff9800', icon: 'check-square' },
    'end_shift': { name: 'Fin de quart', color: '#9c27b0', icon: 'log-out' }
};

let tasks = [];
let completions = new Set();
let currentTask = null;

async function loadData() {
    const [tasksRes, shiftRes] = await Promise.all([
        fetch('/api/tasks'),
        fetch('/api/shifts/current')
    ]);

    tasks = await tasksRes.json();
    const shiftData = await shiftRes.json();

    if (shiftData.completions) {
        shiftData.completions.forEach(c => completions.add(c.task_id));
    }

    renderTimeline();
    updateProgress();

    if (!shiftData.shift) {
        fetch('/api/shifts', { method: 'POST' });
    }

    feather.replace();
}

function renderTimeline() {
    const container = document.getElementById('timeline-view');
    container.innerHTML = '';

    let currentCategory = null;
    let stepNumber = 1;

    tasks.forEach((task, index) => {
        const isCompleted = completions.has(task.id);
        const hasSteps = task.steps && task.steps.length > 0;
        const isCurrent = !isCompleted && !tasks.slice(0, index).some(t => !completions.has(t.id) && t.category === task.category);

        // Add category header if changed
        if (task.category !== currentCategory) {
            currentCategory = task.category;
            const categoryInfo = CATEGORIES[currentCategory] || { name: currentCategory, color: '#9e9e9e' };

            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'category-header';
            categoryHeader.innerHTML = `
                <div class="category-icon" style="background: ${categoryInfo.color}">
                    <i data-feather="${categoryInfo.icon || 'folder'}"></i>
                </div>
                <span class="category-name">${categoryInfo.name}</span>
                <span class="category-count" id="cat-${currentCategory}-count"></span>
            `;
            container.appendChild(categoryHeader);
        }

        const stepClass = isCompleted ? 'completed' : (isCurrent ? 'current' : '');
        const categoryInfo = CATEGORIES[task.category] || { color: '#9e9e9e' };

        const step = document.createElement('div');
        step.className = `timeline-step ${stepClass}`;
        step.innerHTML = `
            <div class="step-indicator">
                ${isCompleted ? '<i data-feather="check"></i>' : ''}
            </div>
            <div class="step-content">
                <div class="step-label">Étape ${stepNumber}</div>
                <div class="step-title">${task.title_fr}</div>
                <div class="step-description">
                    ${task.system_used ? task.system_used : ''}
                    ${task.estimated_minutes ? ` • ~${task.estimated_minutes} min` : ''}
                </div>
            </div>
            <div class="step-action">
                <input type="checkbox"
                       class="task-quick-check"
                       ${isCompleted ? 'checked' : ''}
                       onclick="event.stopPropagation(); toggleTask(${task.id}, this.checked)"
                       title="Marquer comme ${isCompleted ? 'non complété' : 'complété'}">
                ${hasSteps ? `
                    <button class="btn-guide"
                            onclick="event.stopPropagation(); openGuide(${task.id})">
                        <i data-feather="book-open"></i>
                        <span>Guide</span>
                    </button>
                ` : ''}
            </div>
        `;

        container.appendChild(step);
        stepNumber++;
    });

    updateCategoryCounts();
    feather.replace();
}

function updateCategoryCounts() {
    const categoryCounts = {};
    tasks.forEach(task => {
        if (!categoryCounts[task.category]) {
            categoryCounts[task.category] = { total: 0, done: 0 };
        }
        categoryCounts[task.category].total++;
        if (completions.has(task.id)) {
            categoryCounts[task.category].done++;
        }
    });

    Object.keys(categoryCounts).forEach(cat => {
        const el = document.getElementById(`cat-${cat}-count`);
        if (el) {
            el.textContent = `${categoryCounts[cat].done}/${categoryCounts[cat].total}`;
        }
    });
}

async function toggleTask(taskId, completed) {
    const endpoint = completed ? 'complete' : 'uncomplete';
    await fetch(`/api/tasks/${taskId}/${endpoint}`, { method: 'POST' });

    if (completed) {
        completions.add(taskId);
    } else {
        completions.delete(taskId);
    }

    renderTimeline();
    updateProgress();
}

function updateProgress() {
    const total = tasks.length;
    const done = completions.size;
    const percent = total > 0 ? Math.round((done / total) * 100) : 0;

    document.getElementById('progress-percent').textContent = `${percent}%`;
    document.getElementById('progress-fill').style.width = `${percent}%`;

    const completeBtn = document.getElementById('complete-shift-btn');
    completeBtn.disabled = done < total;

    if (done === total && total > 0) {
        completeBtn.classList.add('ready');
    } else {
        completeBtn.classList.remove('ready');
    }
}

// ========== GUIDE VIEW ==========

function openGuide(taskId) {
    currentTask = tasks.find(t => t.id === taskId);
    if (!currentTask) return;

    // Update title and status
    document.getElementById('guide-task-title').textContent = currentTask.title_fr;

    const isCompleted = completions.has(currentTask.id);
    const statusBadge = document.getElementById('guide-status-badge');
    statusBadge.className = `guide-task-status-badge ${isCompleted ? 'completed' : 'not-completed'}`;
    statusBadge.textContent = `Status: ${isCompleted ? 'Complété' : 'Non complété'}`;

    // Update description
    const descSection = document.getElementById('guide-description');
    const descText = document.getElementById('guide-desc-text');
    if (currentTask.description_fr) {
        descText.textContent = currentTask.description_fr;
        descSection.style.display = 'block';
    } else {
        descSection.style.display = 'none';
    }

    // Update steps
    const stepsContainer = document.getElementById('guide-steps');
    stepsContainer.innerHTML = '';

    if (currentTask.steps && currentTask.steps.length > 0) {
        currentTask.steps.forEach((stepText, index) => {
            const step = document.createElement('div');
            step.className = 'guide-step';
            step.innerHTML = `
                <div class="guide-step-number">${index + 1}</div>
                <div class="guide-step-text">${stepText}</div>
            `;
            stepsContainer.appendChild(step);
        });
    }

    // Update system name in header
    const systemName = document.getElementById('guide-system-name');
    if (currentTask.system_used) {
        systemName.textContent = currentTask.system_used;
    } else {
        systemName.textContent = '';
    }

    // Update action button
    const actionBtn = document.getElementById('guide-action-btn');
    const actionText = document.getElementById('guide-action-text');
    if (currentTask.system_used) {
        actionText.textContent = `Ouvrir ${currentTask.system_used}`;
        actionBtn.style.display = 'flex';
    } else {
        actionBtn.style.display = 'none';
    }

    // Update tips
    const tipsSection = document.getElementById('guide-tips');
    const tipsText = document.getElementById('guide-tips-text');
    if (currentTask.tips_fr) {
        tipsText.textContent = currentTask.tips_fr;
        tipsSection.style.display = 'flex';
    } else {
        tipsSection.style.display = 'none';
    }

    // Update complete button
    updateCompleteButton();

    // Render category sidebar
    renderGuideSidebar();

    // Switch views
    document.getElementById('checklist-view').style.display = 'none';
    document.getElementById('guide-view').style.display = 'grid';
    window.scrollTo(0, 0);

    feather.replace();
}

function renderGuideSidebar() {
    const container = document.getElementById('guide-category-list');
    container.innerHTML = '';

    const categoryCounts = {};
    tasks.forEach(task => {
        if (!categoryCounts[task.category]) {
            categoryCounts[task.category] = { total: 0, done: 0, tasks: [] };
        }
        categoryCounts[task.category].total++;
        categoryCounts[task.category].tasks.push(task);
        if (completions.has(task.id)) {
            categoryCounts[task.category].done++;
        }
    });

    Object.keys(CATEGORIES).forEach(catKey => {
        if (!categoryCounts[catKey]) return;

        const cat = categoryCounts[catKey];
        const info = CATEGORIES[catKey];
        const isComplete = cat.done === cat.total;
        const isActive = currentTask && currentTask.category === catKey;

        const item = document.createElement('div');
        item.className = `guide-task-item ${isComplete ? 'completed' : ''} ${isActive ? 'active' : ''}`;
        item.innerHTML = `
            <div class="guide-task-status ${isComplete ? 'completed' : 'pending'}">
                ${isComplete ? '<i data-feather="check"></i>' : '<span class="status-count">' + cat.done + '</span>'}
            </div>
            <div class="guide-task-info">
                <div class="guide-task-name">${info.name}</div>
                <div class="guide-task-progress">${cat.done} / ${cat.total} Complété</div>
            </div>
        `;
        container.appendChild(item);
    });

    feather.replace();
}

function updateCompleteButton() {
    const btn = document.getElementById('complete-task-btn');
    const btnText = document.getElementById('complete-btn-text');
    const isCompleted = completions.has(currentTask.id);

    if (isCompleted) {
        btn.classList.add('completed');
        btnText.textContent = 'Marquer comme non complété';
    } else {
        btn.classList.remove('completed');
        btnText.textContent = 'Marquer comme complété';
    }
}

function closeGuide() {
    document.getElementById('guide-view').style.display = 'none';
    document.getElementById('checklist-view').style.display = 'block';
    currentTask = null;
}

async function toggleTaskFromGuide() {
    if (!currentTask) return;
    const isCompleted = completions.has(currentTask.id);
    await toggleTask(currentTask.id, !isCompleted);

    // Update guide view
    const statusBadge = document.getElementById('guide-status-badge');
    const newStatus = completions.has(currentTask.id);
    statusBadge.className = `guide-task-status-badge ${newStatus ? 'completed' : 'not-completed'}`;
    statusBadge.textContent = `Status: ${newStatus ? 'Complété' : 'Non complété'}`;

    updateCompleteButton();
    renderGuideSidebar();
}

function openSystemLink() {
    // Placeholder - will open actual system links when configured
    alert('Cette fonctionnalité ouvrira le système ' + (currentTask?.system_used || 'approprié'));
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('guide-view').style.display === 'grid') {
        closeGuide();
    }
});

document.getElementById('complete-shift-btn').addEventListener('click', async () => {
    if (confirm('Êtes-vous sûr de vouloir terminer le quart?')) {
        await fetch('/api/shifts/complete', { method: 'POST' });
        alert('Quart terminé avec succès!');
    }
});

loadData();
</script>
{% endblock %}
