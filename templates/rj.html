{% extends "base.html" %}
{% block title %}Gestion RJ{% endblock %}

{% block content %}
<div class="rj-page">
  <div class="rj-hero">
    <div>
      <h1>Gestion Revenue Journal</h1>
      <p>Upload RJ, DueBack (pr√©c√©dent/courant), Recap, Transelect, GEAC/UX, sync SetD.</p>
      <div class="rj-stats">
        <div class="rj-stat-card">
          <div class="rj-stat-label">Fichier</div>
          <div class="rj-stat-value" id="stat-file">Non charg√©</div>
        </div>
        <div class="rj-stat-card">
          <div class="rj-stat-label">Taille</div>
          <div class="rj-stat-value" id="stat-size">-</div>
        </div>
        <div class="rj-stat-card">
          <div class="rj-stat-label">Derni√®re action</div>
          <div class="rj-stat-value" id="stat-action">-</div>
        </div>
      </div>
    </div>
    <div class="rj-card">
      <h3>Fichier RJ</h3>
      <div class="upload-zone" onclick="document.getElementById('rj-file-input').click()">
        <div class="upload-title">üìÅ Choisir RJ (.xls/.xlsx)</div>
        <div class="upload-subtitle" id="rj-file-label">Aucun fichier s√©lectionn√©</div>
        <input type="file" id="rj-file-input" accept=".xls,.xlsx" style="display:none" onchange="uploadRJFile()">
      </div>
      <div class="form-actions">
        <button class="rj-btn secondary" onclick="resetRJ()">
          <i data-feather="refresh-cw"></i> Reset onglets
        </button>
        <button class="rj-btn secondary" onclick="downloadRJ()">
          <i data-feather="download"></i> T√©l√©charger
        </button>
        <button class="rj-btn secondary" onclick="checkRJStatus()">
          <i data-feather="refresh-cw"></i> Rafra√Æchir
        </button>
      </div>
      <div class="status-chip" id="rj-message" style="display:none; margin-top:1rem;"></div>
    </div>
  </div>

  <!-- TABBED INTERFACE -->
  <div class="rj-tabs-container">
    <!-- Tab Navigation -->
    <div class="rj-tabs-nav">
      <!-- Nouveau Jour en premier, puis workflow: SD ‚Üí Depot ‚Üí DueBack ‚Üí Recap ‚Üí Transelect ‚Üí GEAC -->
      <button class="rj-tab-btn" onclick="switchRJTab('nouveau-jour')" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
        <i data-feather="calendar"></i> Nouveau Jour
      </button>
      <button class="rj-tab-btn active" onclick="switchRJTab('sd')">
        <i data-feather="file-text"></i> SD
      </button>
      <button class="rj-tab-btn" onclick="switchRJTab('depot')">
        <i data-feather="archive"></i> D√©p√¥t
      </button>
      <button class="rj-tab-btn" onclick="switchRJTab('dueback')">
        <i data-feather="users"></i> DueBack
      </button>
      <button class="rj-tab-btn" onclick="switchRJTab('recap')">
        <i data-feather="dollar-sign"></i> Recap
      </button>
      <button class="rj-tab-btn" onclick="switchRJTab('transelect')">
        <i data-feather="credit-card"></i> Transelect
      </button>
      <button class="rj-tab-btn" onclick="switchRJTab('geac')">
        <i data-feather="layers"></i> GEAC/UX
      </button>
    </div>

    <!-- Tab Contents -->
    <div class="rj-tabs-content">

      <!-- NOUVEAU JOUR TAB -->
      <div id="tab-nouveau-jour" class="rj-tab-content" style="display:none;">
        <div class="rj-card">
          <h3 style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 0.5rem; border-radius: 8px;">
              <i data-feather="calendar" style="color: white; width: 24px; height: 24px;"></i>
            </div>
            Configuration Nouveau Jour
          </h3>

          <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 2rem; line-height: 1.6;">
            <strong>Workflow de d√©marrage:</strong> Quand vous commencez un nouveau jour d'audit, vous devez:<br>
            1. Charger votre fichier RJ<br>
            2. Mettre √† jour la date dans <em>controle</em><br>
            3. Effacer les onglets de donn√©es (Recap, Transelect, GEAC, D√©p√¥t)
          </p>

          <!-- Section 1: Controle -->
          <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #3b82f6;">
            <h4 style="margin: 0 0 1rem 0; color: #1e40af; display: flex; align-items: center; gap: 0.5rem;">
              <i data-feather="settings" style="width: 20px; height: 20px;"></i>
              √âtape 1: Configurer la date (controle)
            </h4>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
              <!-- Jour -->
              <div>
                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #1e40af; margin-bottom: 0.5rem;">
                  Jour (vjour)
                </label>
                <select id="controle-vjour" style="width: 100%; padding: 0.75rem; border: 2px solid #93c5fd; border-radius: 8px; font-size: 1rem; background: white;">
                  {% for d in range(1, 32) %}
                  <option value="{{ d }}">{{ d }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Mois -->
              <div>
                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #1e40af; margin-bottom: 0.5rem;">
                  Mois
                </label>
                <select id="controle-mois" style="width: 100%; padding: 0.75rem; border: 2px solid #93c5fd; border-radius: 8px; font-size: 1rem; background: white;">
                  <option value="1">Janvier (01)</option>
                  <option value="2">F√©vrier (02)</option>
                  <option value="3">Mars (03)</option>
                  <option value="4">Avril (04)</option>
                  <option value="5">Mai (05)</option>
                  <option value="6">Juin (06)</option>
                  <option value="7">Juillet (07)</option>
                  <option value="8">Ao√ªt (08)</option>
                  <option value="9">Septembre (09)</option>
                  <option value="10">Octobre (10)</option>
                  <option value="11">Novembre (11)</option>
                  <option value="12">D√©cembre (12)</option>
                </select>
              </div>

              <!-- Ann√©e -->
              <div>
                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #1e40af; margin-bottom: 0.5rem;">
                  Ann√©e
                </label>
                <select id="controle-annee" style="width: 100%; padding: 0.75rem; border: 2px solid #93c5fd; border-radius: 8px; font-size: 1rem; background: white;">
                  <option value="2025">2025</option>
                  <option value="2026" selected>2026</option>
                  <option value="2027">2027</option>
                </select>
              </div>
            </div>

            <button onclick="updateControle()" class="rj-btn" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 0.75rem 1.5rem; font-weight: 600; width: 100%;">
              <i data-feather="save"></i> Appliquer la date dans controle
            </button>
          </div>

          <!-- Section 2: Effacement des onglets -->
          <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #f59e0b;">
            <h4 style="margin: 0 0 1rem 0; color: #92400e; display: flex; align-items: center; gap: 0.5rem;">
              <i data-feather="trash-2" style="width: 20px; height: 20px;"></i>
              √âtape 2: Effacer les donn√©es du jour pr√©c√©dent
            </h4>

            <p style="font-size: 0.85rem; color: #92400e; margin-bottom: 1rem;">
              Cliquez sur chaque bouton pour effacer les donn√©es de l'onglet correspondant, ou utilisez "Effacer TOUS" pour tout nettoyer d'un coup.
            </p>

            <!-- Individual reset buttons -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
              <button onclick="resetSheet('recap')" class="rj-btn" style="background: #dc2626; color: white; padding: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <i data-feather="dollar-sign" style="width: 18px; height: 18px;"></i>
                Effacer Recap
              </button>
              <button onclick="resetSheet('transelect')" class="rj-btn" style="background: #dc2626; color: white; padding: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <i data-feather="credit-card" style="width: 18px; height: 18px;"></i>
                Effacer Transelect
              </button>
              <button onclick="resetSheet('geac')" class="rj-btn" style="background: #dc2626; color: white; padding: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <i data-feather="layers" style="width: 18px; height: 18px;"></i>
                Effacer GEAC
              </button>
              <button onclick="resetSheet('depot')" class="rj-btn" style="background: #dc2626; color: white; padding: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <i data-feather="archive" style="width: 18px; height: 18px;"></i>
                Effacer D√©p√¥t
              </button>
            </div>

            <!-- Reset ALL button -->
            <button onclick="resetAllSheets()" class="rj-btn" style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 1rem; font-weight: 700; width: 100%; font-size: 1.1rem;">
              <i data-feather="zap"></i> EFFACER TOUS LES ONGLETS
            </button>
          </div>

          <!-- Section 3: Macro Actions (after completing daily entries) -->
          <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #10b981;">
            <h4 style="margin: 0 0 1rem 0; color: #065f46; display: flex; align-items: center; gap: 0.5rem;">
              <i data-feather="send" style="width: 20px; height: 20px;"></i>
              √âtape 3: Actions de fin de journ√©e (Macros)
            </h4>

            <p style="font-size: 0.85rem; color: #065f46; margin-bottom: 1rem;">
              Ces actions copient les donn√©es calcul√©es vers le journal (jour). Ex√©cutez-les apr√®s avoir rempli Recap et Transelect.
            </p>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
              <!-- Envoie dans jour (Recap ‚Üí jour) -->
              <button onclick="macroEnvoieDansJour()" class="rj-btn" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <i data-feather="arrow-right-circle" style="width: 18px; height: 18px;"></i>
                Envoie Recap ‚Üí Jour
              </button>

              <!-- Calcul Carte (transelect ‚Üí jour) -->
              <button onclick="macroCalculCarte()" class="rj-btn" style="background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; padding: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <i data-feather="credit-card" style="width: 18px; height: 18px;"></i>
                Calcul Cartes ‚Üí Jour
              </button>

              <!-- Effacer Daily -->
              <button onclick="resetSheet('daily')" class="rj-btn" style="background: #dc2626; color: white; padding: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <i data-feather="calendar" style="width: 18px; height: 18px;"></i>
                Effacer Daily
              </button>

              <!-- Execute Both Macros -->
              <button onclick="macroExecuteAll()" class="rj-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <i data-feather="play-circle" style="width: 18px; height: 18px;"></i>
                Ex√©cuter Toutes
              </button>
            </div>

            <p style="font-size: 0.8rem; color: #047857; margin: 0;">
              <i data-feather="info" style="width: 14px; height: 14px; vertical-align: middle;"></i>
              <strong>Envoie Recap:</strong> Copie H19:N19 ‚Üí jour (ar_[jour]) | <strong>Calcul Cartes:</strong> Copie totaux transelect ‚Üí jour (CC_[jour])
            </p>
          </div>

          <!-- Section 4: Status -->
          <div id="nouveau-jour-status" style="display: none; padding: 1rem; border-radius: 8px; margin-top: 1rem;"></div>

          <!-- Section 4: Excel Preview -->
          <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #6366f1;">
            <h4 style="margin: 0 0 1rem 0; color: #4338ca; display: flex; align-items: center; gap: 0.5rem;">
              <i data-feather="eye" style="width: 20px; height: 20px;"></i>
              Aper√ßu Excel en Temps R√©el
              <button onclick="refreshControlePreview()" class="rj-btn" style="margin-left: auto; padding: 0.4rem 0.75rem; font-size: 0.8rem; background: #4f46e5; color: white;">
                <i data-feather="refresh-cw" style="width: 14px; height: 14px;"></i> Actualiser
              </button>
            </h4>

            <!-- Sheet selector -->
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #4338ca; margin-bottom: 0.5rem;">
                Feuille √† visualiser:
              </label>
              <select id="preview-sheet-selector" onchange="loadSheetPreview()" style="width: 100%; padding: 0.5rem; border: 2px solid #a5b4fc; border-radius: 8px; font-size: 0.9rem; background: white;">
                <option value="controle">controle (Configuration)</option>
                <option value="Recap">Recap (Caisse)</option>
                <option value="transelect">transelect (Cartes)</option>
                <option value="geac_ux">geac_ux (GEAC)</option>
                <option value="depot">depot (D√©p√¥t)</option>
                <option value="DUBACK#">DUBACK# (DueBack)</option>
                <option value="rj">rj (Rapport)</option>
                <option value="jour">jour (Journal)</option>
              </select>
            </div>

            <!-- Preview table container -->
            <div id="excel-preview-container" style="background: white; border-radius: 8px; overflow: hidden; max-height: 400px; overflow-y: auto; border: 1px solid #c7d2fe;">
              <div id="excel-preview-loading" style="padding: 2rem; text-align: center; color: #6b7280;">
                <i data-feather="upload" style="width: 32px; height: 32px; margin-bottom: 0.5rem;"></i>
                <p style="margin: 0;">Chargez un fichier RJ pour voir l'aper√ßu</p>
              </div>
              <table id="excel-preview-table" style="width: 100%; border-collapse: collapse; font-size: 0.75rem; display: none;">
                <thead id="excel-preview-header"></thead>
                <tbody id="excel-preview-body"></tbody>
              </table>
            </div>

            <!-- Quick info display -->
            <div id="excel-preview-info" style="margin-top: 0.75rem; padding: 0.75rem; background: #f5f3ff; border-radius: 6px; font-size: 0.8rem; color: #5b21b6; display: none;">
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                <div><strong>Jour (vjour):</strong> <span id="preview-vjour">-</span></div>
                <div><strong>Mois:</strong> <span id="preview-mois">-</span></div>
                <div><strong>Ann√©e:</strong> <span id="preview-annee">-</span></div>
                <div><strong>Date (idate):</strong> <span id="preview-idate">-</span></div>
              </div>
            </div>
          </div>

          <!-- Workflow Summary -->
          <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; border: 1px solid #86efac;">
            <h5 style="margin: 0 0 0.5rem 0; color: #166534; font-size: 0.9rem;">
              <i data-feather="check-circle" style="width: 16px; height: 16px; vertical-align: middle;"></i>
              Une fois termin√©, vous pouvez commencer le workflow:
            </h5>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; font-size: 0.85rem; color: #15803d;">
              <span style="background: #dcfce7; padding: 0.25rem 0.75rem; border-radius: 999px;">1. SD</span>
              <span>‚Üí</span>
              <span style="background: #dcfce7; padding: 0.25rem 0.75rem; border-radius: 999px;">2. D√©p√¥t</span>
              <span>‚Üí</span>
              <span style="background: #dcfce7; padding: 0.25rem 0.75rem; border-radius: 999px;">3. DueBack</span>
              <span>‚Üí</span>
              <span style="background: #dcfce7; padding: 0.25rem 0.75rem; border-radius: 999px;">4. Recap</span>
              <span>‚Üí</span>
              <span style="background: #dcfce7; padding: 0.25rem 0.75rem; border-radius: 999px;">5. Transelect</span>
              <span>‚Üí</span>
              <span style="background: #dcfce7; padding: 0.25rem 0.75rem; border-radius: 999px;">6. GEAC</span>
            </div>
          </div>
        </div>
      </div>

      <!-- DUEBACK TAB -->
      <div id="tab-dueback" class="rj-tab-content">
        <div class="rj-card">
          <h3>DUBACK# - Jour <span id="dueback-current-day">__</span></h3>
          <p style="font-size:0.875rem; color:var(--text-secondary); margin-bottom:1.5rem;">
            Entrez les montants Previous DueBack et Current DueBack depuis les rapports de caisse des r√©ceptionnistes.
          </p>

          <!-- Add Entry Form -->
          <div style="background: white; padding: 2rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); border: 1px solid #e5e7eb;">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
              <div style="background: #3b82f6; padding: 0.5rem; border-radius: 8px;">
                <i data-feather="user-plus" style="color: white; width: 20px; height: 20px;"></i>
              </div>
              <h4 style="margin: 0; font-size: 1.125rem; color: #1f2937; font-weight: 600; letter-spacing: 0.3px;">Nouvelle entr√©e DueBack</h4>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end;">
              <!-- Receptionist Dropdown -->
              <div style="position: relative;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.813rem; color: #374151; text-transform: uppercase; letter-spacing: 0.5px;">
                  <i data-feather="user" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i>
                  R√©ceptionniste
                </label>
                <div style="position: relative;">
                  <select id="dueback-receptionist-select"
                          style="width: 100%;
                                 padding: 0.875rem 2.5rem 0.875rem 1rem;
                                 border: 2px solid #d1d5db;
                                 border-radius: 10px;
                                 font-size: 0.9375rem;
                                 background: white;
                                 color: #1f2937;
                                 font-weight: 500;
                                 cursor: pointer;
                                 transition: all 0.2s ease;
                                 appearance: none;
                                 -webkit-appearance: none;
                                 -moz-appearance: none;"
                          onfocus="this.style.border='2px solid #3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
                          onblur="this.style.border='2px solid #d1d5db'; this.style.boxShadow='none';">
                    <option value="">S√©lectionner un r√©ceptionniste...</option>
                  </select>
                  <div style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); pointer-events: none;">
                    <i data-feather="chevron-down" style="width: 20px; height: 20px; color: #6b7280;"></i>
                  </div>
                </div>
              </div>

              <!-- Previous DueBack -->
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.813rem; color: #374151; text-transform: uppercase; letter-spacing: 0.5px;">
                  <i data-feather="arrow-down-circle" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i>
                  Previous
                </label>
                <input type="number" step="0.01" id="dueback-previous-input" placeholder="0.00"
                       style="width: 100%;
                              padding: 0.875rem 1rem;
                              border: 2px solid #d1d5db;
                              border-radius: 10px;
                              text-align: right;
                              font-size: 1rem;
                              font-weight: 600;
                              background: white;
                              color: #dc2626;
                              transition: all 0.2s ease;"
                       onfocus="this.style.border='2px solid #dc2626'; this.style.boxShadow='0 0 0 3px rgba(220, 38, 38, 0.1)';"
                       onblur="this.style.border='2px solid #d1d5db'; this.style.boxShadow='none';">
              </div>

              <!-- Current DueBack -->
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.813rem; color: #374151; text-transform: uppercase; letter-spacing: 0.5px;">
                  <i data-feather="arrow-up-circle" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i>
                  Current
                </label>
                <input type="number" step="0.01" id="dueback-current-input" placeholder="0.00"
                       style="width: 100%;
                              padding: 0.875rem 1rem;
                              border: 2px solid #d1d5db;
                              border-radius: 10px;
                              text-align: right;
                              font-size: 1rem;
                              font-weight: 600;
                              background: white;
                              color: #059669;
                              transition: all 0.2s ease;"
                       onfocus="this.style.border='2px solid #10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)';"
                       onblur="this.style.border='2px solid #d1d5db'; this.style.boxShadow='none';">
              </div>

              <!-- Add Button -->
              <button onclick="addDuebackEntry()"
                      style="background: #3b82f6;
                             color: white;
                             border: none;
                             padding: 0.875rem 2rem;
                             border-radius: 10px;
                             font-weight: 600;
                             font-size: 0.9375rem;
                             cursor: pointer;
                             transition: all 0.2s ease;
                             display: flex;
                             align-items: center;
                             gap: 0.5rem;
                             margin-top: 1.563rem;
                             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);"
                      onmouseover="this.style.background='#2563eb'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.15)';"
                      onmouseout="this.style.background='#3b82f6'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.1)';">
                <i data-feather="plus-circle" style="width: 18px; height: 18px;"></i>
                <span>Ajouter</span>
              </button>
            </div>
          </div>

          <!-- Entries List -->
          <div id="dueback-entries-container" style="display: none; margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div style="background: #3b82f6; padding: 0.5rem; border-radius: 8px;">
                  <i data-feather="list" style="color: white; width: 18px; height: 18px;"></i>
                </div>
                <h4 style="margin: 0; font-size: 1.125rem; color: #1f2937; font-weight: 600;">
                  Entr√©es ajout√©es
                  <span style="background: #3b82f6; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.813rem; margin-left: 0.5rem;" id="dueback-entries-count">0</span>
                </h4>
              </div>
            </div>
            <div id="dueback-entries-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
              <!-- Entries will be added here by JavaScript -->
            </div>
          </div>

          <!-- Totals Display -->
          <div id="dueback-totals-display" style="display: none; margin-bottom: 2rem;">
            <!-- Column B Total (Read-Only from 'jour' sheet) -->
            <div style="background: white; border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); border: 1px solid #e5e7eb;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <div style="background: #8b5cf6; padding: 0.5rem; border-radius: 8px;">
                    <i data-feather="hash" style="color: white; width: 18px; height: 18px;"></i>
                  </div>
                  <div>
                    <div style="font-size: 0.9375rem; font-weight: 700; color: #1f2937; text-transform: uppercase; letter-spacing: 0.5px;">
                      Total R/J (Colonne B)
                    </div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.125rem;">
                      <i data-feather="lock" style="width: 12px; height: 12px; display: inline; vertical-align: middle;"></i>
                      R√©f√©rence: feuille 'jour' (lecture seule)
                    </div>
                  </div>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                <div style="background: #fef2f2; border-radius: 10px; padding: 1rem; border: 2px solid #fecaca; text-align: center;">
                  <div style="font-size: 0.688rem; color: #dc2626; font-weight: 600; margin-bottom: 0.25rem;">PREVIOUS</div>
                  <div id="dueback-total-b-previous" style="font-size: 1.25rem; font-weight: 700; color: #991b1b; font-family: 'Courier New', monospace;">$0.00</div>
                </div>
                <div style="background: #f0fdf4; border-radius: 10px; padding: 1rem; border: 2px solid #bbf7d0; text-align: center;">
                  <div style="font-size: 0.688rem; color: #059669; font-weight: 600; margin-bottom: 0.25rem;">CURRENT</div>
                  <div id="dueback-total-b-current" style="font-size: 1.25rem; font-weight: 700; color: #065f46; font-family: 'Courier New', monospace;">$0.00</div>
                </div>
                <div id="dueback-total-b-net-box" style="background: #eff6ff; border-radius: 10px; padding: 1rem; border: 2px solid #3b82f6; text-align: center;">
                  <div style="font-size: 0.688rem; color: #1d4ed8; font-weight: 600; margin-bottom: 0.25rem;">NET</div>
                  <div id="dueback-total-b-net" style="font-size: 1.5rem; font-weight: 800; color: #1e3a8a; font-family: 'Courier New', monospace;">$0.00</div>
                </div>
              </div>
            </div>

            <!-- Column Z Total (Calculated from entries) -->
            <div style="background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); border: 1px solid #e5e7eb;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <div style="background: #3b82f6; padding: 0.5rem; border-radius: 8px;">
                  <i data-feather="trending-up" style="color: white; width: 18px; height: 18px;"></i>
                </div>
                <div>
                  <div style="font-size: 0.9375rem; font-weight: 700; color: #1f2937; text-transform: uppercase; letter-spacing: 0.5px;">
                    Total R√©ceptionnistes (Colonne Z)
                  </div>
                  <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.125rem;">
                    <i data-feather="calculator" style="width: 12px; height: 12px; display: inline; vertical-align: middle;"></i>
                    Calcul√© automatiquement des entr√©es
                  </div>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                <div style="background: #fef2f2; border-radius: 10px; padding: 1rem; border: 2px solid #fecaca; text-align: center;">
                  <div style="font-size: 0.688rem; color: #dc2626; font-weight: 600; margin-bottom: 0.25rem;">PREVIOUS</div>
                  <div id="dueback-total-previous" style="font-size: 1.25rem; font-weight: 700; color: #991b1b; font-family: 'Courier New', monospace;">$0.00</div>
                </div>
                <div style="background: #f0fdf4; border-radius: 10px; padding: 1rem; border: 2px solid #bbf7d0; text-align: center;">
                  <div style="font-size: 0.688rem; color: #059669; font-weight: 600; margin-bottom: 0.25rem;">CURRENT</div>
                  <div id="dueback-total-current" style="font-size: 1.25rem; font-weight: 700; color: #065f46; font-family: 'Courier New', monospace;">$0.00</div>
                </div>
                <div id="dueback-total-z-net-box" style="background: #eff6ff; border-radius: 10px; padding: 1rem; border: 2px solid #3b82f6; text-align: center;">
                  <div style="font-size: 0.688rem; color: #1d4ed8; font-weight: 600; margin-bottom: 0.25rem;">NET</div>
                  <div id="dueback-total-net" style="font-size: 1.5rem; font-weight: 800; color: #1e3a8a; font-family: 'Courier New', monospace;">$0.00</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Save Button -->
          <div class="form-actions">
            <button onclick="saveDuebackData()"
                    style="background: #10b981;
                           color: white;
                           border: none;
                           padding: 1rem 2.5rem;
                           border-radius: 12px;
                           font-weight: 700;
                           font-size: 1.125rem;
                           cursor: pointer;
                           transition: all 0.2s ease;
                           box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                           display: inline-flex;
                           align-items: center;
                           gap: 0.75rem;
                           text-transform: uppercase;
                           letter-spacing: 0.5px;"
                    onmouseover="this.style.background='#059669'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.15)';"
                    onmouseout="this.style.background='#10b981'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.1)';">
              <i data-feather="save" style="width: 22px; height: 22px;"></i>
              <span>Enregistrer dans RJ</span>
            </button>
          </div>

          <div id="dueback-message" style="margin-top:1.5rem; display:none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>

          <!-- Live Excel Preview -->
          <div id="dueback-preview-container" style="margin-top: 2rem; display: none;">
            <div style="background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); border: 1px solid #e5e7eb;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                <div style="background: #10b981; padding: 0.5rem; border-radius: 8px;">
                  <i data-feather="file-text" style="color: white; width: 18px; height: 18px;"></i>
                </div>
                <div>
                  <div style="font-size: 0.9375rem; font-weight: 700; color: #1f2937; text-transform: uppercase; letter-spacing: 0.5px;">
                    Aper√ßu Excel DUBACK#
                  </div>
                  <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.125rem;">
                    <i data-feather="eye" style="width: 12px; height: 12px; display: inline; vertical-align: middle;"></i>
                    Mise √† jour en temps r√©el
                  </div>
                </div>
              </div>

              <!-- Excel Table Preview -->
              <div id="dueback-excel-preview" style="overflow-x: auto; border: 2px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                <!-- Table will be generated by JavaScript -->
              </div>

              <!-- Legend -->
              <div style="margin-top: 1rem; padding: 0.75rem; background: #f3f4f6; border-radius: 8px; font-size: 0.75rem; color: #6b7280;">
                <strong>L√©gende:</strong>
                <span style="margin-left: 1rem; color: #8b5cf6;">üîí Colonne B</span> = R√©f√©rence jour!BY (lecture seule)
                <span style="margin-left: 1rem; color: #3b82f6;">üßÆ Colonne Z</span> = SUM(C:Y) + B (calcul√©)
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- END DUEBACK TAB -->

      <!-- RECAP TAB -->
      <div id="tab-recap" class="rj-tab-content">
        <div class="rj-card">
          <div class="forms">
            <div class="form-tile">
              <h4>Recap - R√©conciliation Cash</h4>
          <p style="font-size:0.875rem; color:var(--text-secondary); margin-bottom:1.5rem;">
            Tableau interactif type Excel. Les signes sont g√©r√©s automatiquement. Le RECAP doit balancer √† $0.00.
          </p>

          <!-- Balance Indicators -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">

            <!-- Balance Finale Recap -->
            <div id="recap-balance-indicator" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 3px solid #dee2e6; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <div style="font-size: 0.875rem; font-weight: 600; color: #6c757d; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                BALANCE FINALE RECAP
              </div>
              <div id="recap-balance-value" style="font-size: 2.5rem; font-weight: 700; margin: 0.5rem 0; font-family: 'Courier New', monospace; color: #495057;">
                $0.00
              </div>
              <div id="recap-balance-message" style="font-size: 0.875rem; color: #6c757d; margin-top: 0.5rem;">
                En attente des donn√©es...
              </div>
            </div>

            <!-- Balance SD (I10) - Lien externe -->
            <div id="recap-sd-indicator" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 3px solid #dee2e6; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <div style="font-size: 0.875rem; font-weight: 600; color: #6c757d; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                BALANCE SD (I10)
                <br><span style="font-size: 0.7rem; font-weight: 400; color: #868e96;">Lien externe - SetD</span>
              </div>
              <div id="recap-sd-value" style="font-size: 2.5rem; font-weight: 700; margin: 0.5rem 0; font-family: 'Courier New', monospace; color: #495057;">
                $0.00
              </div>
              <div id="recap-sd-message" style="font-size: 0.875rem; color: #6c757d; margin-top: 0.5rem;">
                En attente des donn√©es...
              </div>
            </div>
          </div>
          
          <div style="margin-bottom: 1.5rem;">
            <div class="form-group" style="margin-bottom:1rem;">
              <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                <input type="checkbox" id="recap-has-cheques" onchange="toggleCheques()" style="width:20px; height:20px; cursor:pointer;">
                <span>Nous avons re√ßu des ch√®ques</span>
              </label>
            </div>
          </div>

          <div style="overflow-x: auto; margin-bottom: 1.5rem; border: 1px solid var(--border); border-radius: 8px;">
            <table id="recap-table" class="excel-table" style="width: 100%; border-collapse: collapse; min-width: 900px;">
              <thead>
                <tr>
                  <th class="excel-header excel-row-header"></th>
                  <th class="excel-header">Description</th>
                  <th class="excel-header">Lecture<br>(B)</th>
                  <th class="excel-header">Corr. +(-)<br>(C)</th>
                  <th class="excel-header">Net<br>(D)</th>
                  <th class="excel-header" style="width:100px;">Actions<br>(F)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="excel-row-header">6</td>
                  <td class="excel-label">Comptant LightSpeed</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="B6" data-field="comptant_lightspeed_lecture" data-always-positive="true" placeholder="0.00" min="0"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="C6" data-field="comptant_lightspeed_corr" placeholder="0.00"></td>
                  <td class="excel-cell calculated-cell" style="background:#f8f9fa; text-align:right; padding-right:1rem;">
                    <span id="recap-d6" class="calculated-value" style="font-weight:600; color:#495057; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell"></td>
                </tr>
                <tr>
                  <td class="excel-row-header">7</td>
                  <td class="excel-label">Comptant Positouch</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="B7" data-field="comptant_positouch_lecture" data-always-positive="true" placeholder="0.00" min="0"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="C7" data-field="comptant_positouch_corr" placeholder="0.00"></td>
                  <td class="excel-cell calculated-cell" style="background:#f8f9fa; text-align:right; padding-right:1rem;">
                    <span id="recap-d7" class="calculated-value" style="font-weight:600; color:#495057; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell"></td>
                </tr>
                <tr id="recap-cheques-row-1" class="recap-cheques-row" style="display:none;">
                  <td class="excel-row-header">8</td>
                  <td class="excel-label">Ch√®que payment register AR</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="B8" data-field="cheque_payment_register_lecture" placeholder="0.00" min="0"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="C8" data-field="cheque_payment_register_corr" placeholder="0.00"></td>
                  <td class="excel-cell calculated-cell" style="background:#f8f9fa; text-align:right; padding-right:1rem;">
                    <span id="recap-d8" class="calculated-value" style="font-weight:600; color:#495057; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell"></td>
                </tr>
                <tr id="recap-cheques-row-2" class="recap-cheques-row" style="display:none;">
                  <td class="excel-row-header">9</td>
                  <td class="excel-label">Ch√®que Daily Revenu</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="B9" data-field="cheque_daily_revenu_lecture" placeholder="0.00" min="0"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="C9" data-field="cheque_daily_revenu_corr" placeholder="0.00"></td>
                  <td class="excel-cell calculated-cell" style="background:#f8f9fa; text-align:right; padding-right:1rem;">
                    <span id="recap-d9" class="calculated-value" style="font-weight:600; color:#495057; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell"></td>
                </tr>
                <!-- Row 10: TOTAL Cash & Checks -->
                <tr class="total-row" style="background:#e7f3ff; font-weight:600; border-top:2px solid #dee2e6; border-bottom:2px solid #dee2e6;">
                  <td class="excel-row-header" style="font-weight:700;">10</td>
                  <td class="excel-label" style="font-weight:700;">TOTAL</td>
                  <td class="excel-cell calculated-cell" style="background:#d4e9ff; text-align:right; padding-right:1rem;">
                    <span id="recap-b10" class="calculated-value" style="font-weight:700; color:#0c5aa6; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell calculated-cell" style="background:#d4e9ff; text-align:right; padding-right:1rem;">
                    <span id="recap-c10" class="calculated-value" style="font-weight:700; color:#0c5aa6; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell calculated-cell" style="background:#d4e9ff; text-align:right; padding-right:1rem;">
                    <span id="recap-d10" class="calculated-value" style="font-weight:700; color:#0c5aa6; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell"></td>
                </tr>
                <tr>
                  <td class="excel-row-header">11</td>
                  <td class="excel-label" style="color: #dc3545; font-weight: 600;">Moins Remboursement Gratuit√©</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="B11" data-field="remb_gratuite_lecture" data-always-negative="true" placeholder="0.00" min="0" style="color: #dc3545;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="C11" data-field="remb_gratuite_corr" placeholder="0.00" style="color: #dc3545;"></td>
                  <td class="excel-cell calculated-cell" style="background:#f8f9fa; text-align:right; padding-right:1rem;">
                    <span id="recap-d11" class="calculated-value" style="font-weight:600; color:#dc3545; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell"></td>
                </tr>
                <tr>
                  <td class="excel-row-header">12</td>
                  <td class="excel-label" style="color: #dc3545; font-weight: 600;">Moins Remboursement Client</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="B12" data-field="remb_client_lecture" data-always-negative="true" placeholder="0.00" min="0" style="color: #dc3545;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="C12" data-field="remb_client_corr" placeholder="0.00" style="color: #dc3545;"></td>
                  <td class="excel-cell calculated-cell" style="background:#f8f9fa; text-align:right; padding-right:1rem;">
                    <span id="recap-d12" class="calculated-value" style="font-weight:600; color:#dc3545; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell"></td>
                </tr>
                <!-- Row 14: TOTAL apr√®s remboursements -->
                <tr class="total-row" style="background:#fff3cd; font-weight:600; border-top:2px solid #dee2e6; border-bottom:2px solid #dee2e6;">
                  <td class="excel-row-header" style="font-weight:700;">14</td>
                  <td class="excel-label" style="font-weight:700;">TOTAL apr√®s remb.</td>
                  <td class="excel-cell calculated-cell" style="background:#ffeaa7; text-align:right; padding-right:1rem;">
                    <span id="recap-b14" class="calculated-value" style="font-weight:700; color:#d68910; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell calculated-cell" style="background:#ffeaa7; text-align:right; padding-right:1rem;">
                    <span id="recap-c14" class="calculated-value" style="font-weight:700; color:#d68910; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell calculated-cell" style="background:#ffeaa7; text-align:right; padding-right:1rem;">
                    <span id="recap-d14" class="calculated-value" style="font-weight:700; color:#d68910; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell"></td>
                </tr>
                <tr>
                  <td class="excel-row-header">16</td>
                  <td class="excel-label">Due Back R√©ception</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="B16" data-field="due_back_reception_lecture" data-always-positive="true" placeholder="0.00" min="0"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="C16" data-field="due_back_reception_corr" placeholder="0.00"></td>
                  <td class="excel-cell calculated-cell" style="background:#f8f9fa; text-align:right; padding-right:1rem;">
                    <span id="recap-d16" class="calculated-value" style="font-weight:600; color:#495057; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell" style="text-align:center;">
                    <button onclick="fillDueBackReception()" class="recap-macro-btn" title="Auto-remplir depuis DueBack" style="background:#007bff; color:white; border:none; padding:0.25rem 0.5rem; border-radius:4px; cursor:pointer; font-size:0.75rem; font-weight:600;">
                      WR
                    </button>
                  </td>
                </tr>
                <tr>
                  <td class="excel-row-header">17</td>
                  <td class="excel-label">Due Back N/B</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="B17" data-field="due_back_nb_lecture" data-always-positive="true" placeholder="0.00" min="0"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="C17" data-field="due_back_nb_corr" placeholder="0.00"></td>
                  <td class="excel-cell calculated-cell" style="background:#f8f9fa; text-align:right; padding-right:1rem;">
                    <span id="recap-d17" class="calculated-value" style="font-weight:600; color:#495057; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell" style="text-align:center;">
                    <button onclick="fillDueBackNB()" class="recap-macro-btn" title="Auto-remplir depuis DueBack" style="background:#007bff; color:white; border:none; padding:0.25rem 0.5rem; border-radius:4px; cursor:pointer; font-size:0.75rem; font-weight:600;">
                      WN
                    </button>
                  </td>
                </tr>
                <!-- Row 18: TOTAL √† d√©poser -->
                <tr class="total-row" style="background:#d4edda; font-weight:600; border-top:2px solid #dee2e6; border-bottom:2px solid #dee2e6;">
                  <td class="excel-row-header" style="font-weight:700;">18</td>
                  <td class="excel-label" style="font-weight:700;">Total √† d√©poser</td>
                  <td class="excel-cell calculated-cell" style="background:#b7e4c7; text-align:right; padding-right:1rem;">
                    <span id="recap-b18" class="calculated-value" style="font-weight:700; color:#1e7145; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell calculated-cell" style="background:#b7e4c7; text-align:right; padding-right:1rem;">
                    <span id="recap-c18" class="calculated-value" style="font-weight:700; color:#1e7145; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell calculated-cell" style="background:#b7e4c7; text-align:right; padding-right:1rem;">
                    <span id="recap-d18" class="calculated-value" style="font-weight:700; color:#1e7145; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell"></td>
                </tr>
                <tr>
                  <td class="excel-row-header">19</td>
                  <td class="excel-label">Surplus/d√©ficit (+ ou -)</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="B19" data-field="surplus_deficit_lecture" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input recap-calc-input" data-cell="C19" data-field="surplus_deficit_corr" placeholder="0.00"></td>
                  <td class="excel-cell calculated-cell" style="background:#f8f9fa; text-align:right; padding-right:1rem;">
                    <span id="recap-d19" class="calculated-value" style="font-weight:600; color:#495057; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell" style="text-align:center;">
                    <button onclick="fillSurplusDeficit()" class="recap-macro-btn" title="Auto-calculer surplus/d√©ficit" style="background:#28a745; color:white; border:none; padding:0.25rem 0.5rem; border-radius:4px; cursor:pointer; font-size:0.75rem; font-weight:600;">
                      WS
                    </button>
                  </td>
                </tr>
                <!-- Row 20: TOTAL d√©p√¥t net -->
                <tr class="total-row" style="background:#cfe2ff; font-weight:600; border-top:2px solid #dee2e6; border-bottom:2px solid #dee2e6;">
                  <td class="excel-row-header" style="font-weight:700;">20</td>
                  <td class="excel-label" style="font-weight:700;">Total d√©p√¥t net</td>
                  <td class="excel-cell calculated-cell" style="background:#b6d7ff; text-align:right; padding-right:1rem;">
                    <span id="recap-b20" class="calculated-value" style="font-weight:700; color:#084298; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell calculated-cell" style="background:#b6d7ff; text-align:right; padding-right:1rem;">
                    <span id="recap-c20" class="calculated-value" style="font-weight:700; color:#084298; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell calculated-cell" style="background:#b6d7ff; text-align:right; padding-right:1rem;">
                    <span id="recap-d20" class="calculated-value" style="font-weight:700; color:#084298; font-family:'Courier New',monospace;">$0.00</span>
                  </td>
                  <td class="excel-cell"></td>
                </tr>
                <!-- Row 22: D√©p√¥t Canadien - HIDDEN (calculated by Excel, visible only in preview) -->
                <!-- Row 23: ‚≠ê BALANCE FINALE ‚≠ê -->
                <tr class="balance-final-row" style="background:linear-gradient(135deg, #198754 0%, #0f5132 100%); color:white; font-weight:700; font-size:1.1rem; border-top:3px solid #0a3622; border-bottom:3px solid #0a3622;">
                  <td class="excel-row-header" style="font-weight:700; color:white;">23</td>
                  <td class="excel-label" style="font-weight:700; color:white;">‚≠ê BALANCE FINALE</td>
                  <td class="excel-cell calculated-cell" style="background:#146c43; text-align:right; padding-right:1rem; border-left:2px solid #0a3622;">
                    <span id="recap-b23" class="calculated-value" style="font-weight:700; color:white; font-family:'Courier New',monospace; font-size:1.2rem;">$0.00</span>
                  </td>
                  <td class="excel-cell calculated-cell" style="background:#146c43; text-align:right; padding-right:1rem;">
                    <span id="recap-c23" class="calculated-value" style="font-weight:700; color:white; font-family:'Courier New',monospace; font-size:1.2rem;">$0.00</span>
                  </td>
                  <td class="excel-cell calculated-cell" style="background:#146c43; text-align:right; padding-right:1rem; border-right:2px solid #0a3622;">
                    <span id="recap-d23" class="calculated-value" style="font-weight:700; color:white; font-family:'Courier New',monospace; font-size:1.2rem;">$0.00</span>
                  </td>
                  <td class="excel-cell" style="background:#146c43;"></td>
                </tr>
                <tr>
                  <td class="excel-row-header">26</td>
                  <td class="excel-label">Pr√©par√© par</td>
                  <td class="excel-cell" colspan="4"><input type="text" class="excel-input" data-cell="B26" data-field="prepare_par" placeholder="Nom"></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div style="margin-bottom: 1.5rem; padding:1rem; background:var(--bg); border-radius:8px; border:1px solid var(--border-light);">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.5rem;">
              <strong style="color:var(--text);">Balance RECAP:</strong>
              <span id="recap-balance" style="font-size:1.25rem; font-weight:700; color:var(--text);">$0.00</span>
            </div>
            <small style="color:var(--text-muted);">Le RECAP doit balancer √† $0.00</small>
            <div id="recap-balance-status" style="margin-top:0.5rem; font-size:0.875rem; font-weight:600;"></div>
          </div>

          <div class="form-actions">
            <button class="rj-btn" onclick="saveRecap()" id="recap-save-btn">
              <i data-feather="save"></i> Enregistrer Recap
            </button>
          </div>
        </div>

        <!-- Live Preview Section -->
        <div class="excel-preview-container" style="margin-top: 2rem;">
          <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i data-feather="eye"></i> Aper√ßu Excel - Recap
          </h4>
          <div id="recap-preview-wrapper" style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
            <table id="recap-preview-table" class="excel-preview" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
              <tr><td style="text-align: center; padding: 2rem; color: #999;">Chargement de l'aper√ßu...</td></tr>
            </table>
          </div>
        </div>

        <!-- Send to RJ Button -->
        <div style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #e7f3ff 0%, #cfe2ff 100%); border: 2px solid #0d6efd; border-radius: 12px;">
          <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
              <h5 style="margin: 0 0 0.5rem 0; color: #084298;">
                <i data-feather="send"></i> Envoyer dans RJ
              </h5>
              <p style="margin: 0; font-size: 0.875rem; color: #084298;">
                Copie les donn√©es du Recap (row 19) vers l'onglet "jour" pour le jour s√©lectionn√©
              </p>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
              <div>
                <label for="recap-send-day" style="display: block; font-size: 0.875rem; font-weight: 600; color: #084298; margin-bottom: 0.25rem;">
                  Jour:
                </label>
                <input
                  type="number"
                  id="recap-send-day"
                  min="1"
                  max="31"
                  value="1"
                  style="width: 80px; padding: 0.5rem; border: 2px solid #0d6efd; border-radius: 6px; font-size: 1rem; text-align: center;"
                >
              </div>
              <button
                type="button"
                id="send-recap-to-rj-btn"
                onclick="sendRecapToRJ()"
                style="padding: 0.75rem 1.5rem; background: #0d6efd; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; margin-top: 1.5rem;"
                onmouseover="this.style.background='#0b5ed7'"
                onmouseout="this.style.background='#0d6efd'"
              >
                <i data-feather="send" style="width: 18px; height: 18px;"></i>
                Envoyer
              </button>
            </div>
          </div>

          <!-- Result Message -->
          <div id="send-recap-result" style="display: none; margin-top: 1rem;"></div>
        </div>

          </div>
        </div>
      </div>
      <!-- END RECAP TAB -->

      <!-- SD TAB -->
      <div id="tab-sd" class="rj-tab-content active">
        <div class="rj-card">
          <div class="forms">
            <div class="form-tile">
          <h4>SD - Sommaire Journalier des D√©p√¥ts</h4>
          <p style="font-size:0.875rem; color:var(--text-secondary); margin-bottom:1.5rem;">
            Uploadez le fichier SD (Sommaire Journalier) s√©par√© et s√©lectionnez le jour √† remplir.
          </p>

          <!-- SD File Upload Section -->
          <div style="background: linear-gradient(135deg, #e7f3ff 0%, #cfe2ff 100%); padding: 1.5rem; border: 2px solid #0d6efd; border-radius: 12px; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 200px;">
                <h5 style="margin: 0 0 0.5rem 0; color: #084298;">
                  <i data-feather="upload"></i> Upload fichier SD
                </h5>
                <p style="margin: 0; font-size: 0.875rem; color: #084298;">
                  Le fichier SD est un Excel s√©par√© avec 31 onglets (un par jour du mois)
                </p>
              </div>
              <div style="display: flex; gap: 1rem; align-items: center;">
                <label for="sd-file-input" class="rj-btn" style="background: #0d6efd; color: white; cursor: pointer; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                  <i data-feather="file"></i> Choisir fichier SD
                  <input type="file" id="sd-file-input" accept=".xls,.xlsx" style="display: none;" onchange="uploadSDFile()">
                </label>
              </div>
            </div>
            <div id="sd-file-info" style="display: none; margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #0d6efd;">
              <div style="display: flex; align-items: center; gap: 0.5rem; color: #198754; font-weight: 600; margin-bottom: 0.5rem;">
                <i data-feather="check-circle" style="width: 18px; height: 18px;"></i>
                <span id="sd-filename">Fichier SD charg√©</span>
              </div>
              <div style="font-size: 0.875rem; color: #6c757d;">
                <span id="sd-file-size"></span> ‚Ä¢ <span id="sd-available-days"></span>
              </div>
            </div>
          </div>

          <!-- Day Selector -->
          <div id="sd-day-selector" style="display: none; background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border: 2px solid #6c757d; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; justify-content: space-between;">
              <div>
                <h5 style="margin: 0 0 0.5rem 0; color: #495057;">
                  <i data-feather="calendar"></i> S√©lectionner le jour
                </h5>
                <p style="margin: 0; font-size: 0.875rem; color: #6c757d;">
                  Choisissez le jour du mois pour voir et √©diter les entr√©es
                </p>
              </div>
              <div style="display: flex; gap: 1rem; align-items: center;">
                <label for="sd-current-day" style="font-weight: 600; color: #495057;">Jour:</label>
                <input type="number" id="sd-current-day" min="1" max="31" value="1" style="width: 80px; padding: 0.5rem; border: 2px solid #6c757d; border-radius: 6px; font-size: 1rem; text-align: center;">
                <button type="button" onclick="loadSDDay()" class="rj-btn" style="background: #6c757d; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600;">
                  <i data-feather="refresh-cw"></i> Charger jour
                </button>
                <button type="button" onclick="downloadSDFile()" class="rj-btn" style="background: #198754; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600;">
                  <i data-feather="download"></i> T√©l√©charger SD
                </button>
              </div>
            </div>
            <div id="sd-day-info" style="display: none; margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px;">
              <div style="font-size: 0.875rem; color: #495057;">
                <strong>Date:</strong> <span id="sd-day-date">-</span> ‚Ä¢
                <strong>Entr√©es:</strong> <span id="sd-day-entries-count">0</span>
              </div>
            </div>
          </div>

          <div style="background:#fff3cd; padding:1rem; border-radius:6px; border-left:4px solid #ffc107; margin-bottom:1.5rem;">
            <strong style="color:#856404;">‚ÑπÔ∏è Note:</strong>
            <p style="margin:0.5rem 0 0 0; font-size:0.875rem; color:#856404;">
              Le <strong>MONTANT V√âRIFI√â</strong> total sera automatiquement transf√©r√© dans le Recap "D√©p√¥t Canadien" et peut √™tre enregistr√© dans la feuille depot.
            </p>
          </div>

          <!-- LIVE VALIDATION DASHBOARD - Sticky pour toujours visible -->
          <div id="live-validation-dashboard" style="position: sticky; top: 10px; z-index: 100; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin: 1.5rem 0; padding: 1rem; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; border: 2px solid #dee2e6; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">

            <!-- DEPOT PREVIEW -->
            <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #007bff;">
              <h6 style="margin: 0 0 0.5rem 0; color: #007bff; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 0.5rem;">
                <i data-feather="archive" style="width: 16px; height: 16px;"></i>
                ‚Üí Depot
              </h6>
              <div style="text-align: center; padding: 0.25rem 0; border-bottom: 1px solid #eee; margin-bottom: 0.5rem;">
                <div style="font-size: 0.65rem; color: #6c757d;">√Ä importer</div>
                <div id="live-depot-amount" style="font-size: 1.25rem; font-weight: 700; color: #007bff;">$0.00</div>
              </div>
              <!-- Entries list for both clients -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.7rem;">
                <!-- Client 6 -->
                <div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                    <span style="font-weight: 600; color: #007bff;">Client 6</span>
                    <span id="live-depot-c6-count" style="font-size: 0.65rem; color: #6c757d;">0/7</span>
                  </div>
                  <div style="background: #e9ecef; border-radius: 3px; height: 4px; margin-bottom: 0.25rem;">
                    <div id="live-depot-c6-bar" style="background: #007bff; height: 100%; border-radius: 3px; width: 0%; transition: width 0.3s;"></div>
                  </div>
                  <!-- Excel-style headers -->
                  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; font-size: 0.55rem; font-weight: 700; color: #495057; background: #dee2e6; padding: 0.15rem 0.2rem; border-radius: 3px 3px 0 0;">
                    <span>DATE</span>
                    <span style="text-align: right;">MONTANTS</span>
                    <span style="text-align: right;">TOTAL</span>
                  </div>
                  <div id="live-depot-c6-entries" style="max-height: 80px; overflow-y: auto; background: #f8f9fa; border-radius: 0 0 4px 4px; padding: 0.25rem;">
                    <div style="color: #999; font-style: italic; text-align: center; font-size: 0.65rem;">Vide</div>
                  </div>
                  <div style="text-align: right; margin-top: 0.25rem; font-weight: 600;">
                    Total: <span id="live-depot-c6-total" style="color: #007bff;">$0.00</span>
                  </div>
                </div>
                <!-- Client 8 -->
                <div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                    <span style="font-weight: 600; color: #17a2b8;">Client 8</span>
                    <span id="live-depot-c8-count" style="font-size: 0.65rem; color: #6c757d;">0/7</span>
                  </div>
                  <div style="background: #e9ecef; border-radius: 3px; height: 4px; margin-bottom: 0.25rem;">
                    <div id="live-depot-c8-bar" style="background: #17a2b8; height: 100%; border-radius: 3px; width: 0%; transition: width 0.3s;"></div>
                  </div>
                  <!-- Excel-style headers -->
                  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; font-size: 0.55rem; font-weight: 700; color: #495057; background: #dee2e6; padding: 0.15rem 0.2rem; border-radius: 3px 3px 0 0;">
                    <span>DATE</span>
                    <span style="text-align: right;">MONTANTS</span>
                    <span style="text-align: right;">TOTAL</span>
                  </div>
                  <div id="live-depot-c8-entries" style="max-height: 80px; overflow-y: auto; background: #f8f9fa; border-radius: 0 0 4px 4px; padding: 0.25rem;">
                    <div style="color: #999; font-style: italic; text-align: center; font-size: 0.65rem;">Vide</div>
                  </div>
                  <div style="text-align: right; margin-top: 0.25rem; font-weight: 600;">
                    Total: <span id="live-depot-c8-total" style="color: #17a2b8;">$0.00</span>
                  </div>
                </div>
              </div>
              <!-- Target indicator -->
              <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 0.7rem; color: #6c757d;">Prochain import ‚Üí</span>
                <span id="live-depot-target" style="font-size: 0.75rem; font-weight: 700; color: #007bff;">Client 6</span>
              </div>
              <!-- Rotation warning -->
              <div id="live-depot-rotation" style="display: none; margin-top: 0.5rem; padding: 0.25rem 0.5rem; background: #fff3cd; border-radius: 4px; font-size: 0.65rem; color: #856404;">
                ‚ö†Ô∏è Rotation auto activ√©e
              </div>
            </div>

            <!-- SETD PREVIEW -->
            <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #28a745;">
              <h6 style="margin: 0 0 0.75rem 0; color: #28a745; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 0.5rem;">
                <i data-feather="users" style="width: 16px; height: 16px;"></i>
                ‚Üí SetD
              </h6>
              <div id="live-setd-list" style="max-height: 120px; overflow-y: auto; font-size: 0.8rem;">
                <div style="color: #999; font-style: italic; text-align: center; padding: 1rem;">Aucune variance</div>
              </div>
              <div style="border-top: 1px solid #eee; padding-top: 0.5rem; margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 0.75rem; color: #6c757d;">Total SetD:</span>
                <span id="live-setd-total" style="font-weight: 700; color: #28a745;">$0.00</span>
              </div>
            </div>

            <!-- BALANCE INDICATOR -->
            <div id="live-balance-card" style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #6c757d;">
              <h6 style="margin: 0 0 0.75rem 0; color: #6c757d; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 0.5rem;">
                <i data-feather="check-circle" style="width: 16px; height: 16px;"></i>
                Balance
              </h6>
              <div style="text-align: center; padding: 0.5rem 0;">
                <div id="live-balance-icon" style="font-size: 2.5rem; margin-bottom: 0.25rem;">‚ö™</div>
                <div id="live-balance-status" style="font-size: 0.85rem; font-weight: 600; color: #6c757d;">En attente...</div>
              </div>
              <div style="border-top: 1px solid #eee; padding-top: 0.5rem; margin-top: 0.5rem;">
                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                  <span style="color: #6c757d;">Variance SD:</span>
                  <span id="live-variance-sd" style="font-weight: 600;">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                  <span style="color: #6c757d;">Diff√©rence:</span>
                  <span id="live-variance-diff" style="font-weight: 700;">$0.00</span>
                </div>
              </div>
            </div>
          </div>

          <div style="overflow-x: auto; margin-bottom: 1.5rem; border: 1px solid var(--border); border-radius: 8px;">
            <table id="sd-table" class="excel-table" style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background:#4a90e2; color:white;">
                  <th class="excel-header" style="width: 150px;">D√âPARTEMENT</th>
                  <th class="excel-header" style="width: 200px;">NOM LETTRES MOUL√âES</th>
                  <th class="excel-header" style="width: 100px;">CDN/US</th>
                  <th class="excel-header" style="width: 150px;">MONTANT</th>
                  <th class="excel-header" style="width: 150px; background:#ffc107; color:#000;">MONTANT V√âRIFI√â</th>
                  <th class="excel-header" style="width: 150px;">REMBOURSEMENT</th>
                  <th class="excel-header" style="width: 150px;">VARIANCE</th>
                  <th class="excel-header" style="width: 80px;">Actions</th>
                </tr>
              </thead>
              <tbody id="sd-body">
                <!-- Rows added dynamically -->
              </tbody>
              <tfoot>
                <tr style="background:#2c3e50; color:white; font-weight:600;">
                  <td colspan="3" style="text-align:right; padding:0.75rem; font-size:1rem;">TOTAL:</td>
                  <td class="excel-cell">
                    <input type="number" step="0.01" class="excel-input" id="sd-total-montant" readonly style="background:#34495e; color:white; font-weight:600;">
                  </td>
                  <td class="excel-cell" style="background:#ffc107;">
                    <input type="number" step="0.01" class="excel-input" id="sd-total-verifie" readonly style="background:#ffca2c; color:#000; font-weight:700; font-size:1.05rem;">
                  </td>
                  <td class="excel-cell">
                    <input type="number" step="0.01" class="excel-input" id="sd-total-remboursement" readonly style="background:#34495e; color:white; font-weight:600;">
                  </td>
                  <td class="excel-cell">
                    <input type="number" step="0.01" class="excel-input" id="sd-total-variance" readonly style="background:#34495e; color:white; font-weight:600;">
                  </td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
            <!-- Datalist for autocomplete name filtering (must be outside table) -->
            <datalist id="setd-names-datalist">
              <!-- Options will be populated by JavaScript -->
            </datalist>
          </div>

          <button class="rj-btn" onclick="addSDRow()" style="background:#28a745; padding:0.5rem 1rem; font-size:0.875rem; margin-bottom:1rem;">
            <i data-feather="plus"></i> Ajouter une ligne SD
          </button>

          <!-- EXPORT TO SETD SECTION -->
          <div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); padding: 1.25rem; border-radius: 8px; border: 2px solid #28a745; margin-bottom: 1.5rem; margin-top: 1rem;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
              <div style="flex: 1; min-width: 250px;">
                <h5 style="margin: 0 0 0.5rem 0; color: #155724; display: flex; align-items: center; gap: 0.5rem;">
                  <i data-feather="upload" style="width: 20px; height: 20px;"></i>
                  Exporter variances vers SetD
                </h5>
                <p style="margin: 0; font-size: 0.875rem; color: #155724;">
                  Envoie les <strong>variances par employ√©</strong> dans la feuille SetD du RJ (colonne correspondant au nom).
                </p>
              </div>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="text-align: center;">
                  <div style="font-size: 0.75rem; color: #155724; font-weight: 600;">Variances √† exporter</div>
                  <div id="sd-setd-preview-count" style="font-size: 1.5rem; font-weight: 700; color: #155724;">0</div>
                </div>
                <button onclick="showSDSetDPreview()" class="rj-btn" style="background: #17a2b8; color: white; border: 2px solid #138496; padding: 0.75rem 1rem; font-weight: 600;">
                  <i data-feather="eye"></i> Aper√ßu
                </button>
                <button onclick="exportSDToSetD()" class="rj-btn" style="background: #28a745; color: white; border: 2px solid #1e7e34; padding: 0.75rem 1.5rem; font-weight: 700;">
                  <i data-feather="send"></i> Exporter vers SetD
                </button>
              </div>
            </div>
            <!-- Variances preview (collapsed by default) -->
            <div id="sd-setd-preview" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #28a745;">
              <div style="font-size: 0.875rem; font-weight: 600; color: #155724; margin-bottom: 0.5rem;">
                <i data-feather="list" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                Aper√ßu des variances par employ√©:
              </div>
              <div id="sd-setd-preview-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; max-height: 200px; overflow-y: auto;">
                <!-- Filled dynamically -->
              </div>
              <div id="sd-setd-unmatched" style="display: none; margin-top: 0.75rem; padding: 0.5rem; background: #fff3cd; border-radius: 4px; font-size: 0.8rem; color: #856404;">
                <strong>Noms non reconnus:</strong> <span id="sd-setd-unmatched-names"></span>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button class="rj-btn" onclick="saveSD()">
              <i data-feather="save"></i> Enregistrer SD
            </button>
          </div>
        </div>

        <!-- Live Preview Section -->
        <div class="excel-preview-container" style="margin-top: 2rem;">
          <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i data-feather="eye"></i> Aper√ßu Excel - SD
          </h4>
          <div id="sd-preview-wrapper" style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
            <table id="sd-preview-table" class="excel-preview" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
              <tr><td style="text-align: center; padding: 2rem; color: #999;">Chargement de l'aper√ßu...</td></tr>
            </table>
          </div>
        </div>
          </div>
        </div>
      </div>
      <!-- END SD TAB -->

      <!-- DEPOT TAB -->
      <div id="tab-depot" class="rj-tab-content">
        <div class="rj-card">
          <div class="forms">
            <div class="form-tile">
          <h4>D√©p√¥t - Comptes Canadiens</h4>
          <p style="font-size:0.875rem; color:var(--text-secondary); margin-bottom:1rem;">
            Enregistrez les montants d√©pos√©s dans le coffre. Les totaux sont calcul√©s automatiquement.
          </p>

          <!-- AUTO-FILL FROM SD SECTION -->
          <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%); padding: 1.25rem; border-radius: 8px; border: 2px solid #ffc107; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
              <div style="flex: 1; min-width: 250px;">
                <h5 style="margin: 0 0 0.5rem 0; color: #856404; display: flex; align-items: center; gap: 0.5rem;">
                  <i data-feather="zap" style="width: 20px; height: 20px;"></i>
                  Auto-remplir depuis SD
                </h5>
                <p style="margin: 0; font-size: 0.875rem; color: #856404;">
                  Copie automatiquement le <strong>Montant V√©rifi√© Total</strong> du SD vers le D√©p√¥t.
                </p>
              </div>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="text-align: center;">
                  <div style="font-size: 0.75rem; color: #856404; font-weight: 600;">SD Total V√©rifi√©</div>
                  <div id="depot-sd-preview" style="font-size: 1.5rem; font-weight: 700; color: #856404;">$0.00</div>
                </div>
                <button onclick="fillDepotFromSD()" class="rj-btn" style="background: #ffc107; color: #212529; border: 2px solid #e0a800; padding: 0.75rem 1.5rem; font-weight: 700;">
                  <i data-feather="download"></i> Importer du SD
                </button>
              </div>
            </div>
            <!-- Validation indicator -->
            <div id="depot-sd-validation" style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed #e0a800; display: none;">
              <span style="font-size: 0.875rem; font-weight: 600;"></span>
            </div>
          </div>

          <div style="background:#d1ecf1; padding:1rem; border-radius:6px; border-left:4px solid #0c5460; margin-bottom:1.5rem;">
            <strong style="color:#0c5460;">‚ÑπÔ∏è Note importante:</strong>
            <p style="margin:0.5rem 0 0 0; font-size:0.875rem; color:#0c5460;">
              CLIENT 6 et CLIENT 8 sont simplement deux espaces parall√®les pour maximiser l'espace de log.
              Utilisez l'un ou l'autre selon l'espace disponible. <strong>Gardez seulement les 7 derniers jours.</strong>
            </p>
          </div>
        
          <!-- COMPTE CLIENT 6 -->
          <div style="margin-bottom: 2rem;">
            <h5 style="font-weight:600; color:var(--text); margin-bottom:1rem; padding-bottom:0.5rem; border-bottom: 2px solid var(--border);">
              CLIENT 6 - COMPTE #1844-22
            </h5>

            <!-- DATE Field -->
            <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff;">
              <label style="font-weight: 600; font-size: 0.875rem; color: var(--text); margin-bottom: 0.5rem; display: block;">
                DATE (ex: 23 DECEMBRE):
              </label>
              <input type="text" id="depot-client6-date" class="excel-input" placeholder="23 DECEMBRE"
                     style="width: 300px; padding: 0.5rem; font-size: 0.95rem; font-weight: 500;">
            </div>

            <div style="overflow-x: auto; margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 8px;">
              <table id="depot-client6-table" class="excel-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr>
                    <th class="excel-header" style="width: 50px;">#</th>
                    <th class="excel-header" style="width: 200px;">Montant</th>
                    <th class="excel-header" style="width: 80px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="depot-client6-body">
                  <!-- Rows added dynamically -->
                </tbody>
                <tfoot>
                  <tr style="background:#f8f9fa; font-weight:600;">
                    <td class="excel-label" colspan="1" style="text-align:right; padding:0.75rem;">SIGNATURE (TOTAL):</td>
                    <td class="excel-cell">
                      <input type="number" step="0.01" class="excel-input" id="depot-client6-total" readonly style="background:#e9ecef; font-weight:600; font-size:1rem;">
                    </td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <button class="rj-btn" onclick="addDepotRow('client6')" style="background:#28a745; padding:0.5rem 1rem; font-size:0.875rem;">
              <i data-feather="plus"></i> Ajouter un montant
            </button>
          </div>
        
          <!-- COMPTE CLIENT 8 -->
          <div style="margin-bottom: 2rem;">
            <h5 style="font-weight:600; color:var(--text); margin-bottom:1rem; padding-bottom:0.5rem; border-bottom: 2px solid var(--border);">
              CLIENT 8 - COMPTE #4743-66
            </h5>

            <!-- DATE Field -->
            <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff;">
              <label style="font-weight: 600; font-size: 0.875rem; color: var(--text); margin-bottom: 0.5rem; display: block;">
                DATE (ex: 23 DECEMBRE):
              </label>
              <input type="text" id="depot-client8-date" class="excel-input" placeholder="23 DECEMBRE"
                     style="width: 300px; padding: 0.5rem; font-size: 0.95rem; font-weight: 500;">
            </div>

            <div style="overflow-x: auto; margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 8px;">
              <table id="depot-client8-table" class="excel-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr>
                    <th class="excel-header" style="width: 50px;">#</th>
                    <th class="excel-header" style="width: 200px;">Montant</th>
                    <th class="excel-header" style="width: 80px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="depot-client8-body">
                  <!-- Rows added dynamically -->
                </tbody>
                <tfoot>
                  <tr style="background:#f8f9fa; font-weight:600;">
                    <td class="excel-label" colspan="1" style="text-align:right; padding:0.75rem;">SIGNATURE (TOTAL):</td>
                    <td class="excel-cell">
                      <input type="number" step="0.01" class="excel-input" id="depot-client8-total" readonly style="background:#e9ecef; font-weight:600; font-size:1rem;">
                    </td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <button class="rj-btn" onclick="addDepotRow('client8')" style="background:#28a745; padding:0.5rem 1rem; font-size:0.875rem;">
              <i data-feather="plus"></i> Ajouter un montant
            </button>
          </div>
        
          <!-- TOTAL G√âN√âRAL -->
          <div style="padding: 1.5rem; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #007bff; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-weight:600; font-size:1.1rem; color:var(--text);">TOTAL G√âN√âRAL DES D√âP√îTS:</span>
              <input type="number" step="0.01" id="depot-total-general" readonly
                     style="width: 200px; font-size: 1.25rem; font-weight: 700; text-align: right; padding: 0.75rem; border: 2px solid #007bff; border-radius: 6px; background: white;">
            </div>
          </div>
        
          <div class="form-actions">
            <button class="rj-btn" onclick="saveDepot()">
              <i data-feather="save"></i> Enregistrer D√©p√¥t
            </button>
          </div>
        </div>
        
        <script>
        // ============================================================================
        // SD (SOMMAIRE JOURNALIER) - GESTION MULTI-ENTR√âES ET AUTO-CALCULS
        // ============================================================================

        // Storage for SD entries
        let sdData = [];

        // Initialize with one empty row
        function initializeSD() {
          if (sdData.length === 0) {
            addSDRow();
          }
        }

        // Add a new SD row
        function addSDRow() {
          const entry = {
            id: Date.now() + Math.random(),
            departement: '',
            nom: '',
            devise: 'CDN',
            montant: 0,
            montant_verifie: 0,
            remboursement: 0,
            variance: 0
          };

          sdData.push(entry);
          renderSDTable();

          // Focus on the new departement input
          setTimeout(() => {
            const tbody = document.getElementById('sd-body');
            const lastRow = tbody.lastElementChild;
            if (lastRow) {
              const deptInput = lastRow.querySelector('.sd-departement');
              if (deptInput) deptInput.focus();
            }
          }, 100);
        }

        // Remove an SD row
        function removeSDRow(entryId) {
          sdData = sdData.filter(e => e.id !== entryId);
          renderSDTable();
        }

        // Render the SD table
        function renderSDTable() {
          const tbody = document.getElementById('sd-body');
          tbody.innerHTML = '';

          sdData.forEach((entry, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="excel-cell">
                <select class="excel-input sd-departement" data-entry-id="${entry.id}"
                        onchange="updateSDEntry(${entry.id}, 'departement', this.value)">
                  <option value="">S√©lectionner...</option>
                  <option value="R√âCEPTION" ${entry.departement === 'R√âCEPTION' ? 'selected' : ''}>R√âCEPTION</option>
                  <option value="SPESA" ${entry.departement === 'SPESA' ? 'selected' : ''}>SPESA</option>
                  <option value="RESTAURANT" ${entry.departement === 'RESTAURANT' ? 'selected' : ''}>RESTAURANT</option>
                  <option value="BANQUET" ${entry.departement === 'BANQUET' ? 'selected' : ''}>BANQUET</option>
                  <option value="COMPTABILIT√â" ${entry.departement === 'COMPTABILIT√â' ? 'selected' : ''}>COMPTABILIT√â</option>
                </select>
              </td>
              <td class="excel-cell" style="position: relative;">
                <input type="text" class="excel-input sd-nom" data-entry-id="${entry.id}"
                       list="setd-names-datalist"
                       value="${entry.nom || ''}"
                       placeholder="Taper un nom..."
                       style="min-width: 180px;"
                       oninput="filterSDName(${entry.id}, this)"
                       onchange="validateSDName(${entry.id}, this)"
                       autocomplete="off">
                <span class="sd-nom-status" data-entry-id="${entry.id}" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.75rem;"></span>
              </td>
              <td class="excel-cell">
                <select class="excel-input sd-devise" data-entry-id="${entry.id}"
                        onchange="updateSDEntry(${entry.id}, 'devise', this.value)">
                  <option value="CDN" ${entry.devise === 'CDN' ? 'selected' : ''}>CDN</option>
                  <option value="US" ${entry.devise === 'US' ? 'selected' : ''}>US</option>
                </select>
              </td>
              <td class="excel-cell">
                <input type="number" step="0.01" class="excel-input sd-montant" data-entry-id="${entry.id}"
                       value="${entry.montant || ''}" placeholder="0.00"
                       onchange="updateSDEntry(${entry.id}, 'montant', this.value)">
              </td>
              <td class="excel-cell" style="background:#fff3cd;">
                <input type="number" step="0.01" class="excel-input sd-verifie" data-entry-id="${entry.id}"
                       value="${entry.montant_verifie || ''}" placeholder="0.00"
                       style="background:#ffedd5; font-weight:600;"
                       onchange="updateSDEntry(${entry.id}, 'montant_verifie', this.value)">
              </td>
              <td class="excel-cell">
                <input type="number" step="0.01" class="excel-input sd-remboursement" data-entry-id="${entry.id}"
                       value="${entry.remboursement || ''}" placeholder="0.00"
                       onchange="updateSDEntry(${entry.id}, 'remboursement', this.value)">
              </td>
              <td class="excel-cell">
                <input type="number" step="0.01" class="excel-input sd-variance" data-entry-id="${entry.id}"
                       value="${entry.variance || ''}" placeholder="0.00" readonly
                       style="background:#f0f0f0;">
              </td>
              <td class="excel-cell" style="text-align:center;">
                <button onclick="removeSDRow(${entry.id})"
                        style="background:#dc3545; color:white; border:none; padding:0.25rem 0.5rem; border-radius:4px; cursor:pointer; font-size:0.75rem;"
                        title="Supprimer cette ligne">
                  <i data-feather="trash-2" style="width:14px; height:14px;"></i>
                </button>
              </td>
            `;
            tbody.appendChild(row);
          });

          // Re-render feather icons
          if (typeof feather !== 'undefined') {
            feather.replace();
          }

          calculateSDTotals();
        }

        // Update a specific SD entry field
        function updateSDEntry(entryId, field, value) {
          const entry = sdData.find(e => e.id === entryId);
          if (entry) {
            if (['montant', 'montant_verifie', 'remboursement', 'variance'].includes(field)) {
              entry[field] = parseFloat(value) || 0;
            } else {
              entry[field] = value;
            }

            // Auto-calculate variance
            if (field === 'montant' || field === 'montant_verifie' || field === 'remboursement') {
              entry.variance = entry.montant - entry.montant_verifie + entry.remboursement;
            }

            calculateSDTotals();
          }
        }

        // Calculate SD totals
        function calculateSDTotals() {
          const totalMontant = sdData.reduce((sum, entry) => sum + (parseFloat(entry.montant) || 0), 0);
          const totalVerifie = sdData.reduce((sum, entry) => sum + (parseFloat(entry.montant_verifie) || 0), 0);
          const totalRemboursement = sdData.reduce((sum, entry) => sum + (parseFloat(entry.remboursement) || 0), 0);
          const totalVariance = sdData.reduce((sum, entry) => sum + (parseFloat(entry.variance) || 0), 0);

          document.getElementById('sd-total-montant').value = totalMontant.toFixed(2);
          document.getElementById('sd-total-verifie').value = totalVerifie.toFixed(2);
          document.getElementById('sd-total-remboursement').value = totalRemboursement.toFixed(2);
          document.getElementById('sd-total-variance').value = totalVariance.toFixed(2);

          // Update depot SD preview if function exists
          if (typeof updateDepotSDPreview === 'function') {
            updateDepotSDPreview();
          }

          // Update SetD export count
          updateSDSetDCount();

          // Update live validation dashboard
          updateLiveValidationDashboard();
        }

        // Update live validation dashboard in SD tab
        function updateLiveValidationDashboard() {
          // 1. Update Depot preview (Montant V√©rifi√© total)
          const totalVerifie = parseFloat(document.getElementById('sd-total-verifie')?.value) || 0;
          const depotAmountEl = document.getElementById('live-depot-amount');
          if (depotAmountEl) {
            depotAmountEl.textContent = '$' + totalVerifie.toFixed(2);
            depotAmountEl.style.color = totalVerifie > 0 ? '#007bff' : '#6c757d';
          }

          // 1b. Update Depot account details
          updateLiveDepotPreview();

          // 2. Update SetD preview (variances by employee)
          const { variances, unmatched } = getSDVariancesForSetD();
          const setdListEl = document.getElementById('live-setd-list');
          const setdTotalEl = document.getElementById('live-setd-total');

          if (setdListEl) {
            if (variances.length === 0) {
              setdListEl.innerHTML = '<div style="color: #999; font-style: italic; text-align: center; padding: 0.5rem;">Aucune variance</div>';
            } else {
              setdListEl.innerHTML = variances.map(v => {
                const color = v.variance > 0 ? '#dc3545' : '#28a745';
                const sign = v.variance > 0 ? '+' : '';
                return `<div style="display: flex; justify-content: space-between; padding: 0.25rem 0.5rem; border-bottom: 1px solid #f0f0f0;">
                  <span style="color: #333;">${v.nom}</span>
                  <span style="color: ${color}; font-weight: 600;">${sign}$${v.variance.toFixed(2)}</span>
                </div>`;
              }).join('');
            }
          }

          // Calculate SetD total
          const setdTotal = variances.reduce((sum, v) => sum + v.variance, 0);
          if (setdTotalEl) {
            const color = setdTotal > 0 ? '#dc3545' : setdTotal < 0 ? '#28a745' : '#6c757d';
            const sign = setdTotal > 0 ? '+' : '';
            setdTotalEl.textContent = sign + '$' + setdTotal.toFixed(2);
            setdTotalEl.style.color = color;
          }

          // 3. Update Balance indicator
          const totalVarianceSD = parseFloat(document.getElementById('sd-total-variance')?.value) || 0;
          const balanceCardEl = document.getElementById('live-balance-card');
          const balanceIconEl = document.getElementById('live-balance-icon');
          const balanceStatusEl = document.getElementById('live-balance-status');
          const varianceSDEl = document.getElementById('live-variance-sd');
          const varianceDiffEl = document.getElementById('live-variance-diff');

          // Variance SD = what's in the SD total
          // SetD total = sum of variances that have employee mapping
          // Difference = what's unaccounted for (employees not in SetD or no variance)
          const difference = totalVarianceSD - setdTotal;

          if (varianceSDEl) {
            const color = totalVarianceSD > 0 ? '#dc3545' : totalVarianceSD < 0 ? '#28a745' : '#6c757d';
            const sign = totalVarianceSD > 0 ? '+' : '';
            varianceSDEl.textContent = sign + '$' + totalVarianceSD.toFixed(2);
            varianceSDEl.style.color = color;
          }

          if (varianceDiffEl) {
            const sign = difference > 0 ? '+' : '';
            varianceDiffEl.textContent = sign + '$' + difference.toFixed(2);
          }

          // Update balance status
          const hasData = sdData.some(e => e.nom || e.montant || e.montant_verifie);

          if (!hasData) {
            // No data yet
            if (balanceCardEl) balanceCardEl.style.borderLeftColor = '#6c757d';
            if (balanceIconEl) balanceIconEl.textContent = '‚ö™';
            if (balanceStatusEl) {
              balanceStatusEl.textContent = 'En attente...';
              balanceStatusEl.style.color = '#6c757d';
            }
            if (varianceDiffEl) varianceDiffEl.style.color = '#6c757d';
          } else if (Math.abs(difference) < 0.01 && Math.abs(totalVarianceSD) < 0.01) {
            // Perfect balance - no variance at all
            if (balanceCardEl) balanceCardEl.style.borderLeftColor = '#28a745';
            if (balanceIconEl) balanceIconEl.textContent = '‚úÖ';
            if (balanceStatusEl) {
              balanceStatusEl.textContent = '√âquilibr√©!';
              balanceStatusEl.style.color = '#28a745';
            }
            if (varianceDiffEl) varianceDiffEl.style.color = '#28a745';
          } else if (Math.abs(difference) < 0.01) {
            // All variances assigned to employees
            if (balanceCardEl) balanceCardEl.style.borderLeftColor = '#28a745';
            if (balanceIconEl) balanceIconEl.textContent = '‚úÖ';
            if (balanceStatusEl) {
              balanceStatusEl.textContent = 'Variances assign√©es';
              balanceStatusEl.style.color = '#28a745';
            }
            if (varianceDiffEl) varianceDiffEl.style.color = '#28a745';
          } else {
            // Unbalanced - some variance not assigned
            if (balanceCardEl) balanceCardEl.style.borderLeftColor = '#dc3545';
            if (balanceIconEl) balanceIconEl.textContent = '‚ùå';
            if (balanceStatusEl) {
              balanceStatusEl.textContent = 'Non assign√©!';
              balanceStatusEl.style.color = '#dc3545';
            }
            if (varianceDiffEl) varianceDiffEl.style.color = '#dc3545';
          }

          // Show warning for unmatched names
          if (unmatched.length > 0) {
            console.warn('Noms SD non reconnus dans SetD:', unmatched);
          }
        }

        // Generate dropdown options for SetD names, grouped by first letter
        function getSetDNamesOptions(selectedNom) {
          const names = Object.keys(SETD_PERSONNEL_COLUMNS).sort((a, b) =>
            a.toLowerCase().localeCompare(b.toLowerCase())
          );

          let html = '';
          let currentLetter = '';

          names.forEach(name => {
            const firstLetter = name.charAt(0).toUpperCase();
            if (firstLetter !== currentLetter) {
              if (currentLetter !== '') {
                html += '</optgroup>';
              }
              currentLetter = firstLetter;
              html += `<optgroup label="‚Äî ${firstLetter} ‚Äî">`;
            }
            const selected = name === selectedNom ? 'selected' : '';
            html += `<option value="${name}" ${selected}>${name}</option>`;
          });

          if (currentLetter !== '') {
            html += '</optgroup>';
          }

          return html;
        }

        // Populate the datalist with all SetD names
        function populateSetDNamesDatalist() {
          const datalist = document.getElementById('setd-names-datalist');
          if (!datalist) return;

          const names = Object.keys(SETD_PERSONNEL_COLUMNS).sort((a, b) =>
            a.toLowerCase().localeCompare(b.toLowerCase())
          );

          datalist.innerHTML = names.map(name => `<option value="${name}">`).join('');
        }

        // Filter and highlight as user types a name
        function filterSDName(entryId, input) {
          const value = input.value.trim();
          const statusEl = input.parentElement.querySelector('.sd-nom-status');

          if (!value) {
            if (statusEl) statusEl.innerHTML = '';
            input.style.borderColor = '';
            return;
          }

          // Check for exact match
          const names = Object.keys(SETD_PERSONNEL_COLUMNS);
          const exactMatch = names.find(n => n.toLowerCase() === value.toLowerCase());
          const partialMatches = names.filter(n => n.toLowerCase().includes(value.toLowerCase()));

          if (exactMatch) {
            // Exact match found
            if (statusEl) statusEl.innerHTML = '<span style="color: #28a745;">‚úì</span>';
            input.style.borderColor = '#28a745';
            // Auto-correct case if needed
            if (input.value !== exactMatch) {
              input.value = exactMatch;
            }
            updateSDEntry(entryId, 'nom', exactMatch);
          } else if (partialMatches.length > 0) {
            // Partial matches - show count
            if (statusEl) statusEl.innerHTML = `<span style="color: #ffc107; font-size: 0.65rem;">${partialMatches.length}</span>`;
            input.style.borderColor = '#ffc107';
          } else {
            // No match
            if (statusEl) statusEl.innerHTML = '<span style="color: #dc3545;">‚úó</span>';
            input.style.borderColor = '#dc3545';
          }
        }

        // Validate name when user leaves the field
        function validateSDName(entryId, input) {
          const value = input.value.trim();
          const statusEl = input.parentElement.querySelector('.sd-nom-status');

          if (!value) {
            updateSDEntry(entryId, 'nom', '');
            if (statusEl) statusEl.innerHTML = '';
            input.style.borderColor = '';
            return;
          }

          // Check for exact match (case-insensitive)
          const names = Object.keys(SETD_PERSONNEL_COLUMNS);
          const exactMatch = names.find(n => n.toLowerCase() === value.toLowerCase());

          if (exactMatch) {
            input.value = exactMatch;
            updateSDEntry(entryId, 'nom', exactMatch);
            if (statusEl) statusEl.innerHTML = '<span style="color: #28a745;">‚úì</span>';
            input.style.borderColor = '#28a745';
          } else {
            // Try to find closest match
            const closestMatches = names.filter(n =>
              n.toLowerCase().startsWith(value.toLowerCase()) ||
              n.toLowerCase().includes(value.toLowerCase())
            );

            if (closestMatches.length === 1) {
              // Only one match, auto-select it
              input.value = closestMatches[0];
              updateSDEntry(entryId, 'nom', closestMatches[0]);
              if (statusEl) statusEl.innerHTML = '<span style="color: #28a745;">‚úì</span>';
              input.style.borderColor = '#28a745';
            } else if (closestMatches.length > 1) {
              // Multiple matches - keep value but mark as warning
              updateSDEntry(entryId, 'nom', value);
              if (statusEl) statusEl.innerHTML = `<span style="color: #ffc107;" title="${closestMatches.slice(0,3).join(', ')}...">?</span>`;
              input.style.borderColor = '#ffc107';
            } else {
              // No match at all
              updateSDEntry(entryId, 'nom', value);
              if (statusEl) statusEl.innerHTML = '<span style="color: #dc3545;" title="Nom non reconnu dans SetD">‚úó</span>';
              input.style.borderColor = '#dc3545';
            }
          }
        }

        // Mapping of SD names to SetD columns (from SETD_PERSONNEL_COLUMNS)
        const SETD_PERSONNEL_COLUMNS = {
          'Martine Breton': 'C', 'Petite Caisse': 'E', 'Conc. Banc.': 'F', 'Corr. Mois suivant': 'G',
          'JEAN PHILIPPE': 'H', 'Tristan Tremblay': 'I', 'Mandy Le': 'J', 'Frederic Dupont': 'K',
          'Florence Roy': 'L', 'Marie Carlesso': 'M', 'Patrick Caron': 'N', 'KARL LECLERC': 'O',
          'St√©phane Latulippe': 'P', 'natalie rousseau': 'Q', 'DAVID GIORGI': 'R', 'YOUSSIF GANNI': 'S',
          'MYRLENE BELIVEAU': 'T', 'EMMANUELLE LUSSIER': 'U', 'DANIELLE BELANGER': 'V', 'VALERIE GUERIN': 'W',
          'Youri Georges': 'X', 'Alexandre Thifault': 'Y', 'Julie Dagenais': 'Z', 'PATRICK MARTEL': 'AA',
          'Nelson Dacosta': 'AB', 'NAOMIE COLIN': 'AC', 'SOPHIE CHIARUCCI': 'AD', 'CHRISTOS MORENTZOS': 'AE',
          'WOODS John': 'AF', 'MARCO Sabourin': 'AG', 'sachetti francois': 'AH', 'caouette Phillipe': 'AI',
          'Caron Patrick': 'AJ', 'MIXOLOGUE': 'AK', 'GIOVANNI TOMANELLI': 'AL', 'Mathieu Guerit': 'AN',
          'Marie Eve': 'AO', 'CARL Tourangeau': 'AP', 'MAUDE GAUTHIER': 'AQ', 'Stephane Bernachez': 'AR',
          'Jonathan Samedy': 'AS', 'NICOLAS Bernatchez': 'AT', 'JULIEN BAZAGLE': 'AU', 'Panayota Lappas': 'AV',
          'PLINIO TESTA Campos': 'AW', 'spiro Katsenis': 'AX', 'Isabelle Leclair': 'AY', 'ANAIS BESETTE': 'AZ',
          'DRAGAN MILOVIC': 'BA', 'LIDA RAMASAN': 'BB', 'RAFFI OYAN': 'BC', 'CECIL PATRICIA': 'BD',
          'QUENTIN BRUNET': 'BE', 'Sabrina Gagnon': 'BF', 'NOEMY ROY': 'BG', 'Melanie Guilemette': 'BH',
          'Pierre-luc Lapointe': 'BI', 'Adelaide Rancourt': 'BJ', 'theriault emilie': 'BK', 'Sandra Tremblay': 'BL',
          'DAVID DFAUCHER': 'BM', 'LINDA': 'BN', 'olivier lamothe': 'BO', 'gozzi alexandra': 'BP',
          'Sarah Vesnaver': 'BQ', 'Forget Caroline': 'BR', 'ANDREW STEPHANE': 'BS', 'Tremblay Caroline': 'BT',
          'jessica simon': 'BU', 'Francis Latour': 'BV', 'Constantino Difruschia': 'BW', 'Cuong Tran': 'BX',
          'MATHIEU GUERIT': 'BY', 'Youri George': 'BZ', 'Arnaud Duguay': 'CA', 'JOSE LATUPLIPPE': 'CB',
          'Mixologue 2.0': 'CC', 'MIXOLOGUE 3.0': 'CE', 'Dany Prouxl-Rivard': 'CF', 'JONNI LANGLOIS': 'CG',
          'Laurence': 'CH', 'Morgane Muffait': 'CI', 'NICOLE': 'CJ', 'VICTOR GUEFAELLY': 'CK',
          'Emma Heguy': 'CL', 'MANON RINGROSE': 'CM', 'lethicia heinmeyer': 'CN', 'Stephanie desjardins': 'CO',
          'Elisabetta Lungarini': 'CP', 'France bergeron': 'CR', 'kalena Caticchio': 'CS', 'Nicolle Blanchard': 'CT',
          'DRAGANA RADOVANOVIC': 'CU', 'elena kaltsoudas': 'CV', 'Jean-Seb. Pitre': 'CW', 'CHARLES R': 'CX',
          'Pier Audrey Belanger': 'CY', 'GINO MOURIN': 'CZ', 'Sophie c': 'DA', 'Philippe Caouette': 'DB',
          'Marly Innocent': 'DC', 'MOHAMED ELSABER': 'DD', 'SOULEYMANE CAMARA': 'DE', 'KHALIL MOUATARIF': 'DF',
          'MANOLO C': 'DG', 'Laeticia Nader': 'DH', 'Sylvie Pierre': 'DI', 'Debbie Fleurant-Rioux': 'DJ',
          'Debby Araujo': 'DK', 'Isabelle Caron': 'DL', 'Rose-Delande Mompremier': 'DM', 'ANGELO JOSEPH': 'DN',
          'ANNIE': 'DO', 'JEAN-MICHEL CYR': 'DP', 'damal Kelly': 'DQ', 'JESSICA SIMON': 'DR',
          'levesque MAUDE': 'DS', 'Jos√©e Latulippe': 'DT', 'SARAH MADITUKA': 'DU', 'LEO SCARPA': 'DV',
          'Schneidine': 'DX', 'thaneekan': 'DY', 'AYA BACHARI': 'DZ', 'SEDDIK ZAYEN': 'EA',
          'VALERIE KRAY': 'EB', 'sarah': 'EC', 'OPPONG ZANETA': 'ED', 'guylaine': 'EE',
          'pierre cindy': 'EF', 'Cristancho Natalia': 'EH', 'Durocher St√©phanie': 'EI'
        };

        // Get SD entries with non-zero variances for SetD export
        function getSDVariancesForSetD() {
          const variances = [];
          const unmatched = [];

          sdData.forEach(entry => {
            if (entry.nom && entry.variance !== 0) {
              const nom = entry.nom.trim();
              if (SETD_PERSONNEL_COLUMNS[nom]) {
                variances.push({
                  nom: nom,
                  variance: entry.variance,
                  column: SETD_PERSONNEL_COLUMNS[nom]
                });
              } else {
                unmatched.push(nom);
              }
            }
          });

          return { variances, unmatched };
        }

        // Update SetD export count indicator
        function updateSDSetDCount() {
          const { variances } = getSDVariancesForSetD();
          const countEl = document.getElementById('sd-setd-preview-count');
          if (countEl) {
            countEl.textContent = variances.length;
          }
        }

        // Show preview of variances to export to SetD
        function showSDSetDPreview() {
          const previewEl = document.getElementById('sd-setd-preview');
          const listEl = document.getElementById('sd-setd-preview-list');
          const unmatchedEl = document.getElementById('sd-setd-unmatched');
          const unmatchedNamesEl = document.getElementById('sd-setd-unmatched-names');

          const { variances, unmatched } = getSDVariancesForSetD();

          if (variances.length === 0 && unmatched.length === 0) {
            previewEl.style.display = 'block';
            listEl.innerHTML = '<div style="color: #6c757d; font-style: italic;">Aucune variance √† exporter (toutes les variances sont √† 0)</div>';
            unmatchedEl.style.display = 'none';
            return;
          }

          // Build preview list
          listEl.innerHTML = variances.map(v => {
            const color = v.variance > 0 ? '#dc3545' : '#28a745';
            const sign = v.variance > 0 ? '+' : '';
            return `
              <div style="background: white; padding: 0.5rem 0.75rem; border-radius: 4px; border-left: 3px solid ${color}; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 500; font-size: 0.85rem;">${v.nom}</span>
                <span style="font-weight: 700; color: ${color}; font-size: 0.9rem;">${sign}$${v.variance.toFixed(2)}</span>
              </div>
            `;
          }).join('');

          // Show unmatched names if any
          if (unmatched.length > 0) {
            unmatchedNamesEl.textContent = unmatched.join(', ');
            unmatchedEl.style.display = 'block';
          } else {
            unmatchedEl.style.display = 'none';
          }

          previewEl.style.display = 'block';

          // Re-render feather icons
          if (typeof feather !== 'undefined') {
            feather.replace();
          }
        }

        // Export SD variances to SetD in RJ file
        async function exportSDToSetD() {
          const { variances, unmatched } = getSDVariancesForSetD();

          if (variances.length === 0) {
            notify('Aucune variance √† exporter vers SetD (toutes les variances sont √† 0 ou les noms ne correspondent pas)', 'warning');
            return;
          }

          // Get current day from SD day selector or DueBack day
          const sdDayInput = document.getElementById('sd-current-day');
          const duebackDay = document.getElementById('dueback-current-day');
          let day = sdDayInput ? parseInt(sdDayInput.value) : null;

          if (!day && duebackDay) {
            day = parseInt(duebackDay.textContent);
          }

          if (!day || day < 1 || day > 31) {
            notify('Impossible de d√©terminer le jour. Veuillez charger un jour SD d\'abord.', 'error');
            return;
          }

          // Confirm with user
          const variancesList = variances.map(v => `${v.nom}: ${v.variance > 0 ? '+' : ''}$${v.variance.toFixed(2)}`).join('\n');
          const confirmMsg = `Exporter ${variances.length} variance(s) vers SetD pour le jour ${day}?\n\n${variancesList}`;

          if (!confirm(confirmMsg)) {
            return;
          }

          try {
            const res = await fetch('/api/sd/export_setd', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                day: day,
                variances: variances.map(v => ({ nom: v.nom, variance: v.variance }))
              })
            });

            const data = await res.json();

            if (data.success) {
              notify(data.message, 'success');

              // Show unmatched warning if any
              if (data.unmatched && data.unmatched.length > 0) {
                notify(`Noms non reconnus dans SetD: ${data.unmatched.join(', ')}`, 'warning');
              }
            } else {
              notify(`Erreur: ${data.error}`, 'error');
            }
          } catch (error) {
            console.error('Error exporting to SetD:', error);
            notify(`Erreur r√©seau: ${error.message}`, 'error');
          }
        }

        // Upload SD file
        async function uploadSDFile() {
          const fileInput = document.getElementById('sd-file-input');
          const file = fileInput.files[0];

          if (!file) {
            alert('Veuillez s√©lectionner un fichier SD');
            return;
          }

          const formData = new FormData();
          formData.append('sd_file', file);

          try {
            const res = await fetch('/api/sd/upload', {
              method: 'POST',
              body: formData
            });

            const data = await res.json();

            if (data.success) {
              // Show file info
              document.getElementById('sd-filename').textContent = data.file_info.filename;
              document.getElementById('sd-file-size').textContent = `Taille: ${(data.file_info.size / 1024).toFixed(2)} KB`;
              document.getElementById('sd-available-days').textContent = `Jours disponibles: ${data.file_info.available_days.join(', ')}`;
              document.getElementById('sd-file-info').style.display = 'block';
              document.getElementById('sd-day-selector').style.display = 'block';

              // Auto-load day 1
              document.getElementById('sd-current-day').value = 1;
              await loadSDDay();

              alert(data.message);
            } else {
              alert(`Erreur: ${data.error}`);
            }
          } catch (error) {
            console.error('Error uploading SD file:', error);
            alert(`Erreur r√©seau: ${error.message}`);
          }
        }

        // Load SD day data
        async function loadSDDay() {
          const dayInput = document.getElementById('sd-current-day');
          const day = parseInt(dayInput.value);

          if (!day || day < 1 || day > 31) {
            alert('Le jour doit √™tre entre 1 et 31');
            return;
          }

          try {
            const res = await fetch(`/api/sd/day/${day}`);
            const data = await res.json();

            if (data.success) {
              // Update day info
              document.getElementById('sd-day-date').textContent = data.data.date || '-';
              document.getElementById('sd-day-entries-count').textContent = data.data.entries.length;
              document.getElementById('sd-day-info').style.display = 'block';

              // Load entries into the table
              sdData = data.data.entries.map(entry => ({
                id: Date.now() + Math.random(),
                departement: entry.departement || '',
                nom: entry.nom || '',
                devise: entry.cdn_us || 'CDN',
                montant: entry.montant || 0,
                montant_verifie: entry.montant_verifie || 0,
                remboursement: entry.remboursement || 0,
                variance: entry.variance || 0
              }));

              renderSDTable();

              // Also fetch totals
              const totalsRes = await fetch(`/api/sd/day/${day}/totals`);
              const totalsData = await totalsRes.json();

              if (totalsData.success) {
                console.log('Totals for day', day, ':', totalsData.totals);
              }
            } else {
              alert(`Erreur: ${data.error}`);
            }
          } catch (error) {
            console.error('Error loading SD day:', error);
            alert(`Erreur r√©seau: ${error.message}`);
          }
        }

        // Download SD file
        async function downloadSDFile() {
          try {
            const res = await fetch('/api/sd/download');

            if (res.ok) {
              const blob = await res.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `SD_${new Date().toISOString().split('T')[0]}.xls`;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
            } else {
              const data = await res.json();
              alert(`Erreur: ${data.error}`);
            }
          } catch (error) {
            console.error('Error downloading SD file:', error);
            alert(`Erreur r√©seau: ${error.message}`);
          }
        }

        // Save SD data
        async function saveSD() {
          const dayInput = document.getElementById('sd-current-day');
          const day = parseInt(dayInput.value);

          if (!day || day < 1 || day > 31) {
            alert('Veuillez charger un jour avant de sauvegarder');
            return;
          }

          // Convert sdData to API format
          const entries = sdData.map(entry => ({
            departement: entry.departement || '',
            nom: entry.nom || '',
            cdn_us: entry.devise || 'CDN',
            montant: parseFloat(entry.montant) || 0,
            montant_verifie: parseFloat(entry.montant_verifie) || 0,
            remboursement: parseFloat(entry.remboursement) || 0,
            variance: parseFloat(entry.variance) || 0
          }));

          try {
            const res = await fetch(`/api/sd/day/${day}/entries`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ entries: entries })
            });

            const data = await res.json();

            if (data.success) {
              alert(data.message);
              // Reload the day to confirm the save
              await loadSDDay();
            } else {
              alert(`Erreur: ${data.error}`);
            }
          } catch (error) {
            console.error('Error saving SD data:', error);
            alert(`Erreur r√©seau: ${error.message}`);
          }
        }

        // ============================================================================
        // D√âP√îT - GESTION MULTI-ENTR√âES ET AUTO-CALCULS
        // ============================================================================

        // Storage for depot entries - each entry now has a date
        let depotData = {
          client6: [],  // { id, amount, date: "23 DECEMBRE" }
          client8: []
        };

        const DEPOT_MAX_DAYS = 7;  // Keep only 7 days of entries

        // Initialize with one empty row for each client
        function initializeDepot() {
          if (depotData.client6.length === 0) {
            addDepotRow('client6');
          }
          if (depotData.client8.length === 0) {
            addDepotRow('client8');
          }
        }

        // Get current date in format "DD MOIS"
        function getDepotDateString(date = new Date()) {
          const months = ['JANVIER', 'F√âVRIER', 'MARS', 'AVRIL', 'MAI', 'JUIN',
                          'JUILLET', 'AO√õT', 'SEPTEMBRE', 'OCTOBRE', 'NOVEMBRE', 'D√âCEMBRE'];
          return `${date.getDate()} ${months[date.getMonth()]}`;
        }

        // Parse a date string like "23 DECEMBRE" to a Date object (current year)
        function parseDepotDate(dateStr) {
          if (!dateStr) return null;
          const months = {
            'JANVIER': 0, 'F√âVRIER': 1, 'MARS': 2, 'AVRIL': 3, 'MAI': 4, 'JUIN': 5,
            'JUILLET': 6, 'AO√õT': 7, 'SEPTEMBRE': 8, 'OCTOBRE': 9, 'NOVEMBRE': 10, 'D√âCEMBRE': 11,
            'FEVRIER': 1, 'AOUT': 7, 'DECEMBRE': 11  // Without accents
          };
          const parts = dateStr.trim().toUpperCase().split(' ');
          if (parts.length < 2) return null;
          const day = parseInt(parts[0]);
          const month = months[parts[1]];
          if (isNaN(day) || month === undefined) return null;
          return new Date(new Date().getFullYear(), month, day);
        }

        // Get unique dates from a client's entries
        function getUniqueDatesForClient(clientId) {
          const dates = new Set();
          depotData[clientId].forEach(entry => {
            if (entry.date) dates.add(entry.date);
          });
          return Array.from(dates);
        }

        // Count unique days in a client
        function countUniqueDays(clientId) {
          return getUniqueDatesForClient(clientId).length;
        }

        // Get the client with more space (fewer unique days)
        function getClientWithMoreSpace() {
          const client6Days = countUniqueDays('client6');
          const client8Days = countUniqueDays('client8');

          // Return the one with fewer days, or client6 if equal
          return client6Days <= client8Days ? 'client6' : 'client8';
        }

        // Remove entries older than 7 days from a client
        function rotateOldEntries(clientId) {
          const uniqueDates = getUniqueDatesForClient(clientId);

          if (uniqueDates.length <= DEPOT_MAX_DAYS) {
            return 0;  // No rotation needed
          }

          // Sort dates (oldest first)
          const sortedDates = uniqueDates.sort((a, b) => {
            const dateA = parseDepotDate(a);
            const dateB = parseDepotDate(b);
            if (!dateA || !dateB) return 0;
            return dateA - dateB;
          });

          // Find dates to remove (oldest ones beyond 7 days)
          const datesToRemove = sortedDates.slice(0, sortedDates.length - DEPOT_MAX_DAYS);

          // Remove entries with those dates
          const originalCount = depotData[clientId].length;
          depotData[clientId] = depotData[clientId].filter(entry =>
            !datesToRemove.includes(entry.date)
          );

          const removedCount = originalCount - depotData[clientId].length;

          if (removedCount > 0) {
            console.log(`Rotation Depot: ${removedCount} entr√©es supprim√©es (dates: ${datesToRemove.join(', ')})`);
          }

          return removedCount;
        }

        // Rotate old entries from both clients
        function rotateAllOldEntries() {
          const removed6 = rotateOldEntries('client6');
          const removed8 = rotateOldEntries('client8');

          if (removed6 > 0) renderDepotTable('client6');
          if (removed8 > 0) renderDepotTable('client8');

          return removed6 + removed8;
        }

        // Update the live Depot preview in SD tab dashboard
        function updateLiveDepotPreview() {
          // Get current space for each client
          const client6Days = countUniqueDays('client6');
          const client8Days = countUniqueDays('client8');

          // Determine target client
          const targetClient = getClientWithMoreSpace();
          const targetLabel = targetClient === 'client6' ? 'Client 6' : 'Client 8';

          // Update target indicator
          const targetEl = document.getElementById('live-depot-target');
          if (targetEl) {
            targetEl.textContent = targetLabel;
            targetEl.style.color = targetClient === 'client6' ? '#007bff' : '#17a2b8';
          }

          // Update Client 6 progress bar
          const c6CountEl = document.getElementById('live-depot-c6-count');
          const c6BarEl = document.getElementById('live-depot-c6-bar');
          if (c6CountEl) {
            c6CountEl.textContent = `${client6Days}/7`;
            c6CountEl.style.color = client6Days >= 7 ? '#dc3545' : '#6c757d';
          }
          if (c6BarEl) {
            const c6Percent = Math.min((client6Days / 7) * 100, 100);
            c6BarEl.style.width = c6Percent + '%';
            c6BarEl.style.background = client6Days >= 7 ? '#dc3545' : '#007bff';
          }

          // Update Client 8 progress bar
          const c8CountEl = document.getElementById('live-depot-c8-count');
          const c8BarEl = document.getElementById('live-depot-c8-bar');
          if (c8CountEl) {
            c8CountEl.textContent = `${client8Days}/7`;
            c8CountEl.style.color = client8Days >= 7 ? '#dc3545' : '#6c757d';
          }
          if (c8BarEl) {
            const c8Percent = Math.min((client8Days / 7) * 100, 100);
            c8BarEl.style.width = c8Percent + '%';
            c8BarEl.style.background = client8Days >= 7 ? '#dc3545' : '#17a2b8';
          }

          // Update Client 6 entries list (Excel-style: DATE | MONTANTS | TOTAL)
          const c6EntriesEl = document.getElementById('live-depot-c6-entries');
          const c6TotalEl = document.getElementById('live-depot-c6-total');
          if (c6EntriesEl) {
            const c6Entries = depotData.client6.filter(e => e.amount > 0);
            if (c6Entries.length === 0) {
              c6EntriesEl.innerHTML = '<div style="color: #999; font-style: italic; text-align: center; font-size: 0.65rem;">Vide</div>';
            } else {
              // Group by date (Excel structure: Date once, then amounts, then total)
              const byDate = {};
              c6Entries.forEach(e => {
                const date = e.date || 'Sans date';
                if (!byDate[date]) byDate[date] = [];
                byDate[date].push(e.amount);
              });
              // Render Excel-style
              let html = '';
              Object.entries(byDate).forEach(([date, amounts]) => {
                const dayTotal = amounts.reduce((s, a) => s + a, 0);
                // Date row with first amount
                html += `<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; font-size: 0.6rem; background: #e3f2fd; padding: 0.1rem 0.2rem;">
                  <span style="color: #1565c0; font-weight: 600;">${date}</span>
                  <span style="text-align: right;">${amounts[0] ? '$' + amounts[0].toFixed(2) : ''}</span>
                  <span></span>
                </div>`;
                // Additional amounts (no date)
                for (let i = 1; i < amounts.length; i++) {
                  html += `<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; font-size: 0.6rem; padding: 0.1rem 0.2rem;">
                    <span></span>
                    <span style="text-align: right;">$${amounts[i].toFixed(2)}</span>
                    <span></span>
                  </div>`;
                }
                // Total row (in SIGNATURE column)
                html += `<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; font-size: 0.6rem; background: #fff8e1; padding: 0.1rem 0.2rem; border-bottom: 1px solid #ddd;">
                  <span></span>
                  <span></span>
                  <span style="text-align: right; font-weight: 700; color: #007bff;">$${dayTotal.toFixed(2)}</span>
                </div>`;
              });
              c6EntriesEl.innerHTML = html;
            }
            const c6Total = c6Entries.reduce((s, e) => s + e.amount, 0);
            if (c6TotalEl) c6TotalEl.textContent = '$' + c6Total.toFixed(2);
          }

          // Update Client 8 entries list (Excel-style)
          const c8EntriesEl = document.getElementById('live-depot-c8-entries');
          const c8TotalEl = document.getElementById('live-depot-c8-total');
          if (c8EntriesEl) {
            const c8Entries = depotData.client8.filter(e => e.amount > 0);
            if (c8Entries.length === 0) {
              c8EntriesEl.innerHTML = '<div style="color: #999; font-style: italic; text-align: center; font-size: 0.65rem;">Vide</div>';
            } else {
              // Group by date
              const byDate = {};
              c8Entries.forEach(e => {
                const date = e.date || 'Sans date';
                if (!byDate[date]) byDate[date] = [];
                byDate[date].push(e.amount);
              });
              // Render Excel-style
              let html = '';
              Object.entries(byDate).forEach(([date, amounts]) => {
                const dayTotal = amounts.reduce((s, a) => s + a, 0);
                // Date row with first amount
                html += `<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; font-size: 0.6rem; background: #e0f7fa; padding: 0.1rem 0.2rem;">
                  <span style="color: #00838f; font-weight: 600;">${date}</span>
                  <span style="text-align: right;">${amounts[0] ? '$' + amounts[0].toFixed(2) : ''}</span>
                  <span></span>
                </div>`;
                // Additional amounts
                for (let i = 1; i < amounts.length; i++) {
                  html += `<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; font-size: 0.6rem; padding: 0.1rem 0.2rem;">
                    <span></span>
                    <span style="text-align: right;">$${amounts[i].toFixed(2)}</span>
                    <span></span>
                  </div>`;
                }
                // Total row
                html += `<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; font-size: 0.6rem; background: #fff8e1; padding: 0.1rem 0.2rem; border-bottom: 1px solid #ddd;">
                  <span></span>
                  <span></span>
                  <span style="text-align: right; font-weight: 700; color: #17a2b8;">$${dayTotal.toFixed(2)}</span>
                </div>`;
              });
              c8EntriesEl.innerHTML = html;
            }
            const c8Total = c8Entries.reduce((s, e) => s + e.amount, 0);
            if (c8TotalEl) c8TotalEl.textContent = '$' + c8Total.toFixed(2);
          }

          // Show rotation warning if needed
          const rotationEl = document.getElementById('live-depot-rotation');
          if (rotationEl) {
            const targetDays = targetClient === 'client6' ? client6Days : client8Days;
            if (targetDays >= 7) {
              rotationEl.style.display = 'block';
            } else {
              rotationEl.style.display = 'none';
            }
          }
        }

        // Add a new deposit row for a specific client
        function addDepotRow(clientId) {
          const todayStr = getDepotDateString();
          const entry = {
            id: Date.now() + Math.random(),
            amount: 0,
            date: todayStr  // Track date for rotation
          };

          depotData[clientId].push(entry);
          renderDepotTable(clientId);

          // Focus on the new amount input
          setTimeout(() => {
            const tbody = document.getElementById(`depot-${clientId}-body`);
            const lastRow = tbody.lastElementChild;
            if (lastRow) {
              const amountInput = lastRow.querySelector('.depot-amount');
              if (amountInput) amountInput.focus();
            }
          }, 100);
        }
        
        // Remove a deposit row
        function removeDepotRow(clientId, entryId) {
          depotData[clientId] = depotData[clientId].filter(e => e.id !== entryId);
          renderDepotTable(clientId);
        }
        
        // Render the table for a specific client
        function renderDepotTable(clientId) {
          const tbody = document.getElementById(`depot-${clientId}-body`);
          const entries = depotData[clientId];
        
          tbody.innerHTML = '';
        
          entries.forEach((entry, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="excel-row-header">${index + 1}</td>
              <td class="excel-cell">
                <input type="number" step="0.01" class="excel-input depot-amount"
                       data-client="${clientId}" data-entry-id="${entry.id}"
                       value="${entry.amount || ''}" placeholder="0.00"
                       onchange="updateDepotEntry('${clientId}', ${entry.id}, 'amount', this.value)">
              </td>
              <td class="excel-cell" style="text-align:center;">
                <button onclick="removeDepotRow('${clientId}', ${entry.id})"
                        style="background:#dc3545; color:white; border:none; padding:0.25rem 0.5rem; border-radius:4px; cursor:pointer; font-size:0.75rem;"
                        title="Supprimer cette ligne">
                  <i data-feather="trash-2" style="width:14px; height:14px;"></i>
                </button>
              </td>
            `;
            tbody.appendChild(row);
          });
        
          // Re-render feather icons
          if (typeof feather !== 'undefined') {
            feather.replace();
          }
        
          calculateDepotTotals();
        }
        
        // Update a specific entry field
        function updateDepotEntry(clientId, entryId, field, value) {
          const entry = depotData[clientId].find(e => e.id === entryId);
          if (entry) {
            if (field === 'amount') {
              entry.amount = parseFloat(value) || 0;
            } else {
              entry[field] = value;
            }
            calculateDepotTotals();
          }
        }
        
        // Calculate totals for all clients
        function calculateDepotTotals() {
          // Calculate CLIENT 6 total
          const client6Total = depotData.client6.reduce((sum, entry) => sum + (parseFloat(entry.amount) || 0), 0);
          document.getElementById('depot-client6-total').value = client6Total.toFixed(2);

          // Calculate CLIENT 8 total
          const client8Total = depotData.client8.reduce((sum, entry) => sum + (parseFloat(entry.amount) || 0), 0);
          document.getElementById('depot-client8-total').value = client8Total.toFixed(2);

          // Calculate general total
          const generalTotal = client6Total + client8Total;
          document.getElementById('depot-total-general').value = generalTotal.toFixed(2);

          // Update validation indicator
          updateDepotSDValidation();

          // Update live preview in SD tab (if visible)
          if (typeof updateLiveDepotPreview === 'function') {
            updateLiveDepotPreview();
          }
        }

        // Update the SD preview in Depot tab
        function updateDepotSDPreview() {
          const sdTotalVerifie = parseFloat(document.getElementById('sd-total-verifie')?.value) || 0;
          const previewEl = document.getElementById('depot-sd-preview');
          if (previewEl) {
            previewEl.textContent = '$' + sdTotalVerifie.toFixed(2);
          }
        }

        // Update validation indicator comparing SD and Depot totals
        function updateDepotSDValidation() {
          const sdTotal = parseFloat(document.getElementById('sd-total-verifie')?.value) || 0;
          const depotTotal = parseFloat(document.getElementById('depot-total-general')?.value) || 0;
          const validationEl = document.getElementById('depot-sd-validation');

          if (!validationEl) return;

          const diff = Math.abs(sdTotal - depotTotal);

          if (sdTotal === 0 && depotTotal === 0) {
            validationEl.style.display = 'none';
            return;
          }

          validationEl.style.display = 'block';

          if (diff < 0.01) {
            validationEl.innerHTML = `
              <span style="color: #155724;">
                <i data-feather="check-circle" style="width:16px; height:16px; vertical-align:middle;"></i>
                Parfait! SD ($${sdTotal.toFixed(2)}) = D√©p√¥t ($${depotTotal.toFixed(2)})
              </span>`;
          } else {
            validationEl.innerHTML = `
              <span style="color: #721c24;">
                <i data-feather="alert-triangle" style="width:16px; height:16px; vertical-align:middle;"></i>
                Attention: SD ($${sdTotal.toFixed(2)}) ‚â† D√©p√¥t ($${depotTotal.toFixed(2)}) - Diff√©rence: $${diff.toFixed(2)}
              </span>`;
          }

          // Re-render feather icons
          if (typeof feather !== 'undefined') feather.replace();
        }

        // Fill Depot from SD "Montant V√©rifi√©" total
        function fillDepotFromSD() {
          const sdTotalVerifie = parseFloat(document.getElementById('sd-total-verifie')?.value) || 0;

          if (sdTotalVerifie <= 0) {
            notify('Le SD n\'a pas de Montant V√©rifi√© √† importer (total = $0.00)', 'error');
            return;
          }

          // Get today's date string
          const todayStr = getDepotDateString();

          // Choose the client with more space automatically
          const targetClient = getClientWithMoreSpace();
          const clientLabel = targetClient === 'client6' ? 'Client 6' : 'Client 8';

          // Perform rotation to ensure we stay within 7 days limit
          const rotatedCount = rotateOldEntries(targetClient);
          if (rotatedCount > 0) {
            notify(`Rotation automatique: ${rotatedCount} ancienne(s) entr√©e(s) supprim√©e(s) de ${clientLabel}`, 'info');
          }

          // Check if there's already an entry for today
          const todayEntries = depotData[targetClient].filter(e => e.date === todayStr);
          if (todayEntries.length > 0) {
            // Add to existing day
            const entry = {
              id: Date.now() + Math.random(),
              amount: sdTotalVerifie,
              date: todayStr
            };
            depotData[targetClient].push(entry);
          } else {
            // New day entry
            const entry = {
              id: Date.now() + Math.random(),
              amount: sdTotalVerifie,
              date: todayStr
            };
            depotData[targetClient].push(entry);
          }

          renderDepotTable(targetClient);

          // Auto-fill date field for this client
          const dateInput = document.getElementById(`depot-${targetClient}-date`);
          if (dateInput) {
            dateInput.value = todayStr;
          }

          // Show space status
          const client6Days = countUniqueDays('client6');
          const client8Days = countUniqueDays('client8');

          notify(`$${sdTotalVerifie.toFixed(2)} import√© vers ${clientLabel} (${todayStr}). Espace: Client 6 = ${client6Days}/7 jours, Client 8 = ${client8Days}/7 jours`, 'success');

          // Update validation
          updateDepotSDValidation();
        }

        // Save depot data
        async function saveDepot() {
          // Prepare data for backend
          const depotPayload = {
            date: document.getElementById('selected-date')?.textContent || new Date().toLocaleDateString('fr-CA'),
            client6: depotData.client6.filter(e => e.amount > 0),
            client8: depotData.client8.filter(e => e.amount > 0),
            totals: {
              client6: parseFloat(document.getElementById('depot-client6-total').value || 0),
              client8: parseFloat(document.getElementById('depot-client8-total').value || 0),
              general: parseFloat(document.getElementById('depot-total-general').value || 0)
            }
          };

          console.log('Saving depot data:', depotPayload);

          try {
            const res = await fetch('/api/rj/deposit', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(depotPayload)
            });

            const json = await res.json();
            if (json.success) {
              notify('D√©p√¥t enregistr√© avec succ√®s!', 'success');
            } else {
              notify(json.error || 'Erreur lors de l\'enregistrement du d√©p√¥t', 'error');
            }
          } catch (e) {
            console.error('Error saving depot:', e);
            notify('Erreur r√©seau lors de l\'enregistrement', 'error');
          }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
          populateSetDNamesDatalist();
          initializeSD();
          initializeDepot();
        });
        </script>

        <!-- Live Preview Section -->
        <div class="excel-preview-container" style="margin-top: 2rem;">
          <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i data-feather="eye"></i> Aper√ßu Excel - D√©p√¥t
          </h4>
          <div id="depot-preview-wrapper" style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
            <table id="depot-preview-table" class="excel-preview" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
              <tr><td style="text-align: center; padding: 2rem; color: #999;">Chargement de l'aper√ßu...</td></tr>
            </table>
          </div>
        </div>
          </div>
        </div>
      </div>
      <!-- END DEPOT TAB -->

      <!-- TRANSELECT TAB -->
      <div id="tab-transelect" class="rj-tab-content">
        <div class="rj-card">
          <div class="forms">
            <div class="form-tile">
          <h4>Transelect - R√©conciliation CC/Interac</h4>
          <p style="font-size:0.875rem; color:var(--text-secondary); margin-bottom:1.5rem;">
            Tableau interactif type Excel. VARIANCE doit √™tre proche de 0 (üü¢ vert = OK, üî¥ rouge = erreur).
          </p>

          <!-- MASTER BALANCE STATUS - PROMINENT DISPLAY -->
          <div id="master-balance-display" style="
            background: #f8f9fa;
            border: 3px solid #dee2e6;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
          ">
            <div style="font-size: 0.875rem; font-weight: 600; color: #6c757d; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
              BALANCE G√âN√âRALE TRANSELECT
            </div>
            <div id="master-balance-value" style="
              font-size: 2.5rem;
              font-weight: 700;
              margin: 0.5rem 0;
              font-family: 'Courier New', monospace;
            ">
              $0.00
            </div>
            <div style="display: flex; justify-content: center; gap: 2rem; margin-top: 1rem; font-size: 0.875rem;">
              <div>
                <span style="color: #6c757d; font-weight: 500;">Restaurant (Y14):</span>
                <span id="restaurant-variance-display" style="font-weight: 600; margin-left: 0.5rem;">$0.00</span>
              </div>
              <div>
                <span style="color: #6c757d; font-weight: 500;">R√©ception (Q25):</span>
                <span id="reception-variance-display" style="font-weight: 600; margin-left: 0.5rem;">$0.00</span>
              </div>
            </div>
            <div id="master-balance-message" style="
              margin-top: 1rem;
              font-size: 0.875rem;
              font-weight: 500;
            ">
              En attente de donn√©es...
            </div>
          </div>

          <!-- SECTION 1: RESTAURANT/BAR/BANQUET -->
          <h5 style="margin-top:2rem; margin-bottom:1rem; font-weight:600; color:var(--text);">Section 1: Restaurant/Bar/Banquet</h5>
        
          <div style="overflow-x: auto; margin-bottom: 1.5rem; border: 1px solid var(--border); border-radius: 8px;">
            <table id="transelect-restaurant-table" class="excel-table" style="width: 100%; border-collapse: collapse; min-width: 2400px;">
              <thead>
                <tr>
                  <th class="excel-header excel-row-header"></th>
                  <th class="excel-header">TYPE</th>
                  <!-- Terminaux (20 colonnes) -->
                  <th class="excel-header">BAR<br>B</th>
                  <th class="excel-header">BAR<br>C</th>
                  <th class="excel-header">BAR<br>D</th>
                  <th class="excel-header">SPESA<br>E</th>
                  <th class="excel-header">ROOM<br>F</th>
                  <th class="excel-header">EXTRA<br>G</th>
                  <th class="excel-header">EXTRA<br>H</th>
                  <th class="excel-header">EXTRA<br>I</th>
                  <th class="excel-header">Banquet<br>J</th>
                  <th class="excel-header">Banquet<br>K</th>
                  <th class="excel-header">Banquet<br>L</th>
                  <th class="excel-header">Banquet<br>M</th>
                  <th class="excel-header">Banquet<br>N</th>
                  <th class="excel-header">Banquet<br>O</th>
                  <th class="excel-header">Banquet<br>P</th>
                  <th class="excel-header">Banquet<br>Q</th>
                  <th class="excel-header">Banquet<br>R</th>
                  <th class="excel-header">Banquet<br>S</th>
                  <th class="excel-header">Banquet<br>T</th>
                  <th class="excel-header">Banquet<br>U</th>
                  <!-- Colonnes de calcul -->
                  <th class="excel-header">TOTAL 1<br>V</th>
                  <th class="excel-header">TOTAL 2<br>W</th>
                  <th class="excel-header">POSITOUCH<br>X</th>
                  <th class="excel-header" style="background:#fff3cd;">VARIANCE<br>Y</th>
                  <th class="excel-header">ESCOMPTE%<br>Z</th>
                  <th class="excel-header">$<br>AA</th>
                  <th class="excel-header">NET<br>AB</th>
                </tr>
              </thead>
              <tbody id="transelect-restaurant-body">
                <!-- Row 8: Num√©ros de Terminaux -->
                <tr>
                  <td class="excel-row-header">8</td>
                  <td class="excel-label"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="B8" value="701" readonly style="background:#f5f5f5;"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="C8" value="702" readonly style="background:#f5f5f5;"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="D8" value="703" readonly style="background:#f5f5f5;"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="E8" value="704" readonly style="background:#f5f5f5;"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="F8" value="705" readonly style="background:#f5f5f5;"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="G8" placeholder="Terminal"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="H8" placeholder="Terminal"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="I8" placeholder="Terminal"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="J8" placeholder="Terminal"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="K8" placeholder="Terminal"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="L8" placeholder="Terminal"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="M8" placeholder="Terminal"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="N8" placeholder="Terminal"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="O8" placeholder="Terminal"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="P8" placeholder="Terminal"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="Q8" placeholder="Terminal"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="R8" placeholder="Terminal"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="S8" placeholder="Terminal"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="T8" placeholder="Terminal"></td>
                  <td class="excel-cell"><input type="text" class="excel-input" data-cell="U8" placeholder="Terminal"></td>
                  <td class="excel-cell" colspan="7"></td>
                </tr>
        
                <!-- Row 9: D√âBIT -->
                <tr data-card-type="debit" data-row="9">
                  <td class="excel-row-header">9</td>
                  <td class="excel-label">D√âBIT</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="B9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="C9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="D9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="E9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="G9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="H9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="I9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="J9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="K9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="L9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="M9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="N9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="O9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="P9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="Q9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="R9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="S9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="T9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="U9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-total1" data-cell="V9" data-row="9" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-total2" data-cell="W9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-positouch" data-cell="X9" data-row="9" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-variance" data-cell="Y9" data-row="9" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-escompte-pct" data-cell="Z9" data-row="9" value="0" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-escompte-amt" data-cell="AA9" data-row="9" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-net" data-cell="AB9" data-row="9" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                </tr>
        
                <!-- Row 10: VISA -->
                <tr data-card-type="visa" data-row="10">
                  <td class="excel-row-header">10</td>
                  <td class="excel-label">VISA</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="B10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="C10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="D10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="E10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="F10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="G10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="H10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="I10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="J10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="K10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="L10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="M10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="N10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="O10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="P10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="Q10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="R10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="S10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="T10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="U10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-total1" data-cell="V10" data-row="10" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-total2" data-cell="W10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-positouch" data-cell="X10" data-row="10" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-variance" data-cell="Y10" data-row="10" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-escompte-pct" data-cell="Z10" data-row="10" value="0.02" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-escompte-amt" data-cell="AA10" data-row="10" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-net" data-cell="AB10" data-row="10" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                </tr>
        
                <!-- Row 11: MASTER -->
                <tr data-card-type="master" data-row="11">
                  <td class="excel-row-header">11</td>
                  <td class="excel-label">MASTER</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="B11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="C11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="D11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="E11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="G11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="H11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="I11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="J11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="K11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="L11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="M11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="N11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="O11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="P11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="Q11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="R11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="S11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="T11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="U11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-total1" data-cell="V11" data-row="11" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-total2" data-cell="W11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-positouch" data-cell="X11" data-row="11" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-variance" data-cell="Y11" data-row="11" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-escompte-pct" data-cell="Z11" data-row="11" value="0.01" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-escompte-amt" data-cell="AA11" data-row="11" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-net" data-cell="AB11" data-row="11" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                </tr>
        
                <!-- Row 12: DISCOVER -->
                <tr data-card-type="discover" data-row="12">
                  <td class="excel-row-header">12</td>
                  <td class="excel-label">DISCOVER</td>
                  <td class="excel-cell"></td>
                  <td class="excel-cell"></td>
                  <td class="excel-cell"></td>
                  <td class="excel-cell"></td>
                  <td class="excel-cell"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="G12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="H12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="I12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="J12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="K12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="L12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="M12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="N12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="O12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="P12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="Q12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="R12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="S12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="T12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="U12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-total1" data-cell="V12" data-row="12" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-total2" data-cell="W12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-positouch" data-cell="X12" data-row="12" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-variance" data-cell="Y12" data-row="12" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-escompte-pct" data-cell="Z12" data-row="12" value="0.03" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-escompte-amt" data-cell="AA12" data-row="12" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-net" data-cell="AB12" data-row="12" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                </tr>
        
                <!-- Row 13: AMEX -->
                <tr data-card-type="amex" data-row="13">
                  <td class="excel-row-header">13</td>
                  <td class="excel-label">AMEX</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="B13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="C13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="D13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="E13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="G13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="H13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="I13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="J13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="K13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="L13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="M13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="N13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="O13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="P13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="Q13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="R13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="S13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="T13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-terminal" data-cell="U13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-total1" data-cell="V13" data-row="13" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-total2" data-cell="W13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-positouch" data-cell="X13" data-row="13" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-variance" data-cell="Y13" data-row="13" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-escompte-pct" data-cell="Z13" data-row="13" value="0.03" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-escompte-amt" data-cell="AA13" data-row="13" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input transelect-net" data-cell="AB13" data-row="13" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                </tr>
        
                <!-- Row 14: TOTAL -->
                <tr style="font-weight:600; background:#f8f9fa;">
                  <td class="excel-row-header">14</td>
                  <td class="excel-label">TOTAL</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="B14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="C14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="D14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="E14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="F14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="G14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="H14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="I14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="J14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="K14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="L14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="M14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="N14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="O14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="P14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="Q14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="R14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="S14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="T14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="U14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="V14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="W14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="X14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="Y14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="AA14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="AB14" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                </tr>
              </tbody>
            </table>
          </div>
        
          <!-- SECTION 2: R√âCEPTION/CHAMBRES -->
          <h5 style="margin-top:2rem; margin-bottom:1rem; font-weight:600; color:var(--text);">Section 2: R√©ception/Chambres</h5>
        
          <div style="overflow-x: auto; margin-bottom: 1.5rem; border: 1px solid var(--border); border-radius: 8px;">
            <table id="transelect-reception-table" class="excel-table" style="width: 100%; border-collapse: collapse; min-width: 1200px;">
              <thead>
                <tr>
                  <th class="excel-header excel-row-header"></th>
                  <th class="excel-header">TYPE</th>
                  <th class="excel-header">FreedomPay<br>B</th>
                  <th class="excel-header">Terminal 8<br>C</th>
                  <th class="excel-header">Terminal K053<br>D</th>
                  <th class="excel-header">TOTAL<br>I</th>
                  <th class="excel-header">Daily Rev<br>P</th>
                  <th class="excel-header" style="background:#fff3cd;">VARIANCE<br>Q</th>
                  <th class="excel-header">ESCOMPTE%<br>R</th>
                  <th class="excel-header">$<br>S</th>
                  <th class="excel-header">NET GEAC<br>T</th>
                  <th class="excel-header" style="background:#fff3cd;">MASTER BAL<br>X</th>
                </tr>
              </thead>
              <tbody id="transelect-reception-body">
                <!-- Row 20: D√âBIT -->
                <tr data-card-type="debit" data-row="20">
                  <td class="excel-row-header">20</td>
                  <td class="excel-label">D√âBIT</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-terminal" data-cell="B20" data-row="20" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-terminal" data-cell="C20" data-row="20" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-terminal" data-cell="D20" data-row="20" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-total" data-cell="I20" data-row="20" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-daily-rev" data-cell="P20" data-row="20" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-variance" data-cell="Q20" data-row="20" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-escompte-pct" data-cell="R20" data-row="20" value="0" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-escompte-amt" data-cell="S20" data-row="20" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-net" data-cell="T20" data-row="20" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-master-balance" data-cell="X20" data-row="20" placeholder="0.00" readonly style="background:#f0f0f0; font-weight:600;"></td>
                </tr>

                <!-- Row 21: VISA -->
                <tr data-card-type="visa" data-row="21">
                  <td class="excel-row-header">21</td>
                  <td class="excel-label">VISA</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-terminal" data-cell="B21" data-row="21" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-terminal" data-cell="C21" data-row="21" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-terminal" data-cell="D21" data-row="21" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-total" data-cell="I21" data-row="21" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-daily-rev" data-cell="P21" data-row="21" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-variance" data-cell="Q21" data-row="21" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-escompte-pct" data-cell="R21" data-row="21" value="0.02" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-escompte-amt" data-cell="S21" data-row="21" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-net" data-cell="T21" data-row="21" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-col-x" data-cell="X21" data-row="21" placeholder="0.00"></td>
                </tr>

                <!-- Row 22: MASTER -->
                <tr data-card-type="master" data-row="22">
                  <td class="excel-row-header">22</td>
                  <td class="excel-label">MASTER</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-terminal" data-cell="B22" data-row="22" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-terminal" data-cell="C22" data-row="22" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-terminal" data-cell="D22" data-row="22" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-total" data-cell="I22" data-row="22" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-daily-rev" data-cell="P22" data-row="22" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-variance" data-cell="Q22" data-row="22" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-escompte-pct" data-cell="R22" data-row="22" value="0.01" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-escompte-amt" data-cell="S22" data-row="22" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-net" data-cell="T22" data-row="22" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-col-x" data-cell="X22" data-row="22" placeholder="0.00"></td>
                </tr>

                <!-- Row 23: DISCOVER (Note: fichier RJ n'a pas de row 23, skip to 24 AMEX) -->
        
                <!-- Row 24: AMEX -->
                <tr data-card-type="amex" data-row="24">
                  <td class="excel-row-header">24</td>
                  <td class="excel-label">AMEX</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-terminal" data-cell="B24" data-row="24" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-terminal" data-cell="C24" data-row="24" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-terminal" data-cell="D24" data-row="24" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-total" data-cell="I24" data-row="24" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-daily-rev" data-cell="P24" data-row="24" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-variance" data-cell="Q24" data-row="24" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-escompte-pct" data-cell="R24" data-row="24" value="0.03" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-escompte-amt" data-cell="S24" data-row="24" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-net" data-cell="T24" data-row="24" placeholder="0.00" readonly style="background:#f0f0f0;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input reception-col-x" data-cell="X24" data-row="24" placeholder="0.00"></td>
                </tr>

                <!-- Row 25: TOTAL -->
                <tr style="font-weight:600; background:#f8f9fa;">
                  <td class="excel-row-header">25</td>
                  <td class="excel-label">TOTAL</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="B25" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="C25" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="D25" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="I25" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="P25" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="Q25" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="S25" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="T25" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input" data-cell="X25" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                </tr>
              </tbody>
            </table>
          </div>
        
          <div class="form-actions">
            <button class="rj-btn" onclick="saveTranselect()">
              <i data-feather="save"></i> Enregistrer Transelect
            </button>
          </div>
        </div>
        
        <script>
        // ============================================================================
        // TRANSELECT AUTO-CALCULATIONS
        // ============================================================================
        
        // Section 1: Restaurant - Calculate TOTAL 1 (sum of terminals)
        function calculateRestaurantTotal1(row) {
          const terminalCols = ['B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U'];
          let sum = 0;
        
          terminalCols.forEach(col => {
            const val = parseFloat(document.querySelector(`[data-cell="${col}${row}"]`)?.value || 0);
            sum += val;
          });
        
          const total1Input = document.querySelector(`[data-cell="V${row}"]`);
          if (total1Input) {
            total1Input.value = sum.toFixed(2);
          }
        
          return sum;
        }
        
        // Section 1: Restaurant - Calculate VARIANCE with visual validation
        function calculateRestaurantVariance(row) {
          const total1 = parseFloat(document.querySelector(`[data-cell="V${row}"]`)?.value || 0);
          const total2 = parseFloat(document.querySelector(`[data-cell="W${row}"]`)?.value || 0);
          const positouch = parseFloat(document.querySelector(`[data-cell="X${row}"]`)?.value || 0);
        
          // VARIANCE = (TOTAL1 + TOTAL2) - POSITOUCH
          const variance = (total1 + total2) - positouch;
        
          const varianceInput = document.querySelector(`[data-cell="Y${row}"]`);
          if (varianceInput) {
            varianceInput.value = variance.toFixed(2);
        
            // Visual validation
            if (Math.abs(variance) < 0.01) {
              // Balance! Green
              varianceInput.style.backgroundColor = '#d4edda';
              varianceInput.style.color = '#155724';
              varianceInput.style.fontWeight = '600';
            } else {
              // Ne balance pas! Red
              varianceInput.style.backgroundColor = '#f8d7da';
              varianceInput.style.color = '#721c24';
              varianceInput.style.fontWeight = '600';
            }
          }
        
          return variance;
        }
        
        // Section 1: Restaurant - Calculate $ Escompte and NET
        function calculateRestaurantEscompteAndNet(row) {
          const total1 = parseFloat(document.querySelector(`[data-cell="V${row}"]`)?.value || 0);
          const total2 = parseFloat(document.querySelector(`[data-cell="W${row}"]`)?.value || 0);
          const totalAmount = total1 + total2;
        
          const escomptePct = parseFloat(document.querySelector(`[data-cell="Z${row}"]`)?.value || 0);
        
          // $ escompte = Total √ó (Taux / 100)
          const escompteAmt = totalAmount * (escomptePct / 100);
        
          const escompteInput = document.querySelector(`[data-cell="AA${row}"]`);
          if (escompteInput) {
            escompteInput.value = escompteAmt.toFixed(2);
          }
        
          // NET = Total - $ escompte
          const net = totalAmount - escompteAmt;
        
          const netInput = document.querySelector(`[data-cell="AB${row}"]`);
          if (netInput) {
            netInput.value = net.toFixed(2);
          }
        }
        
        // Section 1: Restaurant - Recalculate all for one row
        function recalculateRestaurantRow(row) {
          calculateRestaurantTotal1(row);
          calculateRestaurantVariance(row);
          calculateRestaurantEscompteAndNet(row);
          calculateRestaurantTotals(); // Update row 14 totals
        }
        
        // Section 1: Restaurant - Calculate row 14 totals
        function calculateRestaurantTotals() {
          const rows = [9, 10, 11, 12, 13];
          const cols = ['B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'AA', 'AB'];
        
          cols.forEach(col => {
            if (col === 'Z') return; // Skip escompte %
        
            let sum = 0;
            rows.forEach(row => {
              const val = parseFloat(document.querySelector(`[data-cell="${col}${row}"]`)?.value || 0);
              sum += val;
            });
        
            const totalInput = document.querySelector(`[data-cell="${col}14"]`);
            if (totalInput) {
              totalInput.value = sum.toFixed(2);
            }
          });

          // After updating Y14, recalculate master balance
          calculateMasterBalance();
        }
        
        // Section 2: Reception - Calculate TOTAL (sum of terminals)
        function calculateReceptionTotal(row) {
          const b = parseFloat(document.querySelector(`[data-cell="B${row}"]`)?.value || 0);
          const c = parseFloat(document.querySelector(`[data-cell="C${row}"]`)?.value || 0);
          const d = parseFloat(document.querySelector(`[data-cell="D${row}"]`)?.value || 0);
        
          const total = b + c + d;
        
          const totalInput = document.querySelector(`[data-cell="I${row}"]`);
          if (totalInput) {
            totalInput.value = total.toFixed(2);
          }
        
          return total;
        }
        
        // Section 2: Reception - Calculate VARIANCE with visual validation
        function calculateReceptionVariance(row) {
          const total = parseFloat(document.querySelector(`[data-cell="I${row}"]`)?.value || 0);
          const dailyRev = parseFloat(document.querySelector(`[data-cell="P${row}"]`)?.value || 0);
        
          // VARIANCE = TOTAL - Daily Revenue (MUST be 0!)
          const variance = total - dailyRev;
        
          const varianceInput = document.querySelector(`[data-cell="Q${row}"]`);
          if (varianceInput) {
            varianceInput.value = variance.toFixed(2);
        
            // Visual validation
            if (Math.abs(variance) < 0.01) {
              // Balance! Green
              varianceInput.style.backgroundColor = '#d4edda';
              varianceInput.style.color = '#155724';
              varianceInput.style.fontWeight = '600';
            } else {
              // ERREUR! Red
              varianceInput.style.backgroundColor = '#f8d7da';
              varianceInput.style.color = '#721c24';
              varianceInput.style.fontWeight = '600';
            }
          }
        
          return variance;
        }
        
        // Section 2: Reception - Calculate $ Escompte and NET GEAC
        function calculateReceptionEscompteAndNet(row) {
          const total = parseFloat(document.querySelector(`[data-cell="I${row}"]`)?.value || 0);
          const escomptePct = parseFloat(document.querySelector(`[data-cell="R${row}"]`)?.value || 0);
        
          // $ escompte = Total √ó (Taux / 100)
          const escompteAmt = total * (escomptePct / 100);
        
          const escompteInput = document.querySelector(`[data-cell="S${row}"]`);
          if (escompteInput) {
            escompteInput.value = escompteAmt.toFixed(2);
          }
        
          // NET GEAC = Total - $ escompte
          const net = total - escompteAmt;
        
          const netInput = document.querySelector(`[data-cell="T${row}"]`);
          if (netInput) {
            netInput.value = net.toFixed(2);
          }
        }
        
        // Section 2: Reception - Recalculate all for one row
        function recalculateReceptionRow(row) {
          calculateReceptionTotal(row);
          calculateReceptionVariance(row);
          calculateReceptionEscompteAndNet(row);
          calculateReceptionTotals(); // Update row 25 totals
        }
        
        // Section 2: Reception - Calculate row 25 totals
        function calculateReceptionTotals() {
          const rows = [20, 21, 22, 24]; // Note: no row 23
          const cols = ['B', 'C', 'D', 'I', 'P', 'Q', 'S', 'T'];

          cols.forEach(col => {
            let sum = 0;
            rows.forEach(row => {
              const val = parseFloat(document.querySelector(`[data-cell="${col}${row}"]`)?.value || 0);
              sum += val;
            });

            const totalInput = document.querySelector(`[data-cell="${col}25"]`);
            if (totalInput) {
              totalInput.value = sum.toFixed(2);
            }
          });

          // After updating Q25, recalculate master balance
          calculateMasterBalance();
        }

        // MASTER BALANCE: X20 = Q25 + Y14 (Restaurant VARIANCE + R√©ception VARIANCE)
        function calculateMasterBalance() {
          const y14 = parseFloat(document.querySelector('[data-cell="Y14"]')?.value || 0);  // Restaurant TOTAL VARIANCE
          const q25 = parseFloat(document.querySelector('[data-cell="Q25"]')?.value || 0);  // R√©ception TOTAL VARIANCE

          // MASTER BALANCE = Restaurant VARIANCE + R√©ception VARIANCE
          const masterBalance = q25 + y14;

          // Update X20 cell in the table
          const masterBalanceInput = document.querySelector('[data-cell="X20"]');
          if (masterBalanceInput) {
            masterBalanceInput.value = masterBalance.toFixed(2);

            // Visual feedback - CRITICAL BALANCING INDICATOR
            if (Math.abs(masterBalance) < 0.01) {
              // PERFECT BALANCE! Green
              masterBalanceInput.style.backgroundColor = '#d4edda';
              masterBalanceInput.style.color = '#155724';
              masterBalanceInput.style.fontWeight = '700';
              masterBalanceInput.style.border = '2px solid #28a745';
            } else if (Math.abs(masterBalance) < 10) {
              // Small variance - Yellow
              masterBalanceInput.style.backgroundColor = '#fff3cd';
              masterBalanceInput.style.color = '#856404';
              masterBalanceInput.style.fontWeight = '700';
              masterBalanceInput.style.border = '2px solid #ffc107';
            } else {
              // Large variance - Red
              masterBalanceInput.style.backgroundColor = '#f8d7da';
              masterBalanceInput.style.color = '#721c24';
              masterBalanceInput.style.fontWeight = '700';
              masterBalanceInput.style.border = '2px solid #dc3545';
            }
          }

          // UPDATE PROMINENT DISPLAY AT TOP
          const displayBox = document.getElementById('master-balance-display');
          const valueDisplay = document.getElementById('master-balance-value');
          const messageDisplay = document.getElementById('master-balance-message');
          const restaurantDisplay = document.getElementById('restaurant-variance-display');
          const receptionDisplay = document.getElementById('reception-variance-display');

          if (valueDisplay) {
            valueDisplay.textContent = '$' + masterBalance.toFixed(2);
          }

          if (restaurantDisplay) {
            restaurantDisplay.textContent = '$' + y14.toFixed(2);
            restaurantDisplay.style.color = Math.abs(y14) < 0.01 ? '#28a745' : '#dc3545';
          }

          if (receptionDisplay) {
            receptionDisplay.textContent = '$' + q25.toFixed(2);
            receptionDisplay.style.color = Math.abs(q25) < 0.01 ? '#28a745' : '#dc3545';
          }

          // Color-code the entire display box
          if (displayBox && valueDisplay && messageDisplay) {
            if (Math.abs(masterBalance) < 0.01) {
              // PERFECT BALANCE! Green
              displayBox.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
              displayBox.style.borderColor = '#28a745';
              valueDisplay.style.color = '#155724';
              messageDisplay.textContent = '‚úÖ TRANSELECT PARFAITEMENT BALANC√â!';
              messageDisplay.style.color = '#155724';
            } else if (Math.abs(masterBalance) < 10) {
              // Small variance - Yellow
              displayBox.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%)';
              displayBox.style.borderColor = '#ffc107';
              valueDisplay.style.color = '#856404';
              messageDisplay.textContent = '‚ö†Ô∏è Petite variance - V√©rifier les entr√©es';
              messageDisplay.style.color = '#856404';
            } else {
              // Large variance - Red
              displayBox.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
              displayBox.style.borderColor = '#dc3545';
              valueDisplay.style.color = '#721c24';
              messageDisplay.textContent = '‚ùå VARIANCE IMPORTANTE - R√©vision requise!';
              messageDisplay.style.color = '#721c24';
            }
          }

          return masterBalance;
        }

        // Event Listeners - Restaurant Section
        document.addEventListener('DOMContentLoaded', () => {
          // Restaurant terminal inputs
          document.querySelectorAll('.transelect-terminal').forEach(input => {
            input.addEventListener('input', function() {
              const row = parseInt(this.dataset.row);
              recalculateRestaurantRow(row);
            });
          });
        
          // Restaurant total2, positouch, escompte% inputs
          document.querySelectorAll('.transelect-total2, .transelect-positouch, .transelect-escompte-pct').forEach(input => {
            input.addEventListener('input', function() {
              const row = parseInt(this.dataset.row);
              recalculateRestaurantRow(row);
            });
          });
        
          // Reception terminal inputs
          document.querySelectorAll('.reception-terminal').forEach(input => {
            input.addEventListener('input', function() {
              const row = parseInt(this.dataset.row);
              recalculateReceptionRow(row);
            });
          });
        
          // Reception daily revenue and escompte% inputs
          document.querySelectorAll('.reception-daily-rev, .reception-escompte-pct').forEach(input => {
            input.addEventListener('input', function() {
              const row = parseInt(this.dataset.row);
              recalculateReceptionRow(row);
            });
          });
        
          // Excel-like navigation
          setTimeout(() => {
            setupExcelNavigation('#transelect-restaurant-table');
            setupExcelNavigation('#transelect-reception-table');
          }, 100);
        });
        </script>

        <!-- Live Preview Section -->
        <div class="excel-preview-container" style="margin-top: 2rem;">
          <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i data-feather="eye"></i> Aper√ßu Excel - Transelect
          </h4>
          <div id="transelect-preview-wrapper" style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
            <table id="transelect-preview-table" class="excel-preview" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
              <tr><td style="text-align: center; padding: 2rem; color: #999;">Chargement de l'aper√ßu...</td></tr>
            </table>
          </div>
        </div>
          </div>
        </div>
      </div>
      <!-- END TRANSELECT TAB -->

      <!-- GEAC TAB -->
      <div id="tab-geac" class="rj-tab-content">
        <div class="rj-card">
          <div class="forms">
            <div class="form-tile">
          <h4>GEAC / UX - R√©conciliation finale CC</h4>
          <p style="font-size:0.875rem; color:var(--text-secondary); margin-bottom:1.5rem;">
            VARIANCE doit √™tre = 0 (üü¢ vert = OK, üî¥ rouge = erreur). Si les montants ne sont pas √©gaux, v√©rifier Bank Interface Exceptions Report.
          </p>
        
          <!-- SECTION 1: DAILY CASH OUT VS DAILY REVENUE -->
          <h5 style="margin-top:2rem; margin-bottom:1rem; font-weight:600; color:var(--text);">Section 1: Daily Cash Out vs Daily Revenue</h5>
        
          <div style="overflow-x: auto; margin-bottom: 1.5rem; border: 1px solid var(--border); border-radius: 8px;">
            <table id="geac-reconciliation-table" class="excel-table" style="width: 100%; border-collapse: collapse; min-width: 900px;">
              <thead>
                <tr>
                  <th class="excel-header excel-row-header"></th>
                  <th class="excel-header">Description</th>
                  <th class="excel-header">AMEX<br>B</th>
                  <th class="excel-header">DINERS<br>E</th>
                  <th class="excel-header">MASTER<br>G</th>
                  <th class="excel-header">VISA<br>J</th>
                  <th class="excel-header">DISCOVER<br>K</th>
                </tr>
              </thead>
              <tbody id="geac-reconciliation-body">
                <!-- Row 6: Daily Cash Out -->
                <tr>
                  <td class="excel-row-header">6</td>
                  <td class="excel-label">Daily Cash Out</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-cash-out" data-cell="B6" data-card="amex" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-cash-out" data-cell="E6" data-card="diners" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-cash-out" data-cell="G6" data-card="master" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-cash-out" data-cell="J6" data-card="visa" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-cash-out" data-cell="K6" data-card="discover" placeholder="0.00"></td>
                </tr>
        
                <!-- Row 10: TOTAL -->
                <tr style="font-weight:600; background:#f8f9fa;">
                  <td class="excel-row-header">10</td>
                  <td class="excel-label">TOTAL</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-total" data-cell="B10" data-card="amex" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-total" data-cell="E10" data-card="diners" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-total" data-cell="G10" data-card="master" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-total" data-cell="J10" data-card="visa" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-total" data-cell="K10" data-card="discover" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                </tr>
        
                <!-- Row 12: Daily Revenue -->
                <tr>
                  <td class="excel-row-header">12</td>
                  <td class="excel-label">Daily Revenue</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-daily-rev" data-cell="B12" data-card="amex" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-daily-rev" data-cell="E12" data-card="diners" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-daily-rev" data-cell="G12" data-card="master" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-daily-rev" data-cell="J12" data-card="visa" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-daily-rev" data-cell="K12" data-card="discover" placeholder="0.00"></td>
                </tr>
        
                <!-- Row 13: VARIANCE (CRITIQUE!) -->
                <tr style="background:#fff3cd;">
                  <td class="excel-row-header">13</td>
                  <td class="excel-label" style="font-weight:600;">VARIANCE</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-variance" data-cell="B13" data-card="amex" placeholder="0.00" readonly style="background:#f0f0f0; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-variance" data-cell="E13" data-card="diners" placeholder="0.00" readonly style="background:#f0f0f0; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-variance" data-cell="G13" data-card="master" placeholder="0.00" readonly style="background:#f0f0f0; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-variance" data-cell="J13" data-card="visa" placeholder="0.00" readonly style="background:#f0f0f0; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-variance" data-cell="K13" data-card="discover" placeholder="0.00" readonly style="background:#f0f0f0; font-weight:600;"></td>
                </tr>
              </tbody>
            </table>
          </div>
        
          <div style="padding: 1rem; background: #fff3cd; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #ffc107;">
            <p style="margin: 0; font-size: 0.875rem; color: #856404;">
              ‚ö†Ô∏è <strong>Important:</strong> Si les montants ne sont pas √©gaux, v√©rifier Bank Interface Exceptions Report et Bank Night Audit Status Report.
              V√©rifier les settlement folios contre le Bank Transaction (BLT) Report.
            </p>
          </div>
        
          <!-- SECTION 2: GEAC/UX SYSTEM BALANCE SHEET -->
          <h5 style="margin-top:2rem; margin-bottom:1rem; font-weight:600; color:var(--text);">Section 2: GEAC/UX System Balance Sheet</h5>
        
          <div style="overflow-x: auto; margin-bottom: 1.5rem; border: 1px solid var(--border); border-radius: 8px;">
            <table id="geac-balance-table" class="excel-table" style="width: 100%; border-collapse: collapse; min-width: 700px;">
              <thead>
                <tr>
                  <th class="excel-header excel-row-header"></th>
                  <th class="excel-header">Description</th>
                  <th class="excel-header">Daily Revenue<br>(p.7)</th>
                  <th class="excel-header">Guest Ledger</th>
                  <th class="excel-header">VARIANCE</th>
                </tr>
              </thead>
              <tbody id="geac-balance-body">
                <!-- Row 32: Balance Previous Day -->
                <tr>
                  <td class="excel-row-header">32</td>
                  <td class="excel-label">Balance Previous Day</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-bal-prev-daily" data-cell="B32" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-bal-prev-ledger" data-cell="E32" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-bal-prev-variance" data-cell="F32" placeholder="0.00" readonly style="background:#f0f0f0; font-weight:600;"></td>
                </tr>
        
                <!-- Row 37: Balance Today -->
                <tr>
                  <td class="excel-row-header">37</td>
                  <td class="excel-label">Balance Today (Debit/Credit Activities)</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-bal-today-daily" data-cell="B37" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-bal-today-ledger" data-cell="E37" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-bal-today-variance" data-cell="F37" placeholder="0.00" readonly style="background:#f0f0f0; font-weight:600;"></td>
                </tr>
        
                <!-- Row 41: Facture Direct / Front Office Transfers -->
                <tr>
                  <td class="excel-row-header">41</td>
                  <td class="excel-label">Facture Direct / FO Transfers (p.6)</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-facture-daily" data-cell="B41" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-facture-ledger" data-cell="G41" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-facture-variance" data-cell="H41" placeholder="0.00" readonly style="background:#f0f0f0; font-weight:600;"></td>
                </tr>
        
                <!-- Row 44: Adv Deposit Applied -->
                <tr>
                  <td class="excel-row-header">44</td>
                  <td class="excel-label">Adv Deposit Applied (p.7)</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-adv-daily" data-cell="B44" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-adv-applied" data-cell="J44" placeholder="0.00"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-adv-variance" data-cell="K44" placeholder="0.00" readonly style="background:#f0f0f0; font-weight:600;"></td>
                </tr>
        
                <!-- Row 53: New Balance -->
                <tr style="font-weight:600; background:#f8f9fa;">
                  <td class="excel-row-header">53</td>
                  <td class="excel-label">New Balance (p.7)</td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-new-bal-daily" data-cell="B53" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-new-bal-ledger" data-cell="E53" placeholder="0.00" readonly style="background:#e9ecef; font-weight:600;"></td>
                  <td class="excel-cell"><input type="number" step="0.01" class="excel-input geac-new-bal-variance" data-cell="F53" placeholder="0.00" readonly style="background:#f0f0f0; font-weight:600;"></td>
                </tr>
              </tbody>
            </table>
          </div>
        
          <div class="form-actions">
            <button class="rj-btn" onclick="saveGeac()">
              <i data-feather="save"></i> Enregistrer GEAC
            </button>
          </div>
        </div>
        
        <script>
        // ============================================================================
        // GEAC/UX AUTO-CALCULATIONS
        // ============================================================================
        
        // Section 1: Calculate TOTAL for each card type
        function calculateGeacTotal(cardType) {
          const cashOutInput = document.querySelector(`[data-cell*="6"][data-card="${cardType}"]`);
          const totalInput = document.querySelector(`[data-cell*="10"][data-card="${cardType}"]`);
        
          if (cashOutInput && totalInput) {
            const cashOut = parseFloat(cashOutInput.value || 0);
            // For now, TOTAL = Daily Cash Out (may have other components in rows 7-9)
            totalInput.value = cashOut.toFixed(2);
          }
        }
        
        // Section 1: Calculate VARIANCE with visual validation (TOTAL vs Daily Revenue)
        function calculateGeacVariance(cardType) {
          const totalInput = document.querySelector(`[data-cell*="10"][data-card="${cardType}"]`);
          const dailyRevInput = document.querySelector(`[data-cell*="12"][data-card="${cardType}"]`);
          const varianceInput = document.querySelector(`[data-cell*="13"][data-card="${cardType}"]`);
        
          if (totalInput && dailyRevInput && varianceInput) {
            const total = parseFloat(totalInput.value || 0);
            const dailyRev = parseFloat(dailyRevInput.value || 0);
        
            // VARIANCE = TOTAL - Daily Revenue (MUST be 0!)
            const variance = total - dailyRev;
            varianceInput.value = variance.toFixed(2);
        
            // Visual validation
            if (Math.abs(variance) < 0.01) {
              // Balance! Green
              varianceInput.style.backgroundColor = '#d4edda';
              varianceInput.style.color = '#155724';
            } else {
              // ERREUR! Red
              varianceInput.style.backgroundColor = '#f8d7da';
              varianceInput.style.color = '#721c24';
            }
          }
        }
        
        // Section 1: Recalculate all card types
        function recalculateGeacReconciliation() {
          const cardTypes = ['amex', 'diners', 'master', 'visa', 'discover'];
          cardTypes.forEach(cardType => {
            calculateGeacTotal(cardType);
            calculateGeacVariance(cardType);
          });
        }
        
        // Section 2: Calculate Balance Sheet Variances
        function calculateBalancePrevVariance() {
          const daily = parseFloat(document.querySelector('[data-cell="B32"]')?.value || 0);
          const ledger = parseFloat(document.querySelector('[data-cell="E32"]')?.value || 0);
          const varianceInput = document.querySelector('[data-cell="F32"]');
        
          if (varianceInput) {
            const variance = daily - ledger;
            varianceInput.value = variance.toFixed(2);
        
            if (Math.abs(variance) < 0.01) {
              varianceInput.style.backgroundColor = '#d4edda';
              varianceInput.style.color = '#155724';
            } else {
              varianceInput.style.backgroundColor = '#f8d7da';
              varianceInput.style.color = '#721c24';
            }
          }
        }
        
        function calculateBalanceTodayVariance() {
          const daily = parseFloat(document.querySelector('[data-cell="B37"]')?.value || 0);
          const ledger = parseFloat(document.querySelector('[data-cell="E37"]')?.value || 0);
          const varianceInput = document.querySelector('[data-cell="F37"]');
        
          if (varianceInput) {
            const variance = daily - ledger;
            varianceInput.value = variance.toFixed(2);
        
            if (Math.abs(variance) < 0.01) {
              varianceInput.style.backgroundColor = '#d4edda';
              varianceInput.style.color = '#155724';
            } else {
              varianceInput.style.backgroundColor = '#f8d7da';
              varianceInput.style.color = '#721c24';
            }
          }
        }
        
        function calculateFactureVariance() {
          const daily = parseFloat(document.querySelector('[data-cell="B41"]')?.value || 0);
          const ledger = parseFloat(document.querySelector('[data-cell="G41"]')?.value || 0);
          const varianceInput = document.querySelector('[data-cell="H41"]');
        
          if (varianceInput) {
            const variance = daily - ledger;
            varianceInput.value = variance.toFixed(2);
        
            if (Math.abs(variance) < 0.01) {
              varianceInput.style.backgroundColor = '#d4edda';
              varianceInput.style.color = '#155724';
            } else {
              varianceInput.style.backgroundColor = '#f8d7da';
              varianceInput.style.color = '#721c24';
            }
          }
        }
        
        function calculateAdvDepositVariance() {
          const daily = parseFloat(document.querySelector('[data-cell="B44"]')?.value || 0);
          const applied = parseFloat(document.querySelector('[data-cell="J44"]')?.value || 0);
          const varianceInput = document.querySelector('[data-cell="K44"]');
        
          if (varianceInput) {
            const variance = daily - applied;
            varianceInput.value = variance.toFixed(2);
        
            if (Math.abs(variance) < 0.01) {
              varianceInput.style.backgroundColor = '#d4edda';
              varianceInput.style.color = '#155724';
            } else {
              varianceInput.style.backgroundColor = '#f8d7da';
              varianceInput.style.color = '#721c24';
            }
          }
        }
        
        function calculateNewBalance() {
          // New Balance = Balance Previous + Balance Today + Facture Direct + Adv Deposit Applied
          const balPrevDaily = parseFloat(document.querySelector('[data-cell="B32"]')?.value || 0);
          const balTodayDaily = parseFloat(document.querySelector('[data-cell="B37"]')?.value || 0);
          const factureDaily = parseFloat(document.querySelector('[data-cell="B41"]')?.value || 0);
          const advDaily = parseFloat(document.querySelector('[data-cell="B44"]')?.value || 0);
        
          const balPrevLedger = parseFloat(document.querySelector('[data-cell="E32"]')?.value || 0);
          const balTodayLedger = parseFloat(document.querySelector('[data-cell="E37"]')?.value || 0);
          const factureLedger = parseFloat(document.querySelector('[data-cell="G41"]')?.value || 0);
          const advApplied = parseFloat(document.querySelector('[data-cell="J44"]')?.value || 0);
        
          const newBalDaily = balPrevDaily + balTodayDaily + factureDaily + advDaily;
          const newBalLedger = balPrevLedger + balTodayLedger + factureLedger + advApplied;
        
          const dailyInput = document.querySelector('[data-cell="B53"]');
          const ledgerInput = document.querySelector('[data-cell="E53"]');
          const varianceInput = document.querySelector('[data-cell="F53"]');
        
          if (dailyInput) dailyInput.value = newBalDaily.toFixed(2);
          if (ledgerInput) ledgerInput.value = newBalLedger.toFixed(2);
        
          if (varianceInput) {
            const variance = newBalDaily - newBalLedger;
            varianceInput.value = variance.toFixed(2);
        
            if (Math.abs(variance) < 0.01) {
              varianceInput.style.backgroundColor = '#d4edda';
              varianceInput.style.color = '#155724';
            } else {
              varianceInput.style.backgroundColor = '#f8d7da';
              varianceInput.style.color = '#721c24';
            }
          }
        }
        
        function recalculateBalanceSheet() {
          calculateBalancePrevVariance();
          calculateBalanceTodayVariance();
          calculateFactureVariance();
          calculateAdvDepositVariance();
          calculateNewBalance();
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
          // Section 1: Cash Out and Daily Revenue inputs
          document.querySelectorAll('.geac-cash-out, .geac-daily-rev').forEach(input => {
            input.addEventListener('input', recalculateGeacReconciliation);
          });
        
          // Section 2: Balance Sheet inputs
          document.querySelectorAll('.geac-bal-prev-daily, .geac-bal-prev-ledger').forEach(input => {
            input.addEventListener('input', () => {
              calculateBalancePrevVariance();
              calculateNewBalance();
            });
          });
        
          document.querySelectorAll('.geac-bal-today-daily, .geac-bal-today-ledger').forEach(input => {
            input.addEventListener('input', () => {
              calculateBalanceTodayVariance();
              calculateNewBalance();
            });
          });
        
          document.querySelectorAll('.geac-facture-daily, .geac-facture-ledger').forEach(input => {
            input.addEventListener('input', () => {
              calculateFactureVariance();
              calculateNewBalance();
            });
          });
        
          document.querySelectorAll('.geac-adv-daily, .geac-adv-applied').forEach(input => {
            input.addEventListener('input', () => {
              calculateAdvDepositVariance();
              calculateNewBalance();
            });
          });
        
          // Excel-like navigation
          setTimeout(() => {
            setupExcelNavigation('#geac-reconciliation-table');
            setupExcelNavigation('#geac-balance-table');
          }, 100);
        });
        </script>

        <!-- Live Preview Section -->
        <div class="excel-preview-container" style="margin-top: 2rem;">
          <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i data-feather="eye"></i> Aper√ßu Excel - GEAC/UX
          </h4>
          <div id="geac-preview-wrapper" style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
            <table id="geac-preview-table" class="excel-preview" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
              <tr><td style="text-align: center; padding: 2rem; color: #999;">Chargement de l'aper√ßu...</td></tr>
            </table>
          </div>
        </div>
          </div>
        </div>
      </div>
      <!-- END GEAC TAB -->

    </div>
    <!-- END TABS CONTENT -->
  </div>
  <!-- END TABS CONTAINER -->
</div>
<div id="notification-container"></div>
{% endblock %}

{% block scripts %}
<script>
  feather.replace();

  // ============================================================================
  // TAB SWITCHING FUNCTIONALITY - FIXED VERSION
  // ============================================================================
  function switchRJTab(tabId) {
    console.log('Switching to tab:', tabId);
    
    // Hide all tab contents
    document.querySelectorAll('.rj-tab-content').forEach(tab => {
      tab.classList.remove('active');
      // Force hide with inline styles
      tab.style.display = 'none';
      tab.style.opacity = '0';
      tab.style.visibility = 'hidden';
    });

    // Remove active from all tab buttons
    document.querySelectorAll('.rj-tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });

    // Show selected tab
    const selectedTab = document.getElementById(`tab-${tabId}`);
    if (selectedTab) {
      selectedTab.classList.add('active');
      // Force show with inline styles and !important equivalent
      selectedTab.style.display = 'block';
      selectedTab.style.opacity = '1';
      selectedTab.style.visibility = 'visible';
      selectedTab.style.height = 'auto';
      
      // Scroll into view to ensure visibility
      selectedTab.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
      console.log('Tab displayed:', selectedTab.style.display, selectedTab.classList.contains('active'));
    } else {
      console.error('Tab not found: tab-' + tabId);
    }

    // Activate button
    document.querySelectorAll('.rj-tab-btn').forEach(btn => {
      if (btn.getAttribute('onclick')?.includes(`'${tabId}'`) || 
          btn.getAttribute('onclick')?.includes(`"${tabId}"`)) {
        btn.classList.add('active');
      }
    });

    // Save to localStorage
    localStorage.setItem('rj_current_tab', tabId);

    // Re-render feather icons
    if (typeof feather !== 'undefined') {
      feather.replace();
    }

    // Load existing data for the tab
    loadTabData(tabId);
  }

  // Pre-load existing data when switching tabs
  async function loadTabData(tabId) {
    try {
      // Check if RJ file is uploaded first
      const statusRes = await fetch('/api/rj/status');
      const status = await statusRes.json();
      if (!status.uploaded) {
        console.log('No RJ file uploaded, skipping data load');
        return;
      }

      switch(tabId) {
        case 'recap':
          await loadRecapData();
          break;
        case 'transelect':
          await loadTranselectData();
          break;
        case 'geac':
          await loadGeacData();
          break;
        case 'dueback':
          // DueBack already has its own loading logic
          break;
        case 'depot':
          // Update SD preview and validation when switching to Depot tab
          if (typeof updateDepotSDPreview === 'function') {
            updateDepotSDPreview();
          }
          if (typeof updateDepotSDValidation === 'function') {
            updateDepotSDValidation();
          }
          break;
      }
    } catch (e) {
      console.error('Error loading tab data:', e);
    }
  }

  // Load existing Recap data from Excel
  async function loadRecapData() {
    try {
      const res = await fetch('/api/rj/read/recap');
      const data = await res.json();

      if (data.success && data.data) {
        const recap = data.data;
        console.log('Loading recap data:', recap);

        // Map API fields to input fields
        const fieldMapping = {
          'comptant_lightspeed_lecture': 'B6',
          'comptant_positouch_lecture': 'B7',
          'cheque_payment_register_lecture': 'B8',
          'cheque_daily_revenu_lecture': 'B9',
          'remb_gratuite_lecture': 'B11',
          'remb_client_lecture': 'B12',
          'due_back_reception_lecture': 'B16',
          'due_back_nb_lecture': 'B17',
          'surplus_deficit_lecture': 'B19'
        };

        // Populate inputs
        for (const [apiField, cellRef] of Object.entries(fieldMapping)) {
          if (recap[apiField] !== undefined && recap[apiField] !== null && recap[apiField] !== 0) {
            const input = document.querySelector(`[data-cell="${cellRef}"]`);
            if (input) {
              input.value = recap[apiField];
            }
          }
        }

        // Trigger recalculation
        if (typeof recalculateRecap === 'function') {
          recalculateRecap();
        }

        console.log('Recap data loaded successfully');
      }
    } catch (e) {
      console.error('Error loading recap data:', e);
    }
  }

  // Load existing Transelect data from Excel
  async function loadTranselectData() {
    try {
      const res = await fetch('/api/rj/read/transelect');
      const data = await res.json();

      if (data.success && data.data) {
        console.log('Loading transelect data:', data.data);

        // Populate the inputs based on the data
        for (const [field, value] of Object.entries(data.data)) {
          if (value !== undefined && value !== null && value !== 0) {
            // Find matching input by field name pattern
            const input = document.querySelector(`#tab-transelect [data-field="${field}"]`);
            if (input) {
              input.value = value;
            }
          }
        }

        // Trigger recalculation
        if (typeof recalculateTranselect === 'function') {
          recalculateTranselect();
        }

        console.log('Transelect data loaded successfully');
      }
    } catch (e) {
      console.error('Error loading transelect data:', e);
    }
  }

  // Load existing GEAC data from Excel
  async function loadGeacData() {
    try {
      const res = await fetch('/api/rj/read/geac_ux');
      const data = await res.json();

      if (data.success && data.data) {
        console.log('Loading GEAC data:', data.data);

        // Populate the inputs based on the data
        for (const [field, value] of Object.entries(data.data)) {
          if (value !== undefined && value !== null && value !== 0) {
            const input = document.querySelector(`#tab-geac [data-field="${field}"]`);
            if (input) {
              input.value = value;
            }
          }
        }

        // Trigger recalculation
        if (typeof recalculateGeac === 'function') {
          recalculateGeac();
        }

        console.log('GEAC data loaded successfully');
      }
    } catch (e) {
      console.error('Error loading GEAC data:', e);
    }
  }

  // Restore last active tab on page load
  document.addEventListener('DOMContentLoaded', () => {
    const savedTab = localStorage.getItem('rj_current_tab');
    if (savedTab && document.getElementById(`tab-${savedTab}`)) {
      switchRJTab(savedTab);
    } else {
      // Default to dueback tab
      switchRJTab('dueback');
    }
    
    // Also check RJ status and initialize
    checkRJStatus();
  });

  function notify(msg, type='success') {
    const n = document.createElement('div');
    n.className = 'notification' + (type==='error' ? ' error' : type==='info' ? ' info' : '');

    let icon = 'check-circle';
    if (type === 'error') icon = 'alert-triangle';
    else if (type === 'info') icon = 'info';

    n.innerHTML = `<i data-feather="${icon}"></i> ${msg}`;
    document.getElementById('notification-container').appendChild(n);
    feather.replace();
    setTimeout(()=>n.remove(), 4000);
  }

  async function checkRJStatus() {
    try {
      const res = await fetch('/api/rj/status');
      const data = await res.json();
      const uploaded = data.uploaded;
      document.getElementById('stat-file').textContent = uploaded ? 'Charg√©' : 'Non charg√©';
      document.getElementById('stat-size').textContent = uploaded ? ((data.file_size/1024).toFixed(1)+' KB') : '-';
      document.getElementById('stat-action').textContent = data.updated_at || '-';
      if (uploaded && data.filename) {
        document.getElementById('rj-file-label').textContent = data.filename;
      } else {
        document.getElementById('rj-file-label').textContent = 'Aucun fichier s√©lectionn√©';
      }

      // Update DueBack current day display
      if (uploaded && data.current_day) {
        const dayElem = document.getElementById('dueback-current-day');
        if (dayElem) {
          dayElem.textContent = data.current_day;
        }
      }
    } catch (e) { console.error(e); }
  }

  async function uploadRJFile() {
    const input = document.getElementById('rj-file-input');
    const file = input.files[0];
    if (!file) return;
    document.getElementById('rj-file-label').textContent = file.name;
    const fd = new FormData(); fd.append('rj_file', file);
    const res = await fetch('/api/rj/upload', { method:'POST', body: fd });
    const data = await res.json();
    if (data.success) {
      notify('Fichier RJ charg√©');
      checkRJStatus();
      // Load preview automatically after upload
      loadSheetPreview();
    }
    else notify(data.error || 'Erreur upload', 'error');
  }

  async function resetRJ() {
    const res = await fetch('/api/rj/reset', { method:'POST' });
    const data = await res.json();
    if (data.success) notify(data.message || 'Reset OK'); else notify(data.error || 'Erreur reset', 'error');
  }
  function downloadRJ() { window.open('/api/rj/download', '_blank'); }

  // ============================================================================
  // NOUVEAU JOUR - Control & Reset Functions
  // ============================================================================

  // Update controle sheet with new date
  async function updateControle() {
    const vjour = document.getElementById('controle-vjour').value;
    const mois = document.getElementById('controle-mois').value;
    const annee = document.getElementById('controle-annee').value;

    const statusEl = document.getElementById('nouveau-jour-status');

    try {
      const res = await fetch('/api/rj/controle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vjour, mois, annee })
      });

      const data = await res.json();

      if (data.success) {
        notify(data.message, 'success');
        showNouveauJourStatus('success', `‚úì Date mise √† jour: ${vjour}/${mois}/${annee}`);
        // Update displayed day in other tabs
        document.querySelectorAll('#dueback-current-day').forEach(el => el.textContent = vjour);
        checkRJStatus();
        // Refresh preview to show changes
        loadSheetPreview();
      } else {
        notify(data.error || 'Erreur', 'error');
        showNouveauJourStatus('error', data.error || 'Erreur lors de la mise √† jour');
      }
    } catch (err) {
      notify('Erreur r√©seau', 'error');
      showNouveauJourStatus('error', 'Erreur r√©seau: ' + err.message);
    }
  }

  // Reset a single sheet
  async function resetSheet(sheetName) {
    const friendlyNames = {
      'recap': 'Recap',
      'transelect': 'Transelect',
      'geac': 'GEAC',
      'depot': 'D√©p√¥t',
      'daily': 'Daily'
    };

    try {
      const res = await fetch(`/api/rj/reset/${sheetName}`, { method: 'POST' });
      const data = await res.json();

      if (data.success) {
        notify(`${friendlyNames[sheetName] || sheetName} effac√© (${data.cleared_count} cellules)`, 'success');
        showNouveauJourStatus('success', `‚úì ${friendlyNames[sheetName] || sheetName} effac√©`);
        // Refresh preview to show cleared state
        loadSheetPreview();
      } else {
        notify(data.error || 'Erreur', 'error');
        showNouveauJourStatus('error', data.error || 'Erreur');
      }
    } catch (err) {
      notify('Erreur r√©seau', 'error');
      showNouveauJourStatus('error', 'Erreur r√©seau: ' + err.message);
    }
  }

  // Reset ALL sheets
  async function resetAllSheets() {
    if (!confirm('√ätes-vous s√ªr de vouloir effacer TOUS les onglets (Recap, Transelect, GEAC, D√©p√¥t)?')) {
      return;
    }

    const sheets = ['recap', 'transelect', 'geac', 'depot'];
    let totalCleared = 0;
    let errors = [];

    showNouveauJourStatus('info', '‚è≥ Effacement en cours...');

    for (const sheet of sheets) {
      try {
        const res = await fetch(`/api/rj/reset/${sheet}`, { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          totalCleared += data.cleared_count || 0;
        } else {
          errors.push(`${sheet}: ${data.error}`);
        }
      } catch (err) {
        errors.push(`${sheet}: ${err.message}`);
      }
    }

    if (errors.length === 0) {
      notify(`Tous les onglets effac√©s (${totalCleared} cellules au total)`, 'success');
      showNouveauJourStatus('success', `‚úì Tous effac√©s: Recap, Transelect, GEAC, D√©p√¥t (${totalCleared} cellules)`);
    } else {
      notify(`Effacement partiel. Erreurs: ${errors.join(', ')}`, 'error');
      showNouveauJourStatus('error', `Erreurs: ${errors.join(', ')}`);
    }
    // Refresh preview to show changes
    loadSheetPreview();
  }

  // Helper to show status in Nouveau Jour tab
  function showNouveauJourStatus(type, message) {
    const statusEl = document.getElementById('nouveau-jour-status');
    if (!statusEl) return;

    const colors = {
      'success': { bg: '#d1fae5', border: '#10b981', text: '#065f46' },
      'error': { bg: '#fee2e2', border: '#ef4444', text: '#991b1b' },
      'info': { bg: '#dbeafe', border: '#3b82f6', text: '#1e40af' }
    };

    const c = colors[type] || colors.info;
    statusEl.style.display = 'block';
    statusEl.style.background = c.bg;
    statusEl.style.border = `1px solid ${c.border}`;
    statusEl.style.color = c.text;
    statusEl.innerHTML = message;

    // Auto-hide after 5 seconds for success
    if (type === 'success') {
      setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
    }
  }

  // ============================================================================
  // MACRO FUNCTIONS - VBA macro equivalents
  // ============================================================================

  // Execute envoie_dans_jour macro - Copy Recap H19:N19 to jour ar_[day]
  async function macroEnvoieDansJour() {
    showNouveauJourStatus('info', '‚è≥ Ex√©cution de "Envoie dans jour"...');

    try {
      const res = await fetch('/api/rj/macro/envoie-jour', { method: 'POST' });
      const data = await res.json();

      if (data.success) {
        notify(data.message, 'success');
        showNouveauJourStatus('success', `‚úì ${data.message}`);
        loadSheetPreview();
      } else {
        notify(data.error || 'Erreur', 'error');
        showNouveauJourStatus('error', data.error || 'Erreur lors de l\'ex√©cution');
      }
    } catch (err) {
      notify('Erreur r√©seau', 'error');
      showNouveauJourStatus('error', 'Erreur r√©seau: ' + err.message);
    }
  }

  // Execute calcul_carte macro - Copy transelect totals to jour CC_[day]
  async function macroCalculCarte() {
    showNouveauJourStatus('info', '‚è≥ Ex√©cution de "Calcul Carte"...');

    try {
      const res = await fetch('/api/rj/macro/calcul-carte', { method: 'POST' });
      const data = await res.json();

      if (data.success) {
        notify(data.message, 'success');
        showNouveauJourStatus('success', `‚úì ${data.message}`);
        loadSheetPreview();
      } else {
        notify(data.error || 'Erreur', 'error');
        showNouveauJourStatus('error', data.error || 'Erreur lors de l\'ex√©cution');
      }
    } catch (err) {
      notify('Erreur r√©seau', 'error');
      showNouveauJourStatus('error', 'Erreur r√©seau: ' + err.message);
    }
  }

  // Execute both macros in sequence
  async function macroExecuteAll() {
    if (!confirm('Ex√©cuter les deux macros (Envoie Recap + Calcul Cartes)?')) {
      return;
    }

    showNouveauJourStatus('info', '‚è≥ Ex√©cution des macros...');

    let results = [];
    let errors = [];

    // 1. Envoie dans jour
    try {
      const res1 = await fetch('/api/rj/macro/envoie-jour', { method: 'POST' });
      const data1 = await res1.json();
      if (data1.success) {
        results.push(`Recap: jour ${data1.data?.day}`);
      } else {
        errors.push(`Recap: ${data1.error}`);
      }
    } catch (err) {
      errors.push(`Recap: ${err.message}`);
    }

    // 2. Calcul carte
    try {
      const res2 = await fetch('/api/rj/macro/calcul-carte', { method: 'POST' });
      const data2 = await res2.json();
      if (data2.success) {
        results.push(`Cartes: jour ${data2.data?.day}`);
      } else {
        errors.push(`Cartes: ${data2.error}`);
      }
    } catch (err) {
      errors.push(`Cartes: ${err.message}`);
    }

    // Show results
    if (errors.length === 0) {
      notify(`Toutes les macros ex√©cut√©es avec succ√®s`, 'success');
      showNouveauJourStatus('success', `‚úì Macros ex√©cut√©es: ${results.join(', ')}`);
    } else {
      notify(`Ex√©cution partielle. Erreurs: ${errors.join(', ')}`, 'error');
      showNouveauJourStatus('error', `Erreurs: ${errors.join(', ')}`);
    }

    loadSheetPreview();
  }

  // ============================================================================
  // EXCEL PREVIEW - Live sheet preview functionality
  // ============================================================================

  // Load and display a sheet preview
  async function loadSheetPreview() {
    const sheetSelector = document.getElementById('preview-sheet-selector');
    const sheetName = sheetSelector ? sheetSelector.value : 'controle';

    const loadingEl = document.getElementById('excel-preview-loading');
    const tableEl = document.getElementById('excel-preview-table');
    const headerEl = document.getElementById('excel-preview-header');
    const bodyEl = document.getElementById('excel-preview-body');
    const infoEl = document.getElementById('excel-preview-info');

    if (!tableEl || !headerEl || !bodyEl) return;

    // Show loading
    if (loadingEl) {
      loadingEl.innerHTML = '<i data-feather="loader" style="width: 32px; height: 32px; animation: spin 1s linear infinite;"></i><p style="margin: 0.5rem 0 0 0;">Chargement de ' + sheetName + '...</p>';
      loadingEl.style.display = 'block';
    }
    tableEl.style.display = 'none';

    try {
      // Determine row range based on sheet
      let startRow = 0, endRow = 50, startCol = 0, endCol = 15;

      if (sheetName === 'controle') {
        endRow = 35;
        endCol = 5;
      } else if (sheetName === 'Recap') {
        startRow = 0;
        endRow = 25;
        endCol = 15;
      } else if (sheetName === 'transelect') {
        startRow = 0;
        endRow = 30;
        endCol = 25;
      } else if (sheetName === 'geac_ux') {
        startRow = 0;
        endRow = 60;
        endCol = 8;
      } else if (sheetName === 'depot') {
        startRow = 0;
        endRow = 45;
        endCol = 12;
      } else if (sheetName === 'DUBACK#') {
        startRow = 0;
        endRow = 10;
        endCol = 27;
      } else if (sheetName === 'rj') {
        startRow = 0;
        endRow = 80;
        endCol = 10;
      } else if (sheetName === 'jour') {
        startRow = 0;
        endRow = 50;
        endCol = 90;
      }

      const res = await fetch(`/api/rj/preview?sheet=${encodeURIComponent(sheetName)}&start_row=${startRow}&end_row=${endRow}&start_col=${startCol}&end_col=${endCol}`);
      const result = await res.json();

      if (result.error) {
        if (loadingEl) {
          loadingEl.innerHTML = '<i data-feather="alert-circle" style="width: 32px; height: 32px; color: #ef4444;"></i><p style="margin: 0.5rem 0 0 0; color: #ef4444;">' + result.error + '</p>';
        }
        if (typeof feather !== 'undefined') feather.replace();
        return;
      }

      // The API returns { data: { rows: [...], nrows, ncols, sheet_name } }
      const sheetData = result.data || {};
      const data = sheetData.rows || [];

      if (data.length === 0) {
        if (loadingEl) {
          loadingEl.innerHTML = '<i data-feather="file-text" style="width: 32px; height: 32px;"></i><p style="margin: 0.5rem 0 0 0;">Aucune donn√©e dans cette feuille</p>';
        }
        if (typeof feather !== 'undefined') feather.replace();
        return;
      }

      // Build header (column letters)
      const maxCols = Math.max(...data.map(row => row.length));
      let headerHtml = '<tr><th style="background: #4338ca; color: white; padding: 0.4rem 0.5rem; font-size: 0.7rem; position: sticky; top: 0; z-index: 10; border: 1px solid #6366f1;">#</th>';
      for (let c = 0; c < maxCols; c++) {
        const colLetter = getColLetter(startCol + c);
        headerHtml += `<th style="background: #4338ca; color: white; padding: 0.4rem 0.5rem; font-size: 0.7rem; position: sticky; top: 0; z-index: 10; border: 1px solid #6366f1; min-width: 60px;">${colLetter}</th>`;
      }
      headerHtml += '</tr>';
      headerEl.innerHTML = headerHtml;

      // Build body
      let bodyHtml = '';
      data.forEach((row, rowIdx) => {
        const actualRow = startRow + rowIdx + 1; // Excel rows are 1-indexed
        bodyHtml += `<tr><td style="background: #e0e7ff; font-weight: 600; padding: 0.3rem 0.5rem; font-size: 0.7rem; border: 1px solid #c7d2fe; text-align: center;">${actualRow}</td>`;
        for (let c = 0; c < maxCols; c++) {
          const cellValue = row[c] !== undefined && row[c] !== null && row[c] !== '' ? row[c] : '';
          const displayValue = formatCellValue(cellValue);
          const cellStyle = getCellStyle(cellValue, sheetName, actualRow, startCol + c);
          bodyHtml += `<td style="${cellStyle}">${displayValue}</td>`;
        }
        bodyHtml += '</tr>';
      });
      bodyEl.innerHTML = bodyHtml;

      // Hide loading, show table
      if (loadingEl) loadingEl.style.display = 'none';
      tableEl.style.display = 'table';

      // If controle sheet, show quick info
      if (sheetName === 'controle' && infoEl) {
        updateControleQuickInfo(data, startRow);
      } else if (infoEl) {
        infoEl.style.display = 'none';
      }

      if (typeof feather !== 'undefined') feather.replace();

    } catch (err) {
      console.error('Preview error:', err);
      if (loadingEl) {
        loadingEl.innerHTML = '<i data-feather="wifi-off" style="width: 32px; height: 32px; color: #ef4444;"></i><p style="margin: 0.5rem 0 0 0; color: #ef4444;">Erreur r√©seau: ' + err.message + '</p>';
      }
      if (typeof feather !== 'undefined') feather.replace();
    }
  }

  // Convert column index to Excel letter (0=A, 1=B, etc.)
  function getColLetter(colIdx) {
    let letter = '';
    let idx = colIdx;
    while (idx >= 0) {
      letter = String.fromCharCode(65 + (idx % 26)) + letter;
      idx = Math.floor(idx / 26) - 1;
    }
    return letter;
  }

  // Format cell value for display
  function formatCellValue(value) {
    if (value === null || value === undefined || value === '') return '';
    if (typeof value === 'number') {
      // Check if it looks like a date (Excel serial number > 30000)
      if (value > 30000 && value < 60000) {
        // Convert Excel date serial to date
        const date = new Date((value - 25569) * 86400 * 1000);
        if (!isNaN(date.getTime())) {
          return date.toLocaleDateString('fr-CA');
        }
      }
      // Format as number with 2 decimals if it has decimals
      if (value % 1 !== 0) {
        return value.toFixed(2);
      }
      return value.toString();
    }
    return String(value);
  }

  // Get cell style based on content and position
  function getCellStyle(value, sheetName, row, col) {
    let style = 'padding: 0.3rem 0.5rem; font-size: 0.7rem; border: 1px solid #e5e7eb; ';

    // Highlight cells with values
    if (value !== null && value !== undefined && value !== '') {
      if (typeof value === 'number') {
        style += 'background: #fef3c7; text-align: right; ';
        if (value < 0) {
          style += 'color: #dc2626; ';
        }
      } else if (typeof value === 'string' && value.startsWith('=')) {
        style += 'background: #dbeafe; font-family: monospace; font-size: 0.65rem; color: #1e40af; ';
      } else {
        style += 'background: #f0fdf4; ';
      }
    } else {
      style += 'background: #fafafa; ';
    }

    return style;
  }

  // Update controle quick info display
  function updateControleQuickInfo(data, startRow) {
    const infoEl = document.getElementById('excel-preview-info');
    if (!infoEl) return;

    // controle structure: B3=vjour, B4=mois, B5=annee, B28=idate
    const vjour = data[2] && data[2][1] !== undefined ? data[2][1] : '-';
    const mois = data[3] && data[3][1] !== undefined ? data[3][1] : '-';
    const annee = data[4] && data[4][1] !== undefined ? data[4][1] : '-';
    const idate = data[27] && data[27][1] !== undefined ? formatCellValue(data[27][1]) : '-';

    document.getElementById('preview-vjour').textContent = vjour;
    document.getElementById('preview-mois').textContent = mois;
    document.getElementById('preview-annee').textContent = annee;
    document.getElementById('preview-idate').textContent = idate;

    infoEl.style.display = 'block';
  }

  // Refresh controle preview (alias for loadSheetPreview)
  function refreshControlePreview() {
    loadSheetPreview();
  }

  // Initialize Nouveau Jour date selectors with current date
  document.addEventListener('DOMContentLoaded', () => {
    const now = new Date();
    const vjour = document.getElementById('controle-vjour');
    const mois = document.getElementById('controle-mois');
    const annee = document.getElementById('controle-annee');

    if (vjour) vjour.value = now.getDate();
    if (mois) mois.value = now.getMonth() + 1;
    if (annee) annee.value = now.getFullYear();
  });

  // NEW DUEBACK - Simple table-based entry system

  // All 24 receptionists with their column mappings
  const ALL_RECEPTIONISTS = [
    { lastName: 'Araujo', firstName: 'Debby', col: 'C' },
    { lastName: 'Latulippe', firstName: 'Jos√©e', col: 'D' },
    { lastName: 'Caron', firstName: 'Isabelle', col: 'E' },
    { lastName: 'Nader', firstName: 'Laeticia', col: 'F' },
    { lastName: 'Mompremier', firstName: 'Rose-Delande', col: 'G' },
    { lastName: 'oppong', firstName: 'zaneta', col: 'H' },
    { lastName: 'SEDDIK', firstName: 'ZAYEN', col: 'I' },
    { lastName: 'Kimberly', firstName: 'Tavarez', col: 'J' },
    { lastName: 'AYA', firstName: 'BACHIRI', col: 'K' },
    { lastName: 'Leo', firstName: 'Scarpa', col: 'L' },
    { lastName: 'THANKARAJAH', firstName: 'THANEEKAN', col: 'M' },
    { lastName: 'CINDY', firstName: 'PIERRE', col: 'N' },
    { lastName: 'Manolo', firstName: 'Cabrera', col: 'O' },
    { lastName: 'MOUATARIF', firstName: 'KHALIL', col: 'P' },
    { lastName: 'KRAY', firstName: 'VALERIE', col: 'Q' },
    { lastName: 'NITHYA', firstName: 'SAY', col: 'R' },
    { lastName: 'DAMAL', firstName: 'Kelly', col: 'S' },
    { lastName: 'MAUDE', firstName: 'LEVESQUE', col: 'T' },
    { lastName: 'OLGA', firstName: 'ARHANTOU', col: 'U' },
    { lastName: 'Sylvie', firstName: 'Pierre', col: 'V' },
    { lastName: 'Emery', firstName: 'Uwimana', col: 'W' },
    { lastName: 'Ben mansour', firstName: 'Ramzi', col: 'X' },
    { lastName: 'ANNIE-LIS', firstName: 'KASPERIAN', col: 'Y' },
    { lastName: 'Total', firstName: '', col: 'Z' }
  ];

  // ==============================================================================
  // DUEBACK - Select and add entry system
  // ==============================================================================

  let duebackEntries = [];  // List of added entries

  // Initialize DueBack dropdown
  function initializeDuebackDropdown() {
    const select = document.getElementById('dueback-receptionist-select');
    if (!select) return;

    // Clear and populate dropdown with all receptionists except Total
    select.innerHTML = '<option value="">-- S√©lectionner --</option>';

    const receptionists = ALL_RECEPTIONISTS.slice(0, -1); // Skip "Total" at end
    receptionists.forEach(recep => {
      const option = document.createElement('option');
      option.value = recep.col;
      option.textContent = `${recep.lastName} ${recep.firstName}`;
      select.appendChild(option);
    });
  }

  // Add entry to list
  function addDuebackEntry() {
    const select = document.getElementById('dueback-receptionist-select');
    const previousInput = document.getElementById('dueback-previous-input');
    const currentInput = document.getElementById('dueback-current-input');

    const col = select.value;
    const previous = parseFloat(previousInput.value) || 0;
    const current = parseFloat(currentInput.value) || 0;

    if (!col) {
      notify('Veuillez s√©lectionner un r√©ceptionniste', 'error');
      return;
    }

    if (previous === 0 && current === 0) {
      notify('Veuillez entrer au moins un montant', 'error');
      return;
    }

    // Find receptionist info
    const recep = ALL_RECEPTIONISTS.find(r => r.col === col);
    if (!recep) return;

    // Check if already exists
    const existingIndex = duebackEntries.findIndex(e => e.col === col);
    if (existingIndex >= 0) {
      // Update existing
      duebackEntries[existingIndex] = {
        col: col,
        lastName: recep.lastName,
        firstName: recep.firstName,
        previous: previous,
        current: current
      };
      notify('Entr√©e mise √† jour', 'success');
    } else {
      // Add new
      duebackEntries.push({
        col: col,
        lastName: recep.lastName,
        firstName: recep.firstName,
        previous: previous,
        current: current
      });
      notify('Entr√©e ajout√©e', 'success');
    }

    // Clear form
    select.value = '';
    previousInput.value = '';
    currentInput.value = '';
    select.focus();

    // Re-render list
    renderDuebackEntries();
  }

  // Remove entry from list
  function removeDuebackEntry(col) {
    duebackEntries = duebackEntries.filter(e => e.col !== col);
    renderDuebackEntries();
    notify('Entr√©e supprim√©e', 'success');
  }

  // Render entries list
  function renderDuebackEntries() {
    const container = document.getElementById('dueback-entries-container');
    const list = document.getElementById('dueback-entries-list');
    const count = document.getElementById('dueback-entries-count');

    if (duebackEntries.length === 0) {
      container.style.display = 'none';
      document.getElementById('dueback-totals-display').style.display = 'none';
      return;
    }

    container.style.display = 'block';
    count.textContent = duebackEntries.length;

    list.innerHTML = duebackEntries.map((entry, index) => {
      // Calculate net: Previous (negative) + Current (positive)
      const previousNegative = -Math.abs(entry.previous);
      const net = previousNegative + entry.current;

      const netColor = Math.abs(net) < 0.01 ? '#10b981' : (net < 0 ? '#ef4444' : '#3b82f6');
      const netBg = Math.abs(net) < 0.01 ? 'rgba(16, 185, 129, 0.1)' : (net < 0 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(59, 130, 246, 0.1)');

      return `
        <div style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
                    border: 2px solid #e2e8f0;
                    border-radius: 16px;
                    padding: 1.25rem;
                    display: grid;
                    grid-template-columns: 2fr 1fr 1fr 1fr auto;
                    gap: 1.25rem;
                    align-items: center;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
                    transition: all 0.3s ease;
                    position: relative;
                    overflow: hidden;"
             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(59, 130, 246, 0.15)'; this.style.borderColor='#3b82f6';"
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.05)'; this.style.borderColor='#e2e8f0';">

          <div style="position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: #3b82f6;"></div>

          <div style="padding-left: 0.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
              <div style="background: #3b82f6; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.75rem;">
                ${entry.col}
              </div>
              <div style="font-weight: 700; font-size: 1.063rem; color: #1e293b;">${entry.lastName} ${entry.firstName}</div>
            </div>
            <div style="font-size: 0.75rem; color: #64748b; margin-left: 2.25rem;">Colonne ${entry.col}</div>
          </div>

          <div style="background: rgba(239, 68, 68, 0.08); border-radius: 12px; padding: 0.75rem; text-align: center;">
            <div style="font-size: 0.688rem; color: #ef4444; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.375rem;">
              <i data-feather="arrow-down" style="width: 12px; height: 12px; vertical-align: middle;"></i> Previous
            </div>
            <div style="font-weight: 700; color: #dc2626; font-size: 1.125rem; font-family: 'Courier New', monospace;">${formatCurrency(-Math.abs(entry.previous))}</div>
          </div>

          <div style="background: rgba(16, 185, 129, 0.08); border-radius: 12px; padding: 0.75rem; text-align: center;">
            <div style="font-size: 0.688rem; color: #10b981; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.375rem;">
              <i data-feather="arrow-up" style="width: 12px; height: 12px; vertical-align: middle;"></i> Current
            </div>
            <div style="font-weight: 700; color: #059669; font-size: 1.125rem; font-family: 'Courier New', monospace;">${formatCurrency(entry.current)}</div>
          </div>

          <div style="background: ${netBg}; border-radius: 12px; padding: 0.75rem; text-align: center; border: 2px solid ${netColor};">
            <div style="font-size: 0.688rem; color: ${netColor}; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.375rem;">
              <i data-feather="dollar-sign" style="width: 12px; height: 12px; vertical-align: middle;"></i> Net
            </div>
            <div style="font-weight: 900; font-size: 1.25rem; color: ${netColor}; font-family: 'Courier New', monospace;">${formatCurrency(net)}</div>
          </div>

          <button onclick="removeDuebackEntry('${entry.col}')"
                  style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                         color: white;
                         border: none;
                         padding: 0.625rem;
                         border-radius: 10px;
                         cursor: pointer;
                         transition: all 0.3s ease;
                         box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
                         display: flex;
                         align-items: center;
                         justify-content: center;"
                  onmouseover="this.style.transform='scale(1.1) rotate(90deg)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.5)';"
                  onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.3)';">
            <i data-feather="trash-2" style="width: 18px; height: 18px;"></i>
          </button>
        </div>
      `;
    }).join('');

    // Update totals
    calculateDuebackTotals();

    // Re-render feather icons
    feather.replace();
  }

  // Calculate totals
  // Global variable to store Column B previous value for Column Z calculation
  let columnBPrevious = 0;

  // Fetch Column B (R/J) from RJ file - READ ONLY from 'jour' sheet
  async function fetchDuebackColumnB() {
    try {
      const response = await fetch('/api/rj/dueback/column-b');
      const result = await response.json();

      if (result.success) {
        const { previous, current, net } = result.data;

        // Store Column B previous for Column Z calculation
        columnBPrevious = previous;

        // Update Column B display
        document.getElementById('dueback-total-b-previous').textContent = formatCurrency(previous);
        document.getElementById('dueback-total-b-current').textContent = formatCurrency(current);
        document.getElementById('dueback-total-b-net').textContent = formatCurrency(net);

        // Color code Column B Net box
        const netBBox = document.getElementById('dueback-total-b-net-box');
        const netBElem = document.getElementById('dueback-total-b-net');

        if (Math.abs(net) < 0.01) {
          // Perfect balance - green
          netBBox.style.background = '#f0fdf4';
          netBBox.style.borderColor = '#10b981';
          netBElem.style.color = '#065f46';
        } else if (net < 0) {
          // Negative - red
          netBBox.style.background = '#fef2f2';
          netBBox.style.borderColor = '#ef4444';
          netBElem.style.color = '#991b1b';
        } else {
          // Positive - blue
          netBBox.style.background = '#eff6ff';
          netBBox.style.borderColor = '#3b82f6';
          netBElem.style.color = '#1e3a8a';
        }

        // Recalculate Column Z after getting Column B
        updateColumnZ();

        // Update Excel preview with Column B value
        updateDuebackPreview();
      }
    } catch (error) {
      console.error('Error fetching Column B:', error);
    }
  }

  // Update Column Z display
  // Formula: Column Z = SUM(C:Y for both rows) + Column B (previous)
  function updateColumnZ() {
    let totalPrevious = 0;
    let totalCurrent = 0;

    duebackEntries.forEach(entry => {
      totalPrevious += -Math.abs(entry.previous);  // Previous as negative
      totalCurrent += entry.current;
    });

    // Column Z formula: =SUM(C45:Y46)+B45
    // This means: Sum of all receptionist entries (both rows) + Column B previous
    const columnZNet = totalPrevious + totalCurrent + columnBPrevious;

    // Update Column Z totals
    document.getElementById('dueback-total-previous').textContent = formatCurrency(totalPrevious);
    document.getElementById('dueback-total-current').textContent = formatCurrency(totalCurrent);
    document.getElementById('dueback-total-net').textContent = formatCurrency(columnZNet);

    // Color code Column Z Net box
    const netZBox = document.getElementById('dueback-total-z-net-box');
    const netZElem = document.getElementById('dueback-total-net');

    if (Math.abs(columnZNet) < 0.01) {
      // Perfect balance - green
      netZBox.style.background = '#f0fdf4';
      netZBox.style.borderColor = '#10b981';
      netZElem.style.color = '#065f46';
    } else if (columnZNet < 0) {
      // Negative - red
      netZBox.style.background = '#fef2f2';
      netZBox.style.borderColor = '#ef4444';
      netZElem.style.color = '#991b1b';
    } else {
      // Positive - blue (default)
      netZBox.style.background = '#eff6ff';
      netZBox.style.borderColor = '#3b82f6';
      netZElem.style.color = '#1e3a8a';
    }
  }

  // Calculate totals and fetch Column B
  function calculateDuebackTotals() {
    // Show totals display if we have entries
    const totalsDisplay = document.getElementById('dueback-totals-display');
    if (duebackEntries.length > 0) {
      totalsDisplay.style.display = 'block';

      // Fetch Column B from RJ file (read-only)
      // This will also trigger updateColumnZ() after fetching
      fetchDuebackColumnB();

      // Update Excel preview
      updateDuebackPreview();
    }
  }

  // Update DueBack Excel preview
  function updateDuebackPreview() {
    const previewContainer = document.getElementById('dueback-preview-container');
    const previewTable = document.getElementById('dueback-excel-preview');

    if (!previewContainer || !previewTable) return;

    // Show preview if we have entries
    if (duebackEntries.length > 0) {
      previewContainer.style.display = 'block';

      // Build Excel-style table
      let html = '<table style="width: 100%; border-collapse: collapse; font-family: monospace; font-size: 0.875rem;">';

      // Header row
      html += '<thead>';
      html += '<tr style="background: #1f2937; color: white;">';
      html += '<th style="padding: 0.75rem; text-align: center; border: 1px solid #4b5563; font-weight: 600;">Row</th>';
      html += '<th style="padding: 0.75rem; text-align: left; border: 1px solid #4b5563; font-weight: 600; background: #8b5cf6;">B (R/J)</th>';

      // Receptionist columns
      duebackEntries.forEach(entry => {
        html += `<th style="padding: 0.75rem; text-align: center; border: 1px solid #4b5563; font-weight: 600;">${entry.col}</th>`;
      });

      html += '<th style="padding: 0.75rem; text-align: left; border: 1px solid #4b5563; font-weight: 600; background: #3b82f6;">Z (Total)</th>';
      html += '</tr>';
      html += '</thead>';

      // Get current day
      const dayElem = document.getElementById('dueback-current-day');
      const currentDay = dayElem ? parseInt(dayElem.textContent) || 23 : 23;

      // Calculate row numbers
      const balanceRow = 5 + (currentDay * 2) - 2;  // Row for "Previous DueBack"
      const operationsRow = balanceRow + 1;  // Row for "Current DueBack"

      // Calculate totals
      let totalPrevious = 0;
      let totalCurrent = 0;

      duebackEntries.forEach(entry => {
        totalPrevious += -Math.abs(entry.previous);
        totalCurrent += entry.current;
      });

      const columnZNet = totalPrevious + totalCurrent + columnBPrevious;

      // Body - Balance Row (Previous DueBack)
      html += '<tbody>';
      html += `<tr style="background: #fef2f2;">`;
      html += `<td style="padding: 0.75rem; text-align: center; border: 1px solid #d1d5db; font-weight: 700;">${balanceRow}</td>`;
      html += `<td style="padding: 0.75rem; text-align: right; border: 1px solid #d1d5db; background: #fce7f3; font-weight: 700; color: #991b1b;">${formatCurrency(columnBPrevious)}</td>`;

      // Receptionist Previous values
      duebackEntries.forEach(entry => {
        const value = -Math.abs(entry.previous);
        html += `<td style="padding: 0.75rem; text-align: right; border: 1px solid #d1d5db; color: #991b1b; font-weight: 600;">${formatCurrency(value)}</td>`;
      });

      html += `<td style="padding: 0.75rem; text-align: right; border: 1px solid #d1d5db; background: #dbeafe; font-weight: 700; color: #991b1b;">${formatCurrency(totalPrevious)}</td>`;
      html += '</tr>';

      // Body - Operations Row (Current DueBack)
      html += `<tr style="background: #f0fdf4;">`;
      html += `<td style="padding: 0.75rem; text-align: center; border: 1px solid #d1d5db; font-weight: 700;">${operationsRow}</td>`;
      html += `<td style="padding: 0.75rem; text-align: right; border: 1px solid #d1d5db; background: #fce7f3; font-weight: 700; color: #065f46;">$0.00</td>`;

      // Receptionist Current values
      duebackEntries.forEach(entry => {
        html += `<td style="padding: 0.75rem; text-align: right; border: 1px solid #d1d5db; color: #065f46; font-weight: 600;">${formatCurrency(entry.current)}</td>`;
      });

      html += `<td style="padding: 0.75rem; text-align: right; border: 1px solid #d1d5db; background: #dbeafe; font-weight: 700; color: #065f46;">${formatCurrency(totalCurrent)}</td>`;
      html += '</tr>';

      // Formula row (showing Column Z calculation)
      html += `<tr style="background: #f9fafb; border-top: 3px solid #3b82f6;">`;
      html += `<td colspan="${2 + duebackEntries.length}" style="padding: 0.75rem; text-align: right; border: 1px solid #d1d5db; font-size: 0.75rem; color: #6b7280; font-style: italic;">
        Formule Z = SUM(C${balanceRow}:Y${operationsRow}) + B${balanceRow}
      </td>`;

      // Column Z Net
      const netColor = Math.abs(columnZNet) < 0.01 ? '#065f46' : columnZNet < 0 ? '#991b1b' : '#1e3a8a';
      html += `<td style="padding: 0.75rem; text-align: right; border: 1px solid #d1d5db; background: #dbeafe; font-weight: 900; font-size: 1rem; color: ${netColor};">${formatCurrency(columnZNet)}</td>`;
      html += '</tr>';

      html += '</tbody>';
      html += '</table>';

      previewTable.innerHTML = html;
    } else {
      previewContainer.style.display = 'none';
    }
  }

  // Save DueBack data to RJ file
  async function saveDuebackData() {
    if (duebackEntries.length === 0) {
      notify('Aucune entr√©e √† enregistrer', 'error');
      return;
    }

    // Build data object with column mapping
    const data = {};

    duebackEntries.forEach(entry => {
      data[entry.col] = {
        previous: -Math.abs(entry.previous),  // Store as negative
        current: entry.current
      };
    });

    try {
      const res = await fetch('/api/rj/dueback/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await res.json();

      const msgDiv = document.getElementById('dueback-message');
      if (result.success) {
        msgDiv.style.display = 'block';
        msgDiv.style.background = '#d1e7dd';
        msgDiv.style.color = '#0f5132';
        msgDiv.style.padding = '1rem';
        msgDiv.style.borderRadius = '8px';
        msgDiv.style.border = '1px solid #198754';
        msgDiv.innerHTML = `<strong>‚úÖ ${result.message}</strong><br><small>Jour ${result.day} - ${result.filled_count} entr√©es enregistr√©es</small>`;

        // Refresh Column B after save (in case jour sheet was updated)
        fetchDuebackColumnB();
      } else {
        msgDiv.style.display = 'block';
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#842029';
        msgDiv.style.padding = '1rem';
        msgDiv.style.borderRadius = '8px';
        msgDiv.style.border = '1px solid #dc3545';
        msgDiv.innerHTML = `<strong>‚ùå Erreur:</strong> ${result.error}`;
      }

      setTimeout(() => { msgDiv.style.display = 'none'; }, 5000);

    } catch (error) {
      const msgDiv = document.getElementById('dueback-message');
      msgDiv.style.display = 'block';
      msgDiv.style.background = '#f8d7da';
      msgDiv.style.color = '#842029';
      msgDiv.style.padding = '1rem';
      msgDiv.style.borderRadius = '8px';
      msgDiv.innerHTML = `<strong>‚ùå Erreur r√©seau:</strong> ${error.message}`;
    }
  }

  function toggleCheques() {
    const checkbox = document.getElementById('recap-has-cheques');
    const rows = document.querySelectorAll('.recap-cheques-row');
    rows.forEach(row => {
      row.style.display = checkbox.checked ? 'table-row' : 'none';
    });

    if (!checkbox.checked) {
      // Clear BOTH cheque inputs when disabled
      const chequeInput1 = document.querySelector('[data-field="cheque_payment_register_lecture"]');
      const chequeInput2 = document.querySelector('[data-field="cheque_daily_revenu_lecture"]');
      const chequeCorr1 = document.querySelector('[data-field="cheque_payment_register_corr"]');
      const chequeCorr2 = document.querySelector('[data-field="cheque_daily_revenu_corr"]');
      if (chequeInput1) chequeInput1.value = '';
      if (chequeInput2) chequeInput2.value = '';
      if (chequeCorr1) chequeCorr1.value = '';
      if (chequeCorr2) chequeCorr2.value = '';
    }
    calculateRecapBalance();
  }

  function calculateRecapBalance() {
    // Collect all values with proper signs (Lecture + Correction = Net)
    let total = 0;

    // Helper to get lecture + correction
    const getNet = (lectureField, corrField) => {
      const lecture = parseFloat(document.querySelector(`[data-field="${lectureField}"]`)?.value || 0);
      const corr = parseFloat(document.querySelector(`[data-field="${corrField}"]`)?.value || 0);
      return lecture + corr;
    };

    // Comptant (toujours positifs)
    const ls = getNet('comptant_lightspeed_lecture', 'comptant_lightspeed_corr');
    const posi = getNet('comptant_positouch_lecture', 'comptant_positouch_corr');

    total += Math.abs(ls) + Math.abs(posi);

    // Ch√®ques (si activ√©s, toujours positifs)
    const hasCheques = document.getElementById('recap-has-cheques').checked;
    if (hasCheques) {
      const chequePayment = getNet('cheque_payment_register_lecture', 'cheque_payment_register_corr');
      const chequeDailyRev = getNet('cheque_daily_revenu_lecture', 'cheque_daily_revenu_corr');
      total += Math.abs(chequePayment) + Math.abs(chequeDailyRev);
    }

    // Remboursements (toujours n√©gatifs - on entre positif, on convertit en n√©gatif)
    const remb_grat = getNet('remb_gratuite_lecture', 'remb_gratuite_corr');
    const remb_client = getNet('remb_client_lecture', 'remb_client_corr');

    total -= Math.abs(remb_grat) + Math.abs(remb_client);

    // DueBack (toujours positifs)
    const dueback_recep = getNet('due_back_reception_lecture', 'due_back_reception_corr');
    const dueback_nb = getNet('due_back_nb_lecture', 'due_back_nb_corr');

    total += Math.abs(dueback_recep) + Math.abs(dueback_nb);

    // Surplus/D√©ficit (peut √™tre + ou -)
    const surplus = getNet('surplus_deficit_lecture', 'surplus_deficit_corr');

    total += surplus;

    // D√©p√¥t Canadien (positif)
    const depot = getNet('depot_canadien_lecture', 'depot_canadien_corr');
    total += Math.abs(depot);

    // Afficher le balance (both old and new indicators)
    const balanceEl = document.getElementById('recap-balance');
    const statusEl = document.getElementById('recap-balance-status');
    const saveBtn = document.getElementById('recap-save-btn');

    // New balance indicator at top
    const balanceValueEl = document.getElementById('recap-balance-value');
    const balanceMessageEl = document.getElementById('recap-balance-message');
    const balanceIndicator = document.getElementById('recap-balance-indicator');

    const balance = Math.abs(total) < 0.01 ? 0 : total; // Round to 0 if very small

    // Update old balance display
    if (balanceEl) {
      balanceEl.textContent = `$${balance.toFixed(2)}`;
      if (Math.abs(balance) < 0.01) {
        balanceEl.style.color = 'var(--success)';
      } else {
        balanceEl.style.color = '#ef4444';
      }
    }

    // Update new balance indicator at top
    if (balanceValueEl) {
      balanceValueEl.textContent = `$${balance.toFixed(2)}`;
    }

    if (Math.abs(balance) < 0.01) {
      // PERFECT BALANCE - GREEN
      if (balanceIndicator) {
        balanceIndicator.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
        balanceIndicator.style.borderColor = '#28a745';
      }
      if (balanceValueEl) {
        balanceValueEl.style.color = '#155724';
      }
      if (balanceMessageEl) {
        balanceMessageEl.textContent = '‚úÖ RECAP PARFAITEMENT BALANC√â!';
        balanceMessageEl.style.color = '#155724';
      }
      if (statusEl) {
        statusEl.innerHTML = '<span style="color:var(--success);">‚úÖ RECAP balance correctement</span>';
      }
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.style.opacity = '1';
      }
    } else if (Math.abs(balance) < 10) {
      // SMALL VARIANCE - YELLOW
      if (balanceIndicator) {
        balanceIndicator.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%)';
        balanceIndicator.style.borderColor = '#ffc107';
      }
      if (balanceValueEl) {
        balanceValueEl.style.color = '#856404';
      }
      if (balanceMessageEl) {
        balanceMessageEl.textContent = '‚ö†Ô∏è Petite variance - V√©rifiez les montants';
        balanceMessageEl.style.color = '#856404';
      }
      if (statusEl) {
        statusEl.innerHTML = `<span style="color:#ffc107;">‚ö†Ô∏è RECAP ne balance pas. Ajustez les montants pour obtenir $0.00</span>`;
      }
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.style.opacity = '1';
      }
    } else {
      // LARGE VARIANCE - RED
      if (balanceIndicator) {
        balanceIndicator.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f1aeb5 100%)';
        balanceIndicator.style.borderColor = '#dc3545';
      }
      if (balanceValueEl) {
        balanceValueEl.style.color = '#721c24';
      }
      if (balanceMessageEl) {
        balanceMessageEl.textContent = '‚ùå Variance importante - R√©vision requise!';
        balanceMessageEl.style.color = '#721c24';
      }
      if (statusEl) {
        statusEl.innerHTML = `<span style="color:#ef4444;">‚ö†Ô∏è RECAP ne balance pas. Ajustez les montants pour obtenir $0.00</span>`;
      }
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.style.opacity = '1';
      }
    }
  }

  // MACRO BUTTONS - Auto-fill functions
  async function fillDueBackReception() {
    // WR button - Fill Due Back R√©ception from DueBack Column B (jour sheet)
    try {
      // First check if RJ is uploaded
      const statusRes = await fetch('/api/rj/status');
      const status = await statusRes.json();

      if (!status.uploaded) {
        notify('Veuillez charger un fichier RJ d\'abord', 'error');
        return;
      }

      const day = status.current_day;
      if (!day) {
        notify('Impossible de d√©terminer le jour courant', 'error');
        return;
      }

      // Fetch DueBack Column B value
      const res = await fetch(`/api/rj/dueback/column-b?day=${day}`);
      const data = await res.json();

      if (data.success && data.column_b_current !== undefined) {
        // Column B is negative in Excel, we show absolute value in Recap
        const absValue = Math.abs(data.column_b_current);

        // Fill the B16 input
        const input = document.querySelector('[data-cell="B16"]');
        if (input) {
          input.value = absValue.toFixed(2);
          notify(`Due Back R√©ception rempli: ${absValue.toFixed(2)} $`, 'success');

          // Trigger recalculation
          if (typeof recalculateRecap === 'function') {
            recalculateRecap();
          }
        }
      } else {
        notify('Valeur Due Back non trouv√©e pour ce jour', 'error');
      }
    } catch (e) {
      console.error('Error filling DueBack Reception:', e);
      notify('Erreur lors du remplissage automatique', 'error');
    }
  }

  function fillDueBackNB() {
    // WN button - Fill Due Back N/B
    // This comes from a PDF, so we just show a reminder
    notify('Due Back N/B provient du PDF - entrez la valeur manuellement', 'info');

    // Focus the input field for convenience
    const input = document.querySelector('[data-cell="B17"]');
    if (input) {
      input.focus();
      input.select();
    }
  }

  function fillSurplusDeficit() {
    // WS button - Calculate Surplus/D√©ficit automatically
    // Formula from Excel: This is a complex calculation
    // For now, showing what values are being used

    const getNet = (lectureField, corrField) => {
      const lecture = parseFloat(document.querySelector(`[data-field="${lectureField}"]`)?.value || 0);
      const corr = parseFloat(document.querySelector(`[data-field="${corrField}"]`)?.value || 0);
      return lecture + corr;
    };

    // Get Argent Re√ßu (B24) - this would need to be added to the UI
    // For now, we'll calculate based on what we have
    const comptantLS = getNet('comptant_lightspeed_lecture', 'comptant_lightspeed_corr');
    const comptantPosi = getNet('comptant_positouch_lecture', 'comptant_positouch_corr');

    let totalArgentRecu = Math.abs(comptantLS) + Math.abs(comptantPosi);

    // Add cheques if enabled
    const hasCheques = document.getElementById('recap-has-cheques').checked;
    if (hasCheques) {
      const chequePayment = getNet('cheque_payment_register_lecture', 'cheque_payment_register_corr');
      const chequeDailyRev = getNet('cheque_daily_revenu_lecture', 'cheque_daily_revenu_corr');
      totalArgentRecu += Math.abs(chequePayment) + Math.abs(chequeDailyRev);
    }

    // Subtract reimbursements
    const rembGrat = getNet('remb_gratuite_lecture', 'remb_gratuite_corr');
    const rembClient = getNet('remb_client_lecture', 'remb_client_corr');
    totalArgentRecu -= (Math.abs(rembGrat) + Math.abs(rembClient));

    // Subtract DueBack amounts
    const duebackRecep = getNet('due_back_reception_lecture', 'due_back_reception_corr');
    const duebackNB = getNet('due_back_nb_lecture', 'due_back_nb_corr');
    totalArgentRecu -= (Math.abs(duebackRecep) + Math.abs(duebackNB));

    // The surplus/deficit should equal totalArgentRecu - depot
    const depot = getNet('depot_canadien_lecture', 'depot_canadien_corr');
    const surplusDeficit = totalArgentRecu - Math.abs(depot);

    // Fill the field
    const surplusInput = document.querySelector('[data-field="surplus_deficit_lecture"]');
    if (surplusInput) {
      surplusInput.value = surplusDeficit.toFixed(2);
      calculateRecapBalance(); // Recalculate after filling

      // Visual feedback
      alert(`‚úÖ Surplus/D√©ficit calcul√©: $${surplusDeficit.toFixed(2)}\n\nBas√© sur:\n- Argent Re√ßu Total: $${totalArgentRecu.toFixed(2)}\n- D√©p√¥t Canadien: $${depot.toFixed(2)}`);
    }
  }

  // Update SD Balance Indicator (I10)
  function updateSDBalance(i10Value) {
    const sdValueEl = document.getElementById('recap-sd-value');
    const sdMessageEl = document.getElementById('recap-sd-message');
    const sdIndicator = document.getElementById('recap-sd-indicator');

    if (!sdValueEl) return;

    // Parse the value
    const sdBalance = parseFloat(i10Value || 0);

    // Update display
    sdValueEl.textContent = `$${sdBalance.toFixed(2)}`;

    // Visual feedback - I10 should be $0.00 when RJ and SD are in agreement
    if (Math.abs(sdBalance) < 0.01) {
      // PERFECT - GREEN (RJ and SD match!)
      if (sdIndicator) {
        sdIndicator.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
        sdIndicator.style.borderColor = '#28a745';
      }
      if (sdValueEl) {
        sdValueEl.style.color = '#155724';
      }
      if (sdMessageEl) {
        sdMessageEl.textContent = '‚úÖ En accord avec SetD';
        sdMessageEl.style.color = '#155724';
      }
    } else if (Math.abs(sdBalance) < 10) {
      // SMALL VARIANCE - YELLOW
      if (sdIndicator) {
        sdIndicator.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%)';
        sdIndicator.style.borderColor = '#ffc107';
      }
      if (sdValueEl) {
        sdValueEl.style.color = '#856404';
      }
      if (sdMessageEl) {
        sdMessageEl.textContent = '‚ö†Ô∏è Petite variance avec SetD';
        sdMessageEl.style.color = '#856404';
      }
    } else {
      // LARGE VARIANCE - RED (Problem with SD link!)
      if (sdIndicator) {
        sdIndicator.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f1aeb5 100%)';
        sdIndicator.style.borderColor = '#dc3545';
      }
      if (sdValueEl) {
        sdValueEl.style.color = '#721c24';
      }
      if (sdMessageEl) {
        sdMessageEl.textContent = '‚ùå D√©saccord avec SetD - V√©rifier!';
        sdMessageEl.style.color = '#721c24';
      }
    }
  }

  // Setup Excel navigation for Recap table
  function setupExcelNavigation(tableSelector) {
    const table = document.querySelector(tableSelector);
    if (!table) return;
    
    const inputs = Array.from(table.querySelectorAll('.excel-input:not([readonly])'));
    inputs.forEach((input, index) => {
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Tab' || e.key === 'Enter') {
          e.preventDefault();
          const nextIndex = e.shiftKey ? index - 1 : index + 1;
          if (nextIndex >= 0 && nextIndex < inputs.length) {
            inputs[nextIndex].focus();
            inputs[nextIndex].select();
          }
        }
      });
      
      // Recalculate balance on input change for Recap
      if (tableSelector === '#recap-table') {
        input.addEventListener('input', calculateRecapBalance);
        
        // Handle sign conversion for always-positive/always-negative fields
        if (input.dataset.alwaysPositive === 'true') {
          input.addEventListener('input', function() {
            if (this.value < 0) this.value = Math.abs(this.value);
          });
        }
        if (input.dataset.alwaysNegative === 'true') {
          input.addEventListener('input', function() {
            if (this.value < 0) this.value = Math.abs(this.value);
          });
        }
      }
    });
  }
  
  // Initialize Recap table navigation on load
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      setupExcelNavigation('#recap-table');
    }, 100);
  });

  function collectInputs(selector) {
    const data = {};
    document.querySelectorAll(selector).forEach(inp => {
      if (inp.value) {
        let value = parseFloat(inp.value);
        
        // Apply sign rules
        if (inp.dataset.alwaysNegative === 'true') {
          // Convert to negative (user enters positive)
          value = -Math.abs(value);
        } else if (inp.dataset.alwaysPositive === 'true') {
          // Ensure positive
          value = Math.abs(value);
        }
        
        data[inp.dataset.field] = value;
      }
    });
    return data;
  }

  async function saveRecap() {
    // Check if balance is correct
    const balanceEl = document.getElementById('recap-balance');
    const balanceText = balanceEl.textContent.replace('$', '').trim();
    const balance = parseFloat(balanceText);
    
    if (Math.abs(balance) >= 0.01) {
      if (!confirm(`Le RECAP ne balance pas ($${balance.toFixed(2)}). Voulez-vous quand m√™me enregistrer?`)) {
        return;
      }
    }
    
    const data = {};
    
    // Collect from Excel table inputs
    document.querySelectorAll('#recap-table .excel-input').forEach(input => {
      if (!input.value) return;
      
      const field = input.dataset.field;
      if (!field) return;
      
      // Skip cheque if not enabled
      if (field === 'cheque_payment_register_lecture' && !document.getElementById('recap-has-cheques').checked) {
        return;
      }
      
      let value = parseFloat(input.value);
      
      // Apply sign rules based on data attributes
      if (input.dataset.alwaysPositive === 'true') {
        value = Math.abs(value);
      } else if (input.dataset.alwaysNegative === 'true') {
        value = -Math.abs(value);
      }
      // Otherwise keep the sign as entered (for surplus/deficit, depot)
      
      data[field] = value;
    });
    
    if (!Object.keys(data).length) {
      notify('Saisir au moins un montant Recap', 'error');
      return;
    }
    
    try {
      const res = await fetch('/api/rj/fill/recap', { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify(data) 
      });
    const json = await res.json();
      if (json.success) {
        notify(json.message || 'Recap enregistr√© avec succ√®s', 'success');
        calculateRecapBalance(); // Recalculate after save
      } else {
        notify(json.error || 'Erreur Recap', 'error');
      }
    } catch (e) {
      console.error(e);
      notify('Erreur lors de l\'enregistrement', 'error');
    }
  }
  // Mapping des cellules Excel aux champs du mapping
  const TRANSELECT_CELL_MAPPING = {
    'B9': 'bar_701_debit', 'C9': 'bar_702_debit', 'D9': 'bar_703_debit', 'E9': 'spesa_704_debit',
    'B10': 'bar_701_visa', 'C10': 'bar_702_visa', 'D10': 'bar_703_visa', 'E10': 'spesa_704_visa', 'F10': 'room_705_visa',
    'B11': 'bar_701_master', 'C11': 'bar_702_master', 'D11': 'bar_703_master', 'E11': 'spesa_704_master',
    'B13': 'bar_701_amex', 'C13': 'bar_702_amex', 'D13': 'bar_703_amex', 'E13': 'spesa_704_amex',
    'D20': 'reception_debit',
    'B21': 'fusebox_visa', 'D21': 'reception_visa_term',
    'B22': 'fusebox_master', 'D22': 'reception_master_term',
    'B24': 'fusebox_amex', 'D24': 'reception_amex_term',
  };

  function collectTranselectData() {
    const data = {};

    // Collecter depuis les tableaux Transelect (restaurant + reception)
    document.querySelectorAll('#tab-transelect .excel-input').forEach(input => {
      const cell = input.dataset.cell;
      if (!cell || input.readOnly) return;

      const field = TRANSELECT_CELL_MAPPING[cell];
      if (field && input.value) {
        data[field] = parseFloat(input.value);
      }
    });

    return data;
  }

  async function saveTranselect() {
    const data = collectTranselectData();
    
    if (!Object.keys(data).length) {
      notify('Saisir au moins un montant Transelect', 'error');
      return;
    }
    
    try {
      const res = await fetch('/api/rj/fill/transelect', { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify(data) 
      });
    const json = await res.json();
      if (json.success) {
        notify(json.message || 'Transelect enregistr√© avec succ√®s', 'success');
      } else {
        notify(json.error || 'Erreur Transelect', 'error');
      }
    } catch (e) {
      console.error(e);
      notify('Erreur lors de l\'enregistrement', 'error');
    }
  }
  
  // Navigation Excel-like (Tab/Enter)
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      const table = document.getElementById('transelect-table');
      if (table) {
        const inputs = Array.from(table.querySelectorAll('.excel-input:not([readonly])'));
        inputs.forEach((input, index) => {
          input.addEventListener('keydown', function(e) {
            if (e.key === 'Tab' || e.key === 'Enter') {
              e.preventDefault();
              const nextIndex = e.shiftKey ? index - 1 : index + 1;
              if (nextIndex >= 0 && nextIndex < inputs.length) {
                inputs[nextIndex].focus();
                inputs[nextIndex].select();
              }
            }
          });
        });
      }
    }, 100);
  });
  // GEAC cell to field mapping (matches rj_mapper.py GEAC_UX_MAPPING)
  const GEAC_CELL_TO_FIELD = {
    'B6': 'amex_cash_out',
    'E6': 'diners_cash_out',
    'G6': 'master_cash_out',
    'J6': 'visa_cash_out',
    'K6': 'discover_cash_out',
    'B12': 'amex_daily_revenue',
    'E12': 'diners_daily_revenue',
    'G12': 'master_daily_revenue',
    'J12': 'visa_daily_revenue',
    'K12': 'discover_daily_revenue',
    'B32': 'balance_previous',
    'E32': 'balance_previous_guest',
    'B37': 'balance_today',
    'E37': 'balance_today_guest',
    'B41': 'facture_direct',
    'G41': 'facture_direct_guest',
    'B44': 'adv_deposit',
    'J44': 'adv_deposit_applied',
  };

  function collectGeacData() {
    const data = {};
    document.querySelectorAll('#tab-geac .excel-input').forEach(input => {
      const cell = input.dataset.cell;
      if (!cell || input.readOnly || !input.value) return;

      const fieldName = GEAC_CELL_TO_FIELD[cell];
      if (fieldName) {
        data[fieldName] = parseFloat(input.value);
      }
    });
    return data;
  }

  async function saveGeac() {
    const data = collectGeacData();

    if (!Object.keys(data).length) {
      notify('Saisir au moins un montant GEAC', 'error');
      return;
    }

    try {
      const res = await fetch('/api/rj/fill/geac_ux', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      const json = await res.json();
      if (json.success) {
        notify(json.message || 'GEAC enregistr√© avec succ√®s', 'success');
      } else {
        notify(json.error || 'Erreur GEAC', 'error');
      }
    } catch (e) {
      console.error(e);
      notify('Erreur lors de l\'enregistrement GEAC', 'error');
    }
  }

  async function updateDeposit() {
    const amount = parseFloat(document.getElementById('deposit-amount').value);
    if (!amount) return alert('Montant requis');
    const res = await fetch('/api/rj/deposit', { 
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify({ amount }) 
    });
    const data = await res.json();
    if (data.success) notify(data.message || 'D√©p√¥t enregistr√©'); 
    else notify(data.error || 'Erreur d√©p√¥t', 'error');
  }

  // ============================================================================
  // LIVE PREVIEW FUNCTIONALITY - INLINE FOR EACH TAB
  // ============================================================================
  let previewRefreshIntervals = {};

  // Preview configurations for each tab
  const PREVIEW_CONFIGS = {
    'dueback': { sheet: 'DUBACK#', startRow: 0, endRow: 66, startCol: 0, endCol: 22 },
    'recap': { sheet: 'Recap', startRow: 0, endRow: 25, startCol: 0, endCol: 13 },
    'sd': { sheet: 'SD', startRow: 0, endRow: 50, startCol: 0, endCol: 10 },
    'depot': { sheet: 'depot', startRow: 0, endRow: 53, startCol: 0, endCol: 15 },
    'transelect': { sheet: 'transelect', startRow: 0, endRow: 39, startCol: 0, endCol: 31 },
    'geac': { sheet: 'geac_ux', startRow: 0, endRow: 57, startCol: 0, endCol: 10 }
  };

  async function refreshTabPreview(tabId) {
    const config = PREVIEW_CONFIGS[tabId];
    if (!config) return;

    const tableId = `${tabId}-preview-table`;
    const tableEl = document.getElementById(tableId);
    if (!tableEl) return;

    try {
      const response = await fetch(
        `/api/rj/preview?sheet=${encodeURIComponent(config.sheet)}&start_row=${config.startRow}&end_row=${config.endRow}&start_col=${config.startCol}&end_col=${config.endCol}`
      );
      const result = await response.json();

      if (result.success) {
        renderTabPreviewTable(tableId, result.data, config);
      } else {
        tableEl.innerHTML = `<tr><td colspan="100%" style="text-align: center; padding: 2rem; color: red;">Erreur: ${result.error || 'Chargement impossible'}</td></tr>`;
      }
    } catch (e) {
      console.error(`Preview error for ${tabId}:`, e);
      tableEl.innerHTML = `<tr><td colspan="100%" style="text-align: center; padding: 2rem; color: red;">Erreur: ${e.message}</td></tr>`;
    }
  }

  function renderTabPreviewTable(tableId, data, config) {
    const tableEl = document.getElementById(tableId);
    if (!tableEl) return;

    tableEl.innerHTML = '';

    if (!data.rows || data.rows.length === 0) {
      tableEl.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 2rem; color: #999;">Aucune donn√©e √† afficher</td></tr>';
      return;
    }

    // Create header row with column letters
    const headerRow = document.createElement('tr');
    const emptyHeader = document.createElement('th');
    emptyHeader.className = 'excel-row-header';
    emptyHeader.style.cssText = 'background: #2c3e50; color: white; padding: 0.5rem; font-weight: 600; position: sticky; left: 0; z-index: 10;';
    headerRow.appendChild(emptyHeader);

    for (let col = 0; col < data.ncols; col++) {
      const th = document.createElement('th');
      th.className = 'excel-header';
      th.style.cssText = 'background: #4a90e2; color: white; padding: 0.5rem; font-weight: 600; text-align: center; min-width: 80px;';
      th.textContent = colToLetter(config.startCol + col);
      headerRow.appendChild(th);
    }
    tableEl.appendChild(headerRow);

    // Create data rows
    data.rows.forEach((row, rowIndex) => {
      const tr = document.createElement('tr');
      
      // Row number header
      const rowHeader = document.createElement('td');
      rowHeader.className = 'excel-row-header';
      rowHeader.style.cssText = 'background: #f8f9fa; padding: 0.5rem; font-weight: 600; text-align: center; position: sticky; left: 0; z-index: 5; border-right: 2px solid #ddd;';
      rowHeader.textContent = config.startRow + rowIndex + 1;
      tr.appendChild(rowHeader);

      // Data cells
      for (let col = 0; col < data.ncols; col++) {
        const td = document.createElement('td');
        td.style.cssText = 'padding: 0.5rem; border: 1px solid #ddd; background: white;';
        
        const value = row[col];
        if (value !== undefined && value !== null && value !== '') {
          // Format numbers
          if (typeof value === 'number') {
            if (Number.isInteger(value)) {
              td.textContent = value;
            } else {
              td.textContent = value.toFixed(2);
              td.style.textAlign = 'right';
            }
          } else {
            td.textContent = String(value);
          }
          
          // Highlight non-empty cells
          td.style.backgroundColor = '#f9fafb';
        } else {
          td.textContent = '';
        }
        
        tr.appendChild(td);
      }
      
      tableEl.appendChild(tr);
    });
  }

  function colToLetter(colIndex) {
    let result = '';
    while (colIndex >= 0) {
      result = String.fromCharCode(65 + (colIndex % 26)) + result;
      colIndex = Math.floor(colIndex / 26) - 1;
    }
    return result;
  }

  function startTabAutoRefresh(tabId) {
    // Stop any existing interval for this tab
    if (previewRefreshIntervals[tabId]) {
      clearInterval(previewRefreshIntervals[tabId]);
    }
    
    // Start new interval
    previewRefreshIntervals[tabId] = setInterval(() => {
      const tab = document.getElementById(`tab-${tabId}`);
      if (tab && tab.classList.contains('active')) {
        refreshTabPreview(tabId);
      }
    }, 3000); // Refresh every 3 seconds
  }

  function stopTabAutoRefresh(tabId) {
    if (previewRefreshIntervals[tabId]) {
      clearInterval(previewRefreshIntervals[tabId]);
      delete previewRefreshIntervals[tabId];
    }
  }

  // Modify switchRJTab to load previews
  const originalSwitchRJTab = window.switchRJTab;
  window.switchRJTab = function(tabId) {
    originalSwitchRJTab(tabId);
    
    // Stop all auto-refresh
    Object.keys(previewRefreshIntervals).forEach(id => stopTabAutoRefresh(id));
    
    // Load preview for active tab
    if (PREVIEW_CONFIGS[tabId]) {
      refreshTabPreview(tabId);
      startTabAutoRefresh(tabId);
    }
  };

  // ============================================================================
  // SEND RECAP TO RJ (JOUR) FUNCTIONALITY
  // ============================================================================

  async function sendRecapToRJ() {
    const dayInput = document.getElementById('recap-send-day');
    const resultDiv = document.getElementById('send-recap-result');
    const btn = document.getElementById('send-recap-to-rj-btn');

    const day = parseInt(dayInput.value);

    // Validate day
    if (!day || day < 1 || day > 31) {
      showSendRecapResult('error', 'Le jour doit √™tre entre 1 et 31');
      return;
    }

    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = '<i data-feather="loader" style="width: 18px; height: 18px; animation: spin 1s linear infinite;"></i> Envoi...';
    feather.replace();
    showSendRecapResult('info', `Copie des donn√©es du Recap vers le jour ${day}...`);

    try {
      const res = await fetch('/api/rj/recap/send-to-jour', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ day: day })
      });

      const data = await res.json();

      if (data.success) {
        // Show success with details
        let message = `<strong><i data-feather="check-circle"></i> ${data.message}</strong><br>`;
        message += '<div style="margin-top: 0.5rem; font-size: 0.85rem;">';
        message += '<strong>Donn√©es copi√©es:</strong><br>';

        // Show recap data
        const cols = ['H', 'I', 'J', 'K', 'L', 'M', 'N'];
        const colDetails = cols.map(col => {
          const value = data.recap_data[col];
          const formatted = formatCurrency(value);
          return `${col}19: ${formatted}`;
        }).join(', ');

        message += `Recap ‚Üí jour row ${1 + day}: ${colDetails}`;
        message += '</div>';

        showSendRecapResult('success', message);

        // Refresh preview if we have one for Recap
        if (PREVIEW_CONFIGS['tab-recap']) {
          setTimeout(() => refreshTabPreview('tab-recap'), 500);
        }
      } else {
        showSendRecapResult('error', data.error || 'Erreur inconnue');
      }
    } catch (error) {
      showSendRecapResult('error', `Erreur r√©seau: ${error.message}`);
    } finally {
      // Re-enable button
      btn.disabled = false;
      btn.innerHTML = '<i data-feather="send" style="width: 18px; height: 18px;"></i> Envoyer';
      feather.replace();
    }
  }

  function showSendRecapResult(type, message) {
    const resultDiv = document.getElementById('send-recap-result');

    const alertClass = {
      'success': 'alert-success',
      'error': 'alert-danger',
      'info': 'alert-info'
    }[type] || 'alert-info';

    const iconMap = {
      'success': 'check-circle',
      'error': 'alert-circle',
      'info': 'info'
    };

    resultDiv.className = `alert ${alertClass}`;
    resultDiv.style.display = 'block';
    resultDiv.style.padding = '1rem';
    resultDiv.style.borderRadius = '8px';
    resultDiv.innerHTML = message;

    // Replace feather icons in the message
    feather.replace();

    // Auto-hide after 8 seconds for success
    if (type === 'success') {
      setTimeout(() => {
        resultDiv.style.display = 'none';
      }, 8000);
    }
  }

  // CSS for spinner animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);

  document.addEventListener('DOMContentLoaded', () => {
    checkRJStatus();
    feather.replace();

    // Initialize DueBack dropdown
    if (document.getElementById('dueback-receptionist-select')) {
      initializeDuebackDropdown();
    }
  });
</script>

<!-- Recap Calculations Script -->
<script src="/static/js/recap-calculations.js"></script>

{% endblock %}
