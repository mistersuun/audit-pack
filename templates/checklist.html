{% extends "base.html" %}

{% block title %}Checklist{% endblock %}

{% block content %}
<!-- Main Checklist View -->
<div id="checklist-view" class="dashboard-container">
    <div class="page-header">
        <div class="page-title">
            <h1>Dashboard</h1>
            <p>Bienvenue dans votre checklist d'audit de nuit</p>
        </div>
    </div>

    <!-- Getting Started Card with Timeline -->
    <div class="getting-started-card">
        <div class="getting-started-header">
            <div class="getting-started-title">
                <div class="icon">
                    <i data-feather="check-circle"></i>
                </div>
                <h2>Checklist du Quart</h2>
            </div>
            <div class="progress-percentage">
                <span id="progress-percent">0%</span> compl√©t√©
            </div>
        </div>

        <div class="progress-bar-container">
            <div class="progress-bar-fill" id="progress-fill"></div>
        </div>

        <div id="timeline-view" class="timeline">
            <!-- Timeline steps loaded via JavaScript -->
        </div>
    </div>

    <div class="actions">
        <button id="complete-shift-btn" class="btn btn-complete" disabled>
            <i data-feather="check-circle"></i>
            Terminer le quart
        </button>
    </div>
</div>

<!-- Step-by-Step Guide View -->
<div id="guide-view" class="guide-container" style="display: none;">
    <!-- Left Sidebar - Category List -->
    <div class="guide-sidebar">
        <div class="guide-sidebar-title">Checklist Overview</div>
        <div id="guide-category-list" class="guide-task-list">
            <!-- Categories loaded via JS -->
        </div>
    </div>

    <!-- Main Content -->
    <div class="guide-main">
        <div class="guide-header">
            <button class="back-btn" onclick="closeGuide()">
                <i data-feather="arrow-left"></i>
                Retour √† la checklist
            </button>
            <div class="guide-progress-info">
                <span id="guide-system-name"></span>
            </div>
        </div>

        <div class="guide-content">
            <div class="guide-task-title-section">
                <div class="guide-task-icon">
                    <i data-feather="edit-3"></i>
                </div>
                <div class="guide-task-title-info">
                    <h2 id="guide-task-title">Titre de la t√¢che</h2>
                    <span id="guide-status-badge" class="guide-task-status-badge not-completed">
                        Status: Non compl√©t√©
                    </span>
                </div>
            </div>

            <div id="guide-description" class="guide-description-card">
                <h3>Description de la t√¢che</h3>
                <p id="guide-desc-text"></p>
            </div>

            <div id="guide-steps" class="guide-steps">
                <!-- Steps loaded via JS -->
            </div>

            <!-- Document Generator Section -->
            <div id="guide-generator" class="guide-generator" style="display: none;">
                <div class="generator-header">
                    <i data-feather="file-plus"></i>
                    <h3 id="generator-title">G√©n√©rer le document</h3>
                </div>
                <form id="generator-form" onsubmit="handleGenerateDocument(event)">
                    <div id="generator-fields"></div>
                    <button type="submit" class="generator-btn" id="generator-submit-btn">
                        <i data-feather="download"></i>
                        <span id="generator-btn-text">G√©n√©rer et t√©l√©charger</span>
                    </button>
                    <div id="generator-message" class="generator-message"></div>
                </form>
            </div>

            <!-- RJ Automation Section -->
            <div id="guide-automation" class="guide-generator" style="display: none; background-color: #f0f7ff; border: 1px solid #cce5ff;">
                <div class="generator-header" style="color: #004085;">
                    <i data-feather="cpu"></i>
                    <h3 id="automation-title">Automatisation RJ</h3>
                </div>
                <div id="automation-content">
                    <!-- Dynamic content loaded via JS -->
                </div>
                <div id="automation-message" class="generator-message"></div>
            </div>

            <button class="guide-action-btn" id="guide-action-btn" onclick="openSystemLink()">
                <i data-feather="external-link"></i>
                <span id="guide-action-text">Ouvrir le syst√®me</span>
            </button>

            <div id="guide-tips" class="guide-tips" style="display: none;">
                <div class="guide-tips-icon">!</div>
                <p id="guide-tips-text"></p>
            </div>
        </div>

        <div class="guide-footer">
            <button class="complete-task-btn" id="complete-task-btn" onclick="toggleTaskFromGuide()">
                <i data-feather="check"></i>
                <span id="complete-btn-text">Marquer comme compl√©t√©</span>
            </button>
            <button class="next-step-btn" id="next-step-btn" onclick="goToNextStep()">
                <span>√âtape suivante</span>
                <i data-feather="arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Right Sidebar - Resources -->
    <div class="guide-resources">
        <div class="resource-card">
            <div class="resource-card-header">
                <h3>Vid√©o explicative</h3>
            </div>
            <div class="video-placeholder" style="position: relative; background: #f5f5f5; border-radius: 8px; padding: 40px 20px; text-align: center;">
                <div class="video-play-btn" style="opacity: 0.3; margin-bottom: 10px;">
                    <i data-feather="play"></i>
                </div>
                <span class="video-label" style="display: block; color: #999; font-size: 14px;">Tutoriel pas-√†-pas</span>
                <span style="display: block; color: #666; font-size: 12px; margin-top: 5px;">Bient√¥t disponible</span>
            </div>
        </div>

        <div class="resource-card">
            <div class="resource-card-header">
                <h3>Ressources additionnelles</h3>
            </div>
            <div class="resource-links">
                <a href="{{ url_for('checklist.documentation') }}" class="resource-link">
                    <i data-feather="book-open"></i>
                    <span>Documentation & Guides</span>
                    <i data-feather="chevron-right" class="arrow"></i>
                </a>
                <a href="{{ url_for('checklist.faq') }}" class="resource-link">
                    <i data-feather="help-circle"></i>
                    <span>FAQ</span>
                    <i data-feather="chevron-right" class="arrow"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 id="preview-title" style="margin: 0;">Aper√ßu</h3>
            <button onclick="document.getElementById('preview-modal').style.display='none'" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        <div id="preview-content"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const CATEGORIES = {
    'pre_audit': { name: 'Pr√©-Audit', color: '#e91e63', icon: 'clipboard' },
    'part1': { name: 'Pre Audit Reports', color: '#4caf50', icon: 'file-text' },
    'part2': { name: 'Post Audit', color: '#ff9800', icon: 'check-square' },
    'end_shift': { name: 'Fin de quart', color: '#9c27b0', icon: 'log-out' }
};

let tasks = [];
let completions = new Set();
let currentTask = null;

async function loadData() {
    console.log("Starting loadData...");
    try {
        const [tasksRes, shiftRes] = await Promise.all([
            fetch('/api/tasks'),
            fetch('/api/shifts/current')
        ]);

        if (!tasksRes.ok) throw new Error(`Tasks API failed: ${tasksRes.status}`);
        if (!shiftRes.ok) throw new Error(`Shift API failed: ${shiftRes.status}`);

        tasks = await tasksRes.json();
        console.log(`Loaded ${tasks.length} tasks`);
        
        const shiftData = await shiftRes.json();
        console.log("Shift data loaded", shiftData);

        if (shiftData.completions) {
            shiftData.completions.forEach(c => completions.add(c.task_id));
        }

        renderTimeline();
        updateProgress();

        if (!shiftData.shift) {
            console.log("No active shift, creating one...");
            fetch('/api/shifts', { method: 'POST' });
        }

        feather.replace();
    } catch (error) {
        console.error("Error in loadData:", error);
        alert("Erreur lors du chargement de la checklist: " + error.message);
    }
}

function renderTimeline() {
    const container = document.getElementById('timeline-view');
    container.innerHTML = '';

    let currentCategory = null;
    let stepNumber = 1;

    tasks.forEach((task, index) => {
        const isCompleted = completions.has(task.id);
        const hasSteps = task.steps && task.steps.length > 0;
        const isCurrent = !isCompleted && !tasks.slice(0, index).some(t => !completions.has(t.id) && t.category === task.category);

        // Add category header if changed
        if (task.category !== currentCategory) {
            currentCategory = task.category;
            const categoryInfo = CATEGORIES[currentCategory] || { name: currentCategory, color: '#9e9e9e' };

            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'category-header';
            categoryHeader.innerHTML = `
                <div class="category-icon" style="background: ${categoryInfo.color}">
                    <i data-feather="${categoryInfo.icon || 'folder'}"></i>
                </div>
                <span class="category-name">${categoryInfo.name}</span>
                <span class="category-count" id="cat-${currentCategory}-count"></span>
            `;
            container.appendChild(categoryHeader);
        }

        const stepClass = isCompleted ? 'completed' : (isCurrent ? 'current' : '');
        const categoryInfo = CATEGORIES[task.category] || { color: '#9e9e9e' };

        const step = document.createElement('div');
        step.className = `timeline-step ${stepClass}`;
        step.innerHTML = `
            <div class="step-indicator">
                ${isCompleted ? '<i data-feather="check"></i>' : ''}
            </div>
            <div class="step-content">
                <div class="step-label">√âtape ${stepNumber}</div>
                <div class="step-title">${task.title_fr}</div>
                <div class="step-description">
                    ${task.system_used ? task.system_used : ''}
                    ${task.estimated_minutes ? ` ‚Ä¢ ~${task.estimated_minutes} min` : ''}
                </div>
            </div>
            <div class="step-action">
                <input type="checkbox"
                       class="task-quick-check"
                       ${isCompleted ? 'checked' : ''}
                       onclick="event.stopPropagation(); toggleTask(${task.id}, this.checked)"
                       title="Marquer comme ${isCompleted ? 'non compl√©t√©' : 'compl√©t√©'}">
                ${hasSteps ? `
                    <button class="btn-guide"
                            onclick="event.stopPropagation(); openGuide(${task.id})">
                        <i data-feather="book-open"></i>
                        <span>Guide</span>
                    </button>
                ` : ''}
            </div>
        `;

        container.appendChild(step);
        stepNumber++;
    });

    updateCategoryCounts();
    feather.replace();
}

function updateCategoryCounts() {
    const categoryCounts = {};
    tasks.forEach(task => {
        if (!categoryCounts[task.category]) {
            categoryCounts[task.category] = { total: 0, done: 0 };
        }
        categoryCounts[task.category].total++;
        if (completions.has(task.id)) {
            categoryCounts[task.category].done++;
        }
    });

    Object.keys(categoryCounts).forEach(cat => {
        const el = document.getElementById(`cat-${cat}-count`);
        if (el) {
            el.textContent = `${categoryCounts[cat].done}/${categoryCounts[cat].total}`;
        }
    });
}

async function toggleTask(taskId, completed) {
    const endpoint = completed ? 'complete' : 'uncomplete';
    await fetch(`/api/tasks/${taskId}/${endpoint}`, { method: 'POST' });

    if (completed) {
        completions.add(taskId);
    } else {
        completions.delete(taskId);
    }

    renderTimeline();
    updateProgress();
}

function updateProgress() {
    const total = tasks.length;
    const done = completions.size;
    const percent = total > 0 ? Math.round((done / total) * 100) : 0;

    document.getElementById('progress-percent').textContent = `${percent}%`;
    document.getElementById('progress-fill').style.width = `${percent}%`;

    const completeBtn = document.getElementById('complete-shift-btn');
    completeBtn.disabled = done < total;

    if (done === total && total > 0) {
        completeBtn.classList.add('ready');
    } else {
        completeBtn.classList.remove('ready');
    }
}

// ========== GUIDE VIEW ==========

function openGuide(taskId) {
    currentTask = tasks.find(t => t.id === taskId);
    if (!currentTask) return;

    // Update title and status
    document.getElementById('guide-task-title').textContent = currentTask.title_fr;

    const isCompleted = completions.has(currentTask.id);
    const statusBadge = document.getElementById('guide-status-badge');
    statusBadge.className = `guide-task-status-badge ${isCompleted ? 'completed' : 'not-completed'}`;
    statusBadge.textContent = `Status: ${isCompleted ? 'Compl√©t√©' : 'Non compl√©t√©'}`;

    // Update description
    const descSection = document.getElementById('guide-description');
    const descText = document.getElementById('guide-desc-text');
    if (currentTask.description_fr) {
        descText.textContent = currentTask.description_fr;
        descSection.style.display = 'block';
    } else {
        descSection.style.display = 'none';
    }

    // Update steps
    const stepsContainer = document.getElementById('guide-steps');
    stepsContainer.innerHTML = '';

    if (currentTask.steps && currentTask.steps.length > 0) {
        currentTask.steps.forEach((stepText, index) => {
            const step = document.createElement('div');
            step.className = 'guide-step';
            step.innerHTML = `
                <div class="guide-step-number">${index + 1}</div>
                <div class="guide-step-text">${stepText}</div>
            `;
            stepsContainer.appendChild(step);
        });
    }

    // Update system name in header
    const systemName = document.getElementById('guide-system-name');
    if (currentTask.system_used) {
        systemName.textContent = currentTask.system_used;
    } else {
        systemName.textContent = '';
    }

    // Update action button (only if a link is configured)
    const actionBtn = document.getElementById('guide-action-btn');
    const actionText = document.getElementById('guide-action-text');
    if (currentTask.system_link) {
        actionText.textContent = `Ouvrir ${currentTask.system_used || 'le lien'}`;
        actionBtn.dataset.link = currentTask.system_link;
        actionBtn.style.display = 'flex';
    } else {
        actionBtn.dataset.link = '';
        actionBtn.style.display = 'none';
    }

    // Update tips
    const tipsSection = document.getElementById('guide-tips');
    const tipsText = document.getElementById('guide-tips-text');
    if (currentTask.tips_fr) {
        tipsText.textContent = currentTask.tips_fr;
        tipsSection.style.display = 'flex';
    } else {
        tipsSection.style.display = 'none';
    }

    // Update complete button
    updateCompleteButton();

    // Render category sidebar
    renderGuideSidebar();

    // Show document generator if applicable
    showGenerator(currentTask.order);

    // Show automation tools if applicable
    showAutomation(currentTask.order);

    // Update next step button
    const nextStepBtn = document.getElementById('next-step-btn');
    // Sort tasks by order to ensure correct sequence
    const sortedTasks = [...tasks].sort((a, b) => a.order - b.order);
    const currentIndex = sortedTasks.findIndex(t => t.id === currentTask.id);
    const isLastTask = currentIndex >= 0 && currentIndex === sortedTasks.length - 1;

    if (isLastTask) {
        nextStepBtn.disabled = true;
        nextStepBtn.querySelector('span').textContent = 'Derni√®re √©tape';
    } else {
        nextStepBtn.disabled = false;
        nextStepBtn.querySelector('span').textContent = '√âtape suivante';
    }

    // Switch views
    document.getElementById('checklist-view').style.display = 'none';
    document.getElementById('guide-view').style.display = 'grid';
    window.scrollTo(0, 0);

    feather.replace();
}

function renderGuideSidebar() {
    const container = document.getElementById('guide-category-list');
    container.innerHTML = '';

    const categoryCounts = {};
    tasks.forEach(task => {
        if (!categoryCounts[task.category]) {
            categoryCounts[task.category] = { total: 0, done: 0, tasks: [] };
        }
        categoryCounts[task.category].total++;
        categoryCounts[task.category].tasks.push(task);
        if (completions.has(task.id)) {
            categoryCounts[task.category].done++;
        }
    });

    Object.keys(CATEGORIES).forEach(catKey => {
        if (!categoryCounts[catKey]) return;

        const cat = categoryCounts[catKey];
        const info = CATEGORIES[catKey];
        const isComplete = cat.done === cat.total;
        const isActive = currentTask && currentTask.category === catKey;

        const item = document.createElement('div');
        item.className = `guide-task-item ${isComplete ? 'completed' : ''} ${isActive ? 'active' : ''}`;
        item.innerHTML = `
            <div class="guide-task-status ${isComplete ? 'completed' : 'pending'}">
                ${isComplete ? '<i data-feather="check"></i>' : '<span class="status-count">' + cat.done + '</span>'}
            </div>
            <div class="guide-task-info">
                <div class="guide-task-name">${info.name}</div>
                <div class="guide-task-progress">${cat.done} / ${cat.total} Compl√©t√©</div>
            </div>
        `;
        container.appendChild(item);
    });

    feather.replace();
}

function updateCompleteButton() {
    const btn = document.getElementById('complete-task-btn');
    const btnText = document.getElementById('complete-btn-text');
    const isCompleted = completions.has(currentTask.id);

    if (isCompleted) {
        btn.classList.add('completed');
        btnText.textContent = 'Marquer comme non compl√©t√©';
    } else {
        btn.classList.remove('completed');
        btnText.textContent = 'Marquer comme compl√©t√©';
    }
}

function closeGuide() {
    document.getElementById('guide-view').style.display = 'none';
    document.getElementById('checklist-view').style.display = 'block';
    currentTask = null;
}

function goToNextStep() {
    if (!currentTask) return;

    // Sort tasks by order to ensure correct sequence
    const sortedTasks = [...tasks].sort((a, b) => a.order - b.order);
    
    // Find the current task index in sorted array
    const currentIndex = sortedTasks.findIndex(t => t.id === currentTask.id);

    // Check if there's a next task
    if (currentIndex >= 0 && currentIndex < sortedTasks.length - 1) {
        const nextTask = sortedTasks[currentIndex + 1];
        openGuide(nextTask);
    } else {
        // Last task - disable the button or show message
        const nextStepBtn = document.getElementById('next-step-btn');
        nextStepBtn.disabled = true;
        nextStepBtn.querySelector('span').textContent = 'Derni√®re √©tape';
    }
}

async function toggleTaskFromGuide() {
    if (!currentTask) return;
    const isCompleted = completions.has(currentTask.id);
    await toggleTask(currentTask.id, !isCompleted);

    // Update guide view
    const statusBadge = document.getElementById('guide-status-badge');
    const newStatus = completions.has(currentTask.id);
    statusBadge.className = `guide-task-status-badge ${newStatus ? 'completed' : 'not-completed'}`;
    statusBadge.textContent = `Status: ${newStatus ? 'Compl√©t√©' : 'Non compl√©t√©'}`;

    updateCompleteButton();
    renderGuideSidebar();
}

function openSystemLink() {
    if (!currentTask || !currentTask.system_link) {
        alert('Aucun lien configur√© pour cette t√¢che.');
        return;
    }
    window.open(currentTask.system_link, '_blank', 'noopener');
}

// RJ Automation Functions
function showAutomation(taskOrder) {
    const section = document.getElementById('guide-automation');
    const content = document.getElementById('automation-content');
    const messageDiv = document.getElementById('automation-message');
    
    // Clear previous state
    content.innerHTML = '';
    messageDiv.style.display = 'none';
    section.style.display = 'none';

    // Only show RJ automations for Back Office role
    if (!currentTask || currentTask.role !== 'back') {
        return;
    }

    // Define automations for tasks
    const automations = {
        1: { // Mise en place (Start)
            title: 'Initialisation du RJ',
            html: `
                <div style="background: #e8f0fe; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-top:0; color: #004085;">üìÇ Fichier RJ</h4>
                    <p style="margin-bottom: 10px; font-size: 0.9em;">Veuillez t√©l√©verser le fichier RJ du jour (Rj-DATE.xls) pour activer les fonctions d'automatisation.</p>
                    
                    <div id="rj-upload-area">
                        <input type="file" id="rj-file-input" accept=".xls,.xlsx" style="display: block; margin-bottom: 10px; width: 100%;">
                        <button class="generator-btn" onclick="uploadRJFile()" style="width: 100%;">
                            <i data-feather="upload"></i> T√©l√©verser le fichier
                        </button>
                    </div>
                    
                    <div id="rj-file-info" style="display: none; margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px;">
                        <div style="display: flex; align-items: center; gap: 10px; color: #28a745; font-weight: 500;">
                            <i data-feather="check-circle"></i>
                            <span id="rj-status-text">Fichier charg√©</span>
                        </div>
                        <button class="generator-btn" onclick="document.getElementById('rj-upload-area').style.display='block'; this.parentElement.style.display='none';" style="margin-top: 10px; background: #f8f9fa; color: #666; border: 1px solid #ddd; font-size: 0.8em; padding: 5px;">
                            Remplacer le fichier
                        </button>
                    </div>
                    
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                        <a href="/api/rj/download" class="generator-btn" style="background: #28a745; text-align: center; text-decoration: none; display: block;">
                            <i data-feather="download"></i> T√©l√©charger le RJ actuel
                        </a>
                        <p style="font-size: 0.8em; color: #666; margin-top: 5px; text-align: center;">
                            T√©l√©chargez r√©guli√®rement pour sauvegarder votre travail.
                        </p>
                    </div>
                </div>

                <div id="rj-actions-area" style="opacity: 0.5; pointer-events: none;">
                    <p>Une fois le fichier charg√©, effacez les onglets pour la nouvelle journ√©e.</p>
                    <button class="generator-btn" onclick="runRJAutomation('/api/rj/reset')">
                        <i data-feather="trash-2"></i> Effacer les onglets (Reset)
                    </button>
                </div>
            `
        },
        3: { // Due Back / SetD
            title: 'Synchronisation DueBack',
            html: `
                <p>Transf√©rer automatiquement les montants du DueBack vers l'onglet SetD.</p>
                <div class="generator-field">
                    <label>Jour du mois (Laissez vide pour auto):</label>
                    <input type="number" id="rj-day-input" placeholder="ex: 19" style="width: 80px;">
                </div>
                <button class="generator-btn" onclick="runSyncDueBack()">
                    <i data-feather="refresh-cw"></i> Synchroniser DUBACK -> SetD
                </button>
            `
        },
        8: { // Recap
            title: 'Saisie Recap (Comptant)',
            html: `
                <p>Saisir les montants pour l'onglet Recap.</p>
                <div class="generator-field">
                    <label>Comptant LightSpeed ($):</label>
                    <input type="number" step="0.01" class="recap-input" data-field="comptant_lightspeed_lecture">
                </div>
                <div class="generator-field">
                    <label>Comptant POSitouch ($):</label>
                    <input type="number" step="0.01" class="recap-input" data-field="comptant_positouch_lecture">
                </div>
                <div class="generator-field">
                    <label>Ch√®ques ($):</label>
                    <input type="number" step="0.01" class="recap-input" data-field="cheque_payment_register_lecture">
                </div>
                <div class="generator-field">
                    <label>D√©p√¥t Canadien ($):</label>
                    <input type="number" step="0.01" class="recap-input" data-field="depot_canadien_lecture">
                </div>
                <button class="generator-btn" onclick="runSaveRecap()">
                    <i data-feather="save"></i> Enregistrer Recap
                </button>
                <button class="generator-btn" onclick="showPreview('recap')" style="background: #17a2b8; margin-top: 5px;">
                    <i data-feather="eye"></i> Visualiser
                </button>
            `
        },
        9: { // D√©p√¥t
            title: 'Mise √† jour du D√©p√¥t',
            html: `
                <p>Inscrire le montant v√©rifi√© dans l'onglet D√©p√¥t.</p>
                <div class="generator-field">
                    <label>Montant V√©rifi√© ($):</label>
                    <input type="number" step="0.01" id="rj-deposit-amount" placeholder="0.00">
                </div>
                <button class="generator-btn" onclick="runUpdateDeposit()">
                    <i data-feather="save"></i> Enregistrer le D√©p√¥t
                </button>
            `
        },
        10: { // Transelect
            title: 'Saisie Transelect',
            html: `
                <p>Saisir les montants pour l'onglet Transelect.</p>
                
                <div class="transelect-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <div style="font-weight: bold;">Type</div>
                    <div style="font-weight: bold;">BAR 701</div>
                    <div style="font-weight: bold;">BAR 702</div>
                    <div style="font-weight: bold;">SPESA 704</div>
                    
                    <div>DEBIT</div>
                    <input type="number" step="0.01" class="ts-input" data-field="bar_701_debit">
                    <input type="number" step="0.01" class="ts-input" data-field="bar_702_debit">
                    <input type="number" step="0.01" class="ts-input" data-field="spesa_704_debit">
                    
                    <div>VISA</div>
                    <input type="number" step="0.01" class="ts-input" data-field="bar_701_visa">
                    <input type="number" step="0.01" class="ts-input" data-field="bar_702_visa">
                    <input type="number" step="0.01" class="ts-input" data-field="spesa_704_visa">
                    
                    <div>MASTER</div>
                    <input type="number" step="0.01" class="ts-input" data-field="bar_701_master">
                    <input type="number" step="0.01" class="ts-input" data-field="bar_702_master">
                    <input type="number" step="0.01" class="ts-input" data-field="spesa_704_master">
                    
                    <div>AMEX</div>
                    <input type="number" step="0.01" class="ts-input" data-field="bar_701_amex">
                    <input type="number" step="0.01" class="ts-input" data-field="bar_702_amex">
                    <input type="number" step="0.01" class="ts-input" data-field="spesa_704_amex">
                </div>
                
                <hr style="margin: 15px 0; border: 0; border-top: 1px solid #ddd;">
                
                <div class="transelect-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <div style="font-weight: bold;">Type</div>
                    <div style="font-weight: bold;">R√©ception (Term)</div>
                    <div style="font-weight: bold;">FuseBoxe (Bank)</div>
                    
                    <div>DEBIT</div>
                    <input type="number" step="0.01" class="ts-input" data-field="reception_debit">
                    <input disabled style="background: #eee;">
                    
                    <div>VISA</div>
                    <input type="number" step="0.01" class="ts-input" data-field="reception_visa_term">
                    <input type="number" step="0.01" class="ts-input" data-field="fusebox_visa">
                    
                    <div>MASTER</div>
                    <input type="number" step="0.01" class="ts-input" data-field="reception_master_term">
                    <input type="number" step="0.01" class="ts-input" data-field="fusebox_master">
                    
                    <div>AMEX</div>
                    <input type="number" step="0.01" class="ts-input" data-field="reception_amex_term">
                    <input type="number" step="0.01" class="ts-input" data-field="fusebox_amex">
                </div>

                <button class="generator-btn" onclick="runSaveTranselect()">
                    <i data-feather="save"></i> Enregistrer Transelect
                </button>
                <button class="generator-btn" onclick="showPreview('transelect')" style="background: #17a2b8; margin-top: 5px;">
                    <i data-feather="eye"></i> Visualiser
                </button>
            `
        },
        13: { // GEAC/UX
            title: 'Saisie GEAC/UX',
            html: `
                <p>Saisir les montants pour l'onglet GEAC/UX.</p>
                <div class="transelect-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <div style="font-weight: bold;">Type</div>
                    <div style="font-weight: bold;">Daily Cash Out</div>
                    <div style="font-weight: bold;">Daily Revenue</div>
                    
                    <div>VISA</div>
                    <input type="number" step="0.01" class="geac-input" data-field="visa_cash_out">
                    <input type="number" step="0.01" class="geac-input" data-field="visa_daily_revenue">
                    
                    <div>MASTER</div>
                    <input type="number" step="0.01" class="geac-input" data-field="master_cash_out">
                    <input type="number" step="0.01" class="geac-input" data-field="master_daily_revenue">
                    
                    <div>AMEX</div>
                    <input type="number" step="0.01" class="geac-input" data-field="amex_cash_out">
                    <input type="number" step="0.01" class="geac-input" data-field="amex_daily_revenue">
                </div>
                <button class="generator-btn" onclick="runSaveGeac()">
                    <i data-feather="save"></i> Enregistrer GEAC
                </button>
                <button class="generator-btn" onclick="showPreview('geac_ux')" style="background: #17a2b8; margin-top: 5px;">
                    <i data-feather="eye"></i> Visualiser
                </button>
            `
        }
    };

    if (automations[taskOrder]) {
        document.getElementById('automation-title').textContent = automations[taskOrder].title;
        content.innerHTML = automations[taskOrder].html;
        section.style.display = 'block';
        feather.replace();
        
        // Special check for Task 1
        if (taskOrder === 1) {
            checkRJStatus();
        }
    } else {
        section.style.display = 'none';
    }
}

async function checkRJStatus() {
    try {
        const response = await fetch('/api/rj/status');
        const data = await response.json();
        
        const uploadArea = document.getElementById('rj-upload-area');
        const fileInfo = document.getElementById('rj-file-info');
        const actionsArea = document.getElementById('rj-actions-area');
        
        if (data.uploaded) {
            if(uploadArea) uploadArea.style.display = 'none';
            if(fileInfo) {
                fileInfo.style.display = 'block';
                document.getElementById('rj-status-text').textContent = `Fichier charg√© (${(data.file_size/1024).toFixed(1)} KB)`;
            }
            if(actionsArea) {
                actionsArea.style.opacity = '1';
                actionsArea.style.pointerEvents = 'auto';
            }
        }
    } catch (e) {
        console.error('Error checking RJ status:', e);
    }
}

async function uploadRJFile() {
    const fileInput = document.getElementById('rj-file-input');
    const file = fileInput.files[0];
    
    if (!file) {
        alert("Veuillez s√©lectionner un fichier.");
        return;
    }
    
    const formData = new FormData();
    formData.append('rj_file', file);
    
    const btn = document.querySelector('#rj-upload-area button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i data-feather="loader"></i> T√©l√©versement...';
    feather.replace();
    
    try {
        const response = await fetch('/api/rj/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            checkRJStatus(); // Refresh UI
        } else {
            alert("Erreur: " + result.error);
        }
    } catch (e) {
        alert("Erreur de t√©l√©versement");
        console.error(e);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
        feather.replace();
    }
}

async function runSaveTranselect() {
    const inputs = document.querySelectorAll('.ts-input');
    const data = {};
    
    inputs.forEach(input => {
        if (input.value) {
            data[input.dataset.field] = parseFloat(input.value);
        }
    });
    
    if (Object.keys(data).length === 0) {
        alert("Veuillez saisir au moins un montant.");
        return;
    }
    
    runRJAutomation('/api/rj/fill/transelect', data);
}

async function runSaveRecap() {
    const inputs = document.querySelectorAll('.recap-input');
    const data = {};
    inputs.forEach(input => {
        if (input.value) data[input.dataset.field] = parseFloat(input.value);
    });
    runRJAutomation('/api/rj/fill/recap', data);
}

async function runSaveGeac() {
    const inputs = document.querySelectorAll('.geac-input');
    const data = {};
    inputs.forEach(input => {
        if (input.value) data[input.dataset.field] = parseFloat(input.value);
    });
    runRJAutomation('/api/rj/fill/geac_ux', data);
}

async function runRJAutomation(endpoint, data = {}) {
    const messageDiv = document.getElementById('automation-message');
    const btn = document.querySelector('#automation-content button');
    
    if(btn) {
        btn.disabled = true;
        btn.innerHTML = '<i data-feather="loader"></i> Traitement...';
        feather.replace();
    }

    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            messageDiv.className = 'generator-message success';
            messageDiv.textContent = '‚úì ' + result.message;
            messageDiv.style.display = 'block';
        } else {
            throw new Error(result.error || 'Erreur inconnue');
        }
    } catch (error) {
        messageDiv.className = 'generator-message error';
        messageDiv.textContent = '‚úó ' + error.message;
        messageDiv.style.display = 'block';
    } finally {
        if(btn) {
            btn.disabled = false;
            // Restore icon based on button text context (simplified)
            if (endpoint.includes('reset')) btn.innerHTML = '<i data-feather="trash-2"></i> Effacer les onglets (Reset)';
            else if (endpoint.includes('sync')) btn.innerHTML = '<i data-feather="refresh-cw"></i> Synchroniser DUBACK -> SetD';
            else btn.innerHTML = '<i data-feather="save"></i> Enregistrer';
            feather.replace();
        }
        setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
    }
}

function runSyncDueBack() {
    const dayInput = document.getElementById('rj-day-input');
    const day = dayInput.value ? parseInt(dayInput.value) : null;
    runRJAutomation('/api/rj/sync', { day: day });
}

function runUpdateDeposit() {
    const amountInput = document.getElementById('rj-deposit-amount');
    const amount = amountInput.value ? parseFloat(amountInput.value) : null;
    
    if (!amount) {
        alert("Veuillez entrer un montant valide.");
        return;
    }
    
    runRJAutomation('/api/rj/deposit', { amount: amount });
}

async function showPreview(sheetName) {
    const modal = document.getElementById('preview-modal');
    const content = document.getElementById('preview-content');
    const title = document.getElementById('preview-title');
    
    content.innerHTML = '<div style="text-align: center; padding: 20px;"><i data-feather="loader"></i> Chargement...</div>';
    title.textContent = `Aper√ßu: ${sheetName}`;
    modal.style.display = 'flex';
    feather.replace();
    
    try {
        const response = await fetch(`/api/rj/read/${sheetName}`);
        const result = await response.json();
        
        if (result.success) {
            renderPreviewTable(result.data);
        } else {
            content.innerHTML = `<div style="color: red;">Erreur: ${result.error}</div>`;
        }
    } catch (e) {
        content.innerHTML = `<div style="color: red;">Erreur de chargement: ${e.message}</div>`;
    }
}

function renderPreviewTable(data) {
    const content = document.getElementById('preview-content');
    let html = '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
    
    for (const [key, value] of Object.entries(data)) {
        if (value !== null && typeof value === 'object' && !Array.isArray(value)) {
             continue; 
        }
        
        html += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 8px; font-weight: 500; color: #555;">${formatKey(key)}</td>
                <td style="padding: 8px; text-align: right;">${formatValue(value)}</td>
            </tr>
        `;
    }
    html += '</table>';
    content.innerHTML = html;
}

function formatKey(key) {
    return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatValue(val) {
    if (val === null || val === undefined) return '-';
    if (typeof val === 'number') return val.toFixed(2);
    return val;
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (document.getElementById('guide-view').style.display === 'grid') {
            closeGuide();
        }
        if (document.getElementById('preview-modal').style.display === 'flex') {
            document.getElementById('preview-modal').style.display = 'none';
        }
    }
});

document.getElementById('complete-shift-btn').addEventListener('click', async () => {
    if (confirm('√ätes-vous s√ªr de vouloir terminer le quart?')) {
        await fetch('/api/shifts/complete', { method: 'POST' });
        alert('Quart termin√© avec succ√®s!');
    }
});

// Document Generator Functions
function showGenerator(taskOrder) {
    const generatorSection = document.getElementById('guide-generator');
    const fieldsContainer = document.getElementById('generator-fields');
    const today = new Date().toISOString().split('T')[0];

    // Define generators for specific tasks
    const generators = {
        6: { // S√©parateur Dat√©
            endpoint: '/api/generators/separateur-date',
            autoDate: true,
            fields: `
                <input type="hidden" name="date" value="${today}">
                <p class="generator-auto-info">üìÖ Document g√©n√©r√© automatiquement avec la date d'aujourd'hui</p>
            `
        },
        7: { // Checklist Tourn√©e
            endpoint: '/api/generators/checklist-tournee',
            autoDate: true,
            fields: `
                <input type="hidden" name="date" value="${today}">
                <p class="generator-auto-info">üìÖ Document g√©n√©r√© automatiquement avec la date d'aujourd'hui</p>
            `
        },
        8: { // Entretien Hiver
            endpoint: '/api/generators/entretien-hiver',
            autoDate: true,
            fields: `
                <input type="hidden" name="date" value="${today}">
                <p class="generator-auto-info">üìÖ Document g√©n√©r√© automatiquement avec la date d'aujourd'hui. Vous pourrez ajouter la capture m√©t√©o manuellement apr√®s.</p>
            `
        },
        19: { // Cl√©s Banquets
            endpoint: '/api/generators/cles-banquets',
            fields: `
                <div class="generator-field">
                    <label>Date:</label>
                    <input type="date" name="date" value="${today}" required>
                </div>
                <div id="banquet-events" class="banquet-events">
                    <div class="banquet-event">
                        <div class="generator-field">
                            <label>Salon:</label>
                            <input type="text" name="salon-0" placeholder="ex: Aut-Vimont" required>
                        </div>
                        <div class="generator-field">
                            <label>Compagnie:</label>
                            <input type="text" name="compagnie-0" placeholder="ex: SAPUTO" required>
                        </div>
                        <div class="generator-field">
                            <label>Heure:</label>
                            <input type="text" name="heure-0" placeholder="ex: 08:00-13:00" required>
                        </div>
                        <div class="generator-field">
                            <label>Responsable:</label>
                            <input type="text" name="responsable-0" placeholder="ex: JOANNA K." required>
                        </div>
                    </div>
                </div>
                <button type="button" class="add-event-btn" onclick="addBanquetEvent(event)">+ Ajouter un √©v√©nement</button>
            `
        }
    };

    if (generators[taskOrder]) {
        const generator = generators[taskOrder];
        fieldsContainer.innerHTML = generator.fields;
        fieldsContainer.dataset.endpoint = generator.endpoint;

        // Update button text and title based on whether it's auto-date
        const btnText = document.getElementById('generator-btn-text');
        const title = document.getElementById('generator-title');
        if (generator.autoDate) {
            btnText.textContent = 'T√©l√©charger le document';
            title.textContent = 'Document pr√™t √† t√©l√©charger';
        } else {
            btnText.textContent = 'G√©n√©rer et t√©l√©charger';
            title.textContent = 'G√©n√©rer le document';
        }

        generatorSection.style.display = 'block';
        feather.replace();
    } else {
        generatorSection.style.display = 'none';
    }
}

let banquetEventCounter = 1;
function addBanquetEvent(e) {
    e.preventDefault();
    const container = document.getElementById('banquet-events');
    const eventId = banquetEventCounter++;
    const eventDiv = document.createElement('div');
    eventDiv.className = 'banquet-event';
    eventDiv.innerHTML = `
        <div class="generator-field">
            <label>Salon:</label>
            <input type="text" name="salon-${eventId}" placeholder="ex: Aut-Vimont" required>
        </div>
        <div class="generator-field">
            <label>Compagnie:</label>
            <input type="text" name="compagnie-${eventId}" placeholder="ex: SAPUTO" required>
        </div>
        <div class="generator-field">
            <label>Heure:</label>
            <input type="text" name="heure-${eventId}" placeholder="ex: 08:00-13:00" required>
        </div>
        <div class="generator-field">
            <label>Responsable:</label>
            <input type="text" name="responsable-${eventId}" placeholder="ex: JOANNA K." required>
        </div>
        <button type="button" class="remove-event-btn" onclick="this.parentElement.remove()">Supprimer</button>
    `;
    container.appendChild(eventDiv);
}

async function handleGenerateDocument(e) {
    e.preventDefault();
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const messageDiv = document.getElementById('generator-message');
    const endpoint = document.getElementById('generator-fields').dataset.endpoint;

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i data-feather="loader"></i> G√©n√©ration...';
    feather.replace();

    try {
        const formData = new FormData(form);
        let data = { date: formData.get('date') };

        // Special handling for banquet events
        if (endpoint.includes('cles-banquets')) {
            data.events = [];
            let eventId = 0;
            while (formData.get(`salon-${eventId}`) !== null) {
                data.events.push({
                    salon: formData.get(`salon-${eventId}`),
                    compagnie: formData.get(`compagnie-${eventId}`),
                    heure: formData.get(`heure-${eventId}`),
                    responsable: formData.get(`responsable-${eventId}`)
                });
                eventId++;
            }
        }

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = response.headers.get('Content-Disposition').split('filename=')[1].replace(/"/g, '');
            document.body.appendChild(a);
            a.click();
            a.remove();

            messageDiv.className = 'generator-message success';
            messageDiv.textContent = '‚úì Document g√©n√©r√© avec succ√®s!';
            messageDiv.style.display = 'block';
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Erreur lors de la g√©n√©ration');
        }
    } catch (error) {
        messageDiv.className = 'generator-message error';
        messageDiv.textContent = '‚úó ' + error.message;
        messageDiv.style.display = 'block';
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i data-feather="download"></i> G√©n√©rer et t√©l√©charger';
        feather.replace();
        setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
    }
}

loadData();
</script>
{% endblock %}
