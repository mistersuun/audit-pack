# AR Summary PDF Parser - Sheraton Laval Night Audit

## Overview

This parser extracts structured data from the AR Summary report (arsum) generated by the GEAC/UX PMS system at Sheraton Laval. The report is a single-page PDF containing nightly audit reconciliation data.

## Installation

```bash
pip install pdfplumber
```

## Usage

```python
from utils.parsers import ParserFactory

# Read the PDF file
with open('AR_SUMMARY_DOCUMENT.pdf', 'rb') as f:
    pdf_bytes = f.read()

# Create parser using factory
parser = ParserFactory.create('ar_summary', pdf_bytes, filename='AR_SUMMARY_DOCUMENT.pdf')
result = parser.get_result()

# Access extracted data
data = result['data']
print(f"Previous Balance: ${data['ar_balance_previous']:,.2f}")
print(f"End of Day Balance: ${data['ar_balance_end_of_day']:,.2f}")
print(f"Balanced: {data['balanced']}")
```

## Extracted Data Structure

The parser returns the following structure:

```python
{
    'report_date': 'Wednesday February 04, 2026',
    'auditor': 'Souleymane Camara',
    'report_generated': '06-FEB-2026 03:45 AM',
    
    'ar_balance_previous': 22194423.95,
    
    'front_office_transfers': {
        'guest_folios': 4064.49,
        'non_guest_folios': 0.00,
        'subtotal': 4064.49,
        'advance_deposits_cancel_dna': 0.00,
        'credit_cards': 0.00,
        'total': 4064.49
    },
    
    'adjustments': {
        'credits': 0.00,
        'debits': 0.00,
        'total': 0.00
    },
    
    'invoices': 0.00,
    'payments': 0.00,
    'ar_credit_card_charges': 0.00,
    'service_charges': 0.00,
    
    'ar_balance_end_of_day': 22198488.44,
    
    'balanced': True,  # Validates: previous + transfers + adjustments + invoices + payments + cc_charges + service = eod
    
    'rj_mapping': {
        'geac_ux': {
            'ar_previous_balance': 22194423.95,
            'ar_end_of_day': 22198488.44,
            'ar_transfers': 4064.49,
        }
    }
}
```

## Key Features

1. **PDF Text Normalization**: Handles reversed/mirrored PDF text by reversing each line
2. **Flexible Pattern Matching**: Accounts for special characters and spacing variations between label keywords
3. **Balance Validation**: Automatically validates that the accounting equation holds (with 0.01 tolerance for rounding)
4. **RJ Auto-Fill Mapping**: Pre-computes cell references for Recap Journal auto-fill
5. **Confidence Scoring**: 95% confidence when balanced, 70% when unbalanced

## PDF Structure

The AR Summary PDF has an unusual text layout where values appear BEFORE their labels:

```
22,194,423.95 Day Previous - Balance Ledger A/R  [not: A/R Ledger Balance Previous Day 22,194,423.95]
4,064.49 Folios Guest                              [not: Guest Folios 4,064.49]
```

The parser accounts for this structure by:
1. Finding the label keywords in the normalized text
2. Looking backward to find the most recent numeric value before the label
3. Using a 80-character search window by default (with 200-character fallback)

## Implementation Details

### File Location
`/sessions/laughing-sharp-johnson/mnt/audit-pack/utils/parsers/ar_summary_parser.py`

### Class
`ARSummaryParser` - Extends `BaseParser`

### Key Methods

- `parse()`: Main extraction method
- `validate()`: Validates extracted data and balance equation
- `_find_value_by_label_sequence()`: Locates numeric values before label keywords
- `_extract_*()`: Individual field extraction methods
- `_validate_balance()`: Checks accounting equation

## Testing

Run the test suite:

```bash
cd /sessions/laughing-sharp-johnson/mnt/audit-pack
python3 test_ar_summary_parser.py
```

Expected output: **OVERALL TEST RESULT: âœ“ PASS**

All values match expected outputs:
- ar_balance_previous: $22,194,423.95
- front_office_transfers_total: $4,064.49
- ar_balance_end_of_day: $22,198,488.44
- Balance equation validates successfully

## Field Mappings (RJ Auto-Fill)

The parser maps extracted values to Recap Journal cells for auto-fill:

| Field | Cell | Value |
|-------|------|-------|
| ar_previous_balance | B6 | 22,194,423.95 |
| ar_end_of_day | B7 | 22,198,488.44 |
| ar_transfers | B8 | 4,064.49 |

Access via: `result['data']['rj_mapping']['geac_ux']`

## Error Handling

- Returns 0.0 for any value that cannot be extracted
- Stores error messages in `validation_errors` (critical issues)
- Stores warnings in `validation_warnings` (non-critical issues)
- Confidence score reflects parsing success
